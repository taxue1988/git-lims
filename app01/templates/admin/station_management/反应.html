{% extends 'admin/station_management.html' %}

{% block title %}反应 - 工站管理{% endblock %}

{% block modals %}
<!-- 查看任务 Modal -->
<div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">查看任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Task details will be loaded here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 指令发送模态框 -->
<div class="modal fade" id="sendCommandModal" tabindex="-1" aria-labelledby="sendCommandModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendCommandModalLabel">发送指令 - 任务ID: <span id="modal-task-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="targetClientId">目标客户端ID (设备ID)</label>
                    <input type="text" class="form-control" id="targetClientId" value="reaction_station_1">
                </div>
                <div class="form-group mt-3">
                    <label for="messageContent">指令内容 (JSON格式)</label>
                    <textarea class="form-control" id="messageContent" rows="15"></textarea>
                </div>
                <div id="commandResult" class="alert alert-info d-none mt-3" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="sendCommandBtn"><i class="fas fa-paper-plane me-2"></i>发送指令</button>
            </div>
        </div>
    </div>
</div>

<!-- 放置转移仓模态框 -->
<div class="modal fade" id="placeContainerModal" tabindex="-1" aria-labelledby="placeContainerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="placeContainerModalLabel">选择一个转移仓放置到 <span id="position-name-in-modal"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="available-containers-list" class="list-group">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">正在加载...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block main_content %}
{{ block.super }}

<style>
    .card-header-collapsible { cursor: pointer; user-select: none; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; transition: background-color .3s ease; }
    .status-online { background-color:#28a745; box-shadow:0 0 8px rgba(40,167,69,.7); }
    .status-offline { background-color:#dc3545; }
    .status-unknown { background-color:#6c757d; }
    .station-card{ overflow:hidden; }
    .station-card .current-container-info{ overflow:hidden; }
    .station-card .current-container-info .alert{ display:flex; align-items:center; gap:.5rem; overflow:hidden; }
    .station-card .current-container-info .badge{ max-width:70%; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }
    .container-name-clip { flex:1 1 auto; min-width:0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:inline-block; }
    @media (min-width: 1200px) { .station-card .current-container-info .badge{ max-width:80%; } }
</style>

<!-- 工站状态 -->
<div class="card mt-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center card-header-collapsible" data-bs-toggle="collapse" data-bs-target="#stationStatusContent" aria-expanded="true" aria-controls="stationStatusContent">
        <h4 class="mb-0"><i class="fas fa-cogs"></i> 工站状态</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="stationStatusContent">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="p-3 border rounded h-100">
                    <div class="fw-semibold mb-1">机械臂</div>
                    <div id="arm-status-text" class="text-muted small"><span id="arm-status-dot" class="status-dot status-unknown"></span>正在连接...</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="p-3 border rounded h-100">
                    <div class="fw-semibold mb-1">导轨</div>
                    <div id="rail-status-text" class="text-muted small"><span id="rail-status-dot" class="status-dot status-unknown"></span>正在连接...</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="p-3 border rounded h-100">
                    <div class="fw-semibold mb-1">过滤器</div>
                    <div id="filter-status-text" class="text-muted small"><span id="filter-status-dot" class="status-dot status-unknown"></span>正在连接...</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="p-3 border rounded h-100">
                    <div class="fw-semibold mb-1">运行与统计</div>
                    <div class="text-muted small">运行时间：<span id="uptime-text">--:--:--</span></div>
                    <div class="text-muted small">正在反应数：<span id="reacting-count">0</span></div>
                    <div class="text-muted small">反应结束数：<span id="reacted-count">0</span></div>
                    <div class="text-muted small">待监测任务数：<span id="monitor-pending">0</span></div>
                    <div class="text-muted small">已完成监测任务数：<span id="monitor-done">0</span></div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- 转移仓位置（12个） -->
<div class="card mt-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center card-header-collapsible" data-bs-toggle="collapse" data-bs-target="#transferPositions" aria-expanded="true" aria-controls="transferPositions">
        <h4 class="mb-0"><i class="fas fa-boxes"></i> 当前仓位（12）</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="transferPositions">
    <div class="card-body">
        <div class="row">
            {% for num in "123456"|make_list %}
            <div class="col-lg-2 col-md-2 col-sm-4 mb-3">
                <div class="card h-100 station-card border-light">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">位置 {{ forloop.counter }}</h5>
                        <p class="card-text text-muted small">转移仓</p>
                        <div class="current-container-info mb-3">
                            <div class="alert alert-light py-2 mb-2">
                                <i class="fas fa-circle text-secondary"></i>
                                <span class="text-muted">位置空闲</span>
                            </div>
                        </div>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm place-transfer-bin-btn">
                                <i class="fas fa-plus"></i> 放置转移仓
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="row mt-1">
            {% for num in "123456"|make_list %}
            <div class="col-lg-2 col-md-2 col-sm-4 mb-3">
                <div class="card h-100 station-card border-light">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">位置 {{ forloop.counter|add:6 }}</h5>
                        <p class="card-text text-muted small">转移仓</p>
                        <div class="current-container-info mb-3">
                            <div class="alert alert-light py-2 mb-2">
                                <i class="fas fa-circle text-secondary"></i>
                                <span class="text-muted">位置空闲</span>
                            </div>
                        </div>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm place-transfer-bin-btn">
                                <i class="fas fa-plus"></i> 放置转移仓
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    </div>
</div>

<!-- 磁搅设备（20台，每台12孔位） -->
<div class="card mt-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center card-header-collapsible" data-bs-toggle="collapse" data-bs-target="#stirrers" aria-expanded="true" aria-controls="stirrers">
        <h4 class="mb-0"><i class="fas fa-fan"></i> 磁搅设备（20）</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="stirrers">
    <div class="card-body">
        <div class="row">
            {% for _ in "12345678901234567890"|make_list %}
            <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
                <div class="card h-100 stirrer-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h5 class="card-title mb-0">磁搅 #{{ forloop.counter }}</h5>
                            <span class="badge bg-light text-muted">只读</span>
                        </div>
                        <div class="mb-2 small text-muted">
                            当前温度：<span class="text-dark fw-semibold">--</span> °C
                            <span class="mx-2">|</span>
                            搅拌速度：<span class="text-dark fw-semibold">--</span> rpm
                        </div>
                        <div class="tube-grid">
                            {% for __ in "123456789012"|make_list %}
                            <button type="button" class="tube-hole" disabled title="孔位 {{ forloop.counter }}"></button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    </div>
</div>

<!-- 待检测任务列表 -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center card-header-collapsible" data-bs-toggle="collapse" data-bs-target="#pendingDetectTasks" aria-expanded="true" aria-controls="pendingDetectTasks">
        <h4 class="mb-0"><i class="fas fa-clipboard-list"></i> 待检测任务列表</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="pendingDetectTasks">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 140px;">实验任务ID</th>
                        <th>实验名称</th>
                        <th style="width: 120px;">试管ID</th>
                        <th style="width: 120px;">磁搅孔位</th>
                        <th style="width: 180px;">创建时间</th>
                        <th style="width: 140px;">操作</th>
                    </tr>
                </thead>
                <tbody id="reaction-pending-detect-body">
                    <tr><td colspan="6" class="text-center">正在加载...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- WebSocket 逻辑：设备状态 ---
    const armStatusDot = document.getElementById('arm-status-dot');
    const armStatusText = document.getElementById('arm-status-text');
    const railStatusDot = document.getElementById('rail-status-dot');
    const railStatusText = document.getElementById('rail-status-text');
    const filterStatusDot = document.getElementById('filter-status-dot');
    const filterStatusText = document.getElementById('filter-status-text');

    const webClientId = 'web_client';
    const wsScheme = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';
    const socketUrl = wsScheme + window.location.host + '/ws/test/' + webClientId + '/';
    const stationSocket = new WebSocket(socketUrl);

    stationSocket.onopen = function() {
        try { stationSocket.send(JSON.stringify({ type: 'get_status' })); } catch(e) {}
    };
    stationSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'device_status') {
                updateDeviceStatus('arm', data.status.arm);
                updateDeviceStatus('rail', data.status.rail);
                updateDeviceStatus('filter', data.status.filter);
            }
        } catch (err) { console.warn(err); }
    };
    stationSocket.onclose = function(){
        updateDeviceStatus('arm', false, true);
        updateDeviceStatus('rail', false, true);
        updateDeviceStatus('filter', false, true);
    };

    function updateDeviceStatus(device, isOnline, isSocketClosed = false) {
        let dot, text;
        if (device === 'arm') { dot = armStatusDot; text = armStatusText; }
        else if (device === 'rail') { dot = railStatusDot; text = railStatusText; }
        else if (device === 'filter') { dot = filterStatusDot; text = filterStatusText; }
        if (!dot || !text) return;
        dot.classList.remove('status-online','status-offline','status-unknown');
        if (isSocketClosed) {
            dot.classList.add('status-offline');
            text.innerHTML = '<span class="status-dot status-offline"></span>连接中断';
        } else if (isOnline) {
            dot.classList.add('status-online');
            text.innerHTML = '<span class="status-dot status-online"></span>连接正常';
        } else {
            dot.classList.add('status-offline');
            text.innerHTML = '<span class="status-dot status-offline"></span>连接断开';
        }
    }

    // --- 放置/移除转移仓逻辑（与固液配料一致的接口） ---
    let placeContainerModal;
    try { placeContainerModal = new bootstrap.Modal(document.getElementById('placeContainerModal')); }
    catch(e){ placeContainerModal = { show: ()=>alert('Bootstrap 未就绪'), hide: ()=>{} }; }

    const availableContainersList = document.getElementById('available-containers-list');
    const positionNameInModal = document.getElementById('position-name-in-modal');
    let currentPositionId = null;
    let currentCardElement = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function refreshCurrentPositions() {
        fetch('/api/reaction-station/current-containers/')
            .then(r=>r.json())
            .then(data => {
                if (!data.success) return;
                const map = {};
                (data.containers || []).forEach(c => { map[c.position_id] = c; });
                document.querySelectorAll('.station-card').forEach(card => {
                    const title = card.querySelector('.card-title')?.textContent?.trim() || '';
                    const posNum = (title.split(' ')[1] || '').trim();
                    const posId = posNum ? `reaction_${posNum}` : '';
                    const info = card.querySelector('.current-container-info');
                    if (posId && map[posId]) {
                        const c = map[posId];
                        if (info) {
                            info.innerHTML = `
                                <div class="alert alert-light py-2 mb-2 d-flex align-items-center">
                                    <i class="fas fa-circle text-success me-2"></i>
                                    <span>位置占用：</span>
                                    <span class="badge bg-success ms-2"><span class="container-name-clip" title="${c.name || '未命名转移仓'}">${c.name || '未命名转移仓'}</span></span>
                                </div>
                            `;
                        }
                        card.dataset.containerId = String(c.id);
                        const btnGroup = card.querySelector('.btn-group-vertical');
                        if (btnGroup) {
                            btnGroup.innerHTML = `
                                <button type="button" class="btn btn-outline-danger btn-sm remove-transfer-bin-btn">
                                    <i class="fas fa-times"></i> 移除转移仓
                                </button>`;
                        }
                    } else if (info) {
                        info.innerHTML = `
                            <div class="alert alert-light py-2 mb-2">
                                <i class="fas fa-circle text-secondary"></i>
                                <span class="text-muted">位置空闲</span>
                            </div>`;
                        const btnGroup = card.querySelector('.btn-group-vertical');
                        if (btnGroup) {
                            btnGroup.innerHTML = `
                                <button type="button" class="btn btn-outline-primary btn-sm place-transfer-bin-btn">
                                    <i class="fas fa-plus"></i> 放置转移仓
                                </button>`;
                        }
                    }
                });
            })
            .catch(err => console.error('加载当前占用失败:', err));
    }

    function placeContainer(containerId, positionId, containerName) {
        fetch('/api/reaction-station/place-container/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ container_id: containerId, position_id: positionId })
        })
        .then(r=>r.json())
        .then(data => {
            if (data.status === 'success' || data.success === true) {
                placeContainerModal.hide();
                if (currentCardElement) {
                    const info = currentCardElement.querySelector('.current-container-info');
                    const showName = (data && (data.container_name || (data.container && data.container.name))) || containerName || '';
                    if (info) info.innerHTML = `
                        <div class="alert alert-light py-2 mb-2 d-flex align-items-center">
                            <i class="fas fa-circle text-success me-2"></i>
                            <span>位置占用：</span>
                            <span class="badge bg-success ms-2">${showName || '未命名转移仓'}</span>
                        </div>`;
                    currentCardElement.dataset.containerId = String(containerId);
                    const btnGroup = currentCardElement.querySelector('.btn-group-vertical');
                    if (btnGroup) btnGroup.innerHTML = `
                        <button type="button" class="btn btn-outline-danger btn-sm remove-transfer-bin-btn">
                            <i class="fas fa-times"></i> 移除转移仓
                        </button>`;
                }
            } else {
                alert('放置失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(err => { console.error(err); alert('放置时发生错误'); });
    }

    function removeContainer(positionId, cardElement) {
        const containerId = cardElement?.dataset?.containerId;
        if (!containerId) { alert('无法确定要移除的转移仓ID'); return; }
        fetch('/api/reaction-station/remove-container/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ container_id: containerId })
        })
        .then(r=>r.json())
        .then(data => {
            if (data.status === 'success' || data.success === true) {
                const info = cardElement.querySelector('.current-container-info');
                if (info) info.innerHTML = `
                    <div class="alert alert-light py-2 mb-2">
                        <i class="fas fa-circle text-secondary"></i>
                        <span class="text-muted">位置空闲</span>
                    </div>`;
                delete cardElement.dataset.containerId;
                const btnGroup = cardElement.querySelector('.btn-group-vertical');
                if (btnGroup) btnGroup.innerHTML = `
                    <button type="button" class="btn btn-outline-primary btn-sm place-transfer-bin-btn">
                        <i class="fas fa-plus"></i> 放置转移仓
                    </button>`;
            } else {
                alert('移除失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(err => { console.error(err); alert('移除时发生错误'); });
    }

    document.addEventListener('click', function(event){
        const placeBtn = event.target.closest('.place-transfer-bin-btn');
        const removeBtn = event.target.closest('.remove-transfer-bin-btn');
        if (placeBtn) {
            const card = placeBtn.closest('.station-card');
            currentCardElement = card;
            const positionTitle = card.querySelector('.card-title').textContent.trim();
            const positionNumber = positionTitle.split(' ')[1];
            currentPositionId = `reaction_${positionNumber}`;
            positionNameInModal.textContent = positionTitle;
            availableContainersList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">正在加载...</span></div></div>';
            placeContainerModal.show();
            fetch('/api/batching-station/available-containers/')
                .then(r=>r.json())
                .then(data => {
                    availableContainersList.innerHTML = '';
                    const containers = Array.isArray(data) ? data : (data.containers || []);
                    if (containers.length) {
                        containers.forEach(container => {
                            const a = document.createElement('a');
                            a.href = '#';
                            a.className = 'list-group-item list-group-item-action';
                            a.textContent = container.name;
                            a.dataset.containerId = container.id;
                            a.addEventListener('click', function(e){ e.preventDefault(); placeContainer(container.id, currentPositionId, container.name); });
                            availableContainersList.appendChild(a);
                        });
                    } else {
                        availableContainersList.innerHTML = '<p class="text-center text-muted">没有可用的转移仓。</p>';
                    }
                })
                .catch(()=>{ availableContainersList.innerHTML = '<p class="text-center text-danger">加载失败，请重试。</p>'; });
        } else if (removeBtn) {
            const card = removeBtn.closest('.station-card');
            const positionTitle = card.querySelector('.card-title').textContent.trim();
            const positionNumber = positionTitle.split(' ')[1];
            const positionId = `reaction_${positionNumber}`;
            if (confirm(`确定要从 ${positionTitle} 移除转移仓吗？`)) {
                removeContainer(positionId, card);
            }
        }
    });

    // 初始刷新占用
    refreshCurrentPositions();

    // ===== 待检测任务列表：加载 + 操作（查看/发送） =====
    const tableBody = document.getElementById('reaction-pending-detect-body');

    function fetchJSON(url){ return fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }); }

    function loadReactionTasks(){
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">正在加载...</td></tr>';
        const tryUrls = [ '/api/filter-tasks/?status=approved', '/api/filter-tasks/?status=已通过' ];
        const tryFetch = (idx)=>{
            if (idx >= tryUrls.length) { tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败</td></tr>'; return; }
            fetchJSON(tryUrls[idx]).then(res => {
                const ok = res && (res.ok === true || res.success === true);
                const tasks = ok ? (res.tasks || []) : (res.results || res.data || []);
                const rows = [];
                (tasks||[]).forEach(task => {
                    const status = task.status || '';
                    const isApproved = (status === 'approved' || status === '已通过' || status === 'Approved');
                    if (!isApproved) return;
                    rows.push(`
                        <tr>
                            <td>${task.id}</td>
                            <td>${task.name || '-'}</td>
                            <td>${task.tube_id || '-'}</td>
                            <td>${task.stir_hole || '-'}</td>
                            <td>${task.created_at || task.date || '-'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-info view-task-btn" data-task-id="${task.id}"><i class="fas fa-eye"></i> 查看</button>
                                    <button type="button" class="btn btn-primary send-command-modal-btn" data-task-id="${task.id}">发送指令</button>
                                </div>
                            </td>
                        </tr>`);
                });
                tableBody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="6" class="text-center">暂无待检测的任务</td></tr>';
            }).catch(()=>tryFetch(idx+1));
        };
        tryFetch(0);
    }

    loadReactionTasks();

    // 任务详情查看（复用固液配料的生成逻辑子集）
    function generateTaskSummaryHtml(task) {
        const stations = task.stations || {};
        const react = stations.reaction || {};
        const rp = react.params || {};
        const reactionHtml = react.enabled ? `
            <ul class="list-group mb-3">
                <li class="list-group-item">反应温度：${rp.temperature ?? '-'} °C</li>
                <li class="list-group-item">搅拌速度：${rp.stirringSpeed ?? '-'} rpm</li>
                <li class="list-group-item">反应时长：${rp.duration ?? '-'} min</li>
                <li class="list-group-item">采样间隔：${rp.samplingInterval ?? '-'} min</li>
                <li class="list-group-item">采样体积：${rp.samplingVolume ?? '-'} μL</li>
                <li class="list-group-item">淬灭剂：${rp.quenchingAgent ?? '-'}</li>
                <li class="list-group-item">淬灭剂体积：${rp.quenchingAgentVolume ?? '-'} μL</li>
                <li class="list-group-item">采样分析方式：${rp.samplingAnalysis ?? '-'}</li>
            </ul>` : '';
        const createdAt = task.created_at || task.date || '';
        return `
            <div class="mb-3"><strong>实验名称：</strong>${task.name || '-'}</div>
            <div class="mb-3"><strong>提交时间：</strong>${createdAt}</div>
            <div class="mb-3"><strong>状态：</strong>${task.status || '-'}</div>
            <div class="mb-3"><strong>反应工站：</strong>${react.enabled ? '已启用' : '未启用'}</div>
            ${reactionHtml}`;
    }

    function viewTask(taskId) {
        const modalBody = document.querySelector('#viewTaskModal .modal-body');
        if (modalBody) modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">正在加载...</span></div><p class="mt-2">正在获取任务详情...</p></div>';
        const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'));
        modal.show();
        fetch(`/api/task/${taskId}/`).then(async (r)=>{
            let data={}; try{ data = await r.json(); }catch(e){}
            if (r.ok && data && data.ok) {
                if (modalBody) modalBody.innerHTML = generateTaskSummaryHtml(data.task || {});
                return;
            }
            return fetch(`/api/user/task/${taskId}/`).then(async (r2)=>{
                let d2={}; try{ d2 = await r2.json(); }catch(e){}
                if (r2.ok && d2 && d2.ok) {
                    if (modalBody) modalBody.innerHTML = generateTaskSummaryHtml(d2.task || {});
                } else {
                    if (modalBody) modalBody.innerHTML = '<div class="alert alert-danger">获取任务详情失败</div>';
                }
            });
        }).catch(()=>{ if (modalBody) modalBody.innerHTML = '<div class="alert alert-danger">网络异常</div>'; });
    }

    document.addEventListener('click', function(e){
        const viewBtn = e.target.closest('.view-task-btn');
        if (viewBtn) {
            const taskId = viewBtn.getAttribute('data-task-id');
            if (taskId) viewTask(taskId);
        }
    });

    // 发送指令弹窗 + 通过 WebSocket 发送
    let sendCommandModal;
    try { sendCommandModal = new bootstrap.Modal(document.getElementById('sendCommandModal')); }
    catch(e){ sendCommandModal = { show: ()=>alert('Bootstrap 未就绪'), hide: ()=>{} }; }
    const modalTaskId = document.getElementById('modal-task-id');
    const messageContentTextArea = document.getElementById('messageContent');
    const sendCommandBtn = document.getElementById('sendCommandBtn');
    const commandResult = document.getElementById('commandResult');

    document.addEventListener('click', function(e){
        const sendBtn = e.target.closest('.send-command-modal-btn');
        if (sendBtn) {
            const taskId = sendBtn.getAttribute('data-task-id');
            modalTaskId.textContent = taskId;
            // 默认反应工站的一条示例指令载荷（可按需替换）
            const defaultPayload = {
                command: 'reaction_start',
                payload: { task_id: taskId }
            };
            try { messageContentTextArea.value = JSON.stringify(defaultPayload, null, 2); } catch(e) {}
            if (sendCommandModal && sendCommandModal.show) sendCommandModal.show();
        }
    });

    sendCommandBtn.addEventListener('click', function(){
        const originalButtonHTML = sendCommandBtn.innerHTML;
        sendCommandBtn.disabled = true;
        sendCommandBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在发送...';
        const targetId = document.getElementById('targetClientId').value.trim();
        const messageContent = messageContentTextArea.value.trim();
        const restore = ()=>{ sendCommandBtn.disabled = false; sendCommandBtn.innerHTML = originalButtonHTML; };
        if (!targetId || !messageContent) { alert('目标客户端ID和指令内容不能为空！'); restore(); return; }
        let messagePayload; try { messagePayload = JSON.parse(messageContent); } catch(e){ alert('指令内容不是有效的JSON格式！'); restore(); return; }
        const command = { command: 'send_to_client', target_client_id: targetId, message: messagePayload };
        if (stationSocket.readyState === WebSocket.OPEN) {
            stationSocket.send(JSON.stringify(command));
            commandResult.classList.remove('d-none','alert-danger');
            commandResult.classList.add('alert-success');
            commandResult.textContent = `已向服务器发送指令，目标: ${targetId}`;
        } else {
            commandResult.classList.remove('d-none','alert-success');
            commandResult.classList.add('alert-danger');
            commandResult.textContent = '错误: WebSocket 连接未打开。';
        }
        setTimeout(()=>{ commandResult.classList.add('d-none'); restore(); }, 3000);
    });

    // 折叠箭头旋转
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(header){
        header.addEventListener('click', function(){
            var icon = this.querySelector('.collapse-icon');
            var target = document.querySelector(this.getAttribute('data-bs-target'));
            setTimeout(function(){
                if (target && target.classList.contains('show')) { if (icon) icon.style.transform = 'rotate(0deg)'; }
                else { if (icon) icon.style.transform = 'rotate(180deg)'; }
            }, 50);
        });
    });
});
</script>
<style>
.station-card { transition: all .3s ease; border-width: 2px; }
.station-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,.1); }
.station-card.border-light { border-color: #dee2e6 !important; }
.current-container-info .alert { margin-bottom: .5rem; }

.stirrer-card { transition: all .2s ease; }
.stirrer-card:hover { box-shadow: 0 6px 16px rgba(0,0,0,.08); }
.tube-grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 8px; margin-top: 8px; }
.tube-hole { width: 100%; padding-top: 100%; position: relative; border-radius: 50%; border: 2px dashed #ced4da; background: #f8f9fa; cursor: not-allowed; }
.tube-hole::after { content: ''; position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; border-radius: 50%; background: #adb5bd; transform: translate(-50%, -50%); }
.collapse-icon { transition: transform .3s ease; }
</style>
{% endblock %}
