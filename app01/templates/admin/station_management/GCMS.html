{% extends 'admin/station_management.html' %}

{% block title %}GCMS - 工站管理{% endblock %}

{% block main_content %}
{{ block.super }}

<!-- 工站状态卡片 -->
<div class="card mb-4" id="gcmsStatusCard">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsStationStatus"
         aria-expanded="true" aria-controls="gcmsStationStatus" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-chart-line"></i> 工站状态</h4>
        <div class="d-flex align-items-center">
            <span class="badge bg-light text-dark me-2">实时监控</span>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsStationStatus">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="armStatusIcon" class="fas fa-hand-rock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">机械臂</h6>
                            <p id="armStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="gcmsStatusIcon" class="fas fa-vial text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">GCMS</h6>
                            <p id="gcmsStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-cogs text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行模式</h6>
                            <p id="gcmsRunMode" class="mb-0 fw-bold text-secondary">未知</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-info-circle text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行状态</h6>
                            <p id="gcmsRunStatus" class="mb-0 fw-bold text-secondary">未知</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-clock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行时间</h6>
                            <p class="mb-0 fw-bold"><span id="runtimeHours">0</span> 小时 <span id="runtimeMinutes">00</span> 分</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tasks text-info me-2"></i>
                            <span class="text-muted">待分析任务数</span>
                        </div>
                        <span class="badge bg-info" id="pendingAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span class="text-muted">已完成分析</span>
                        </div>
                        <span class="badge bg-success" id="completedAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i id="connectionStatusIcon" class="fas fa-wifi text-danger me-2"></i>
                            <span class="text-muted">连接状态</span>
                        </div>
                        <span class="badge bg-danger" id="connectionStatus">离线</span>
                    </div>
                </div>
            </div>
            
            <!-- 控制按钮区域 -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button id="refreshStatusBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i>刷新状态
                        </button>

                        <button id="getInstrumentInfoBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-info-circle me-1"></i>仪器信息
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志卡片 -->
<div class="card mt-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsLogs"
         aria-expanded="true" aria-controls="gcmsLogs" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-terminal"></i> 实时日志</h4>
        <div class="d-flex align-items-center">
            <button id="clearLogsBtn" class="btn btn-outline-light btn-sm me-2" onclick="event.stopPropagation();">
                <i class="fas fa-trash"></i> 清空
            </button>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsLogs">
        <div class="card-body p-0">
            <div id="logContainer" class="log-container" style="height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">
                <div class="log-entry text-info">
                    <span class="timestamp">[系统]</span> 等待连接到 GCMS Worker...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 当前仓位卡片 -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsPositions"
         aria-expanded="true" aria-controls="gcmsPositions" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-boxes"></i> 当前仓位（1）</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="gcmsPositions">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100 position-card border-light" id="position-1-card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary">仓位 1</h5>
                            <p class="card-text text-muted small">GCMS 工站</p>
                            <div class="position-status">
                                <div id="position-1-status-alert" class="alert alert-light py-2 mb-0">
                                    <i id="position-1-status-icon" class="fas fa-circle text-success"></i>
                                    <span id="position-1-status-text" class="text-muted">位置空闲</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GCMS 分析任务列表卡片 -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsTasks"
         aria-expanded="true" aria-controls="gcmsTasks" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-tasks"></i> GCMS 分析任务列表</h4>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                <i class="fas fa-plus-circle me-1"></i> 创建分析任务
            </button>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="viewSequenceBtn" data-bs-toggle="modal" data-bs-target="#sequenceListModal">
                <i class="fas fa-list-ul me-1"></i> 查看序列清单
            </button>
            <i class="fas fa-chevron-down collapse-icon ms-3"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsTasks">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tasksTable">
                    <thead class="table-light">
                        <tr>
                            <th>任务ID</th>
                            <th>实验名称</th>
                            <th>样品瓶号</th>
                            <th>序列号</th>
                            <th>序列文件</th>
                            <th>创建时间</th>
                            <th>状态</th>
                            <th>任务用时</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="no-tasks-row">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                暂无任务，请点击右上角创建
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 创建任务 Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">创建新的分析任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="experimentName" class="form-label">实验名称</label>
                        <input type="text" class="form-control" id="experimentName" placeholder="例如：样品批次A-01" required>
                    </div>
                    <div class="mb-3">
                        <label for="bottleNum" class="form-label">样品瓶号 (0-33)</label>
                        <input type="number" class="form-control" id="bottleNum" min="0" max="33" required>
                    </div>
                    <div class="mb-3">
                        <label for="sequenceIndex" class="form-label">序列号 (参见序列清单编号)</label>
                        <input type="number" class="form-control" id="sequenceIndex" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">创建任务</button>
            </div>
        </div>
    </div>
</div>

<!-- 序列清单 Modal -->
<div class="modal fade" id="sequenceListModal" tabindex="-1" aria-labelledby="sequenceListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sequenceListModalLabel">序列清单（只读）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th style="width: 120px;">序号</th>
                                <th>序列文件名</th>
                            </tr>
                        </thead>
                        <tbody id="sequenceTableBody">
                            <tr>
                                <td colspan="2" class="text-muted">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看结果 Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header position-relative">
                <h5 class="modal-title" id="resultModalLabel">分析结果</h5>
                <div class="position-absolute start-50 translate-middle-x d-flex gap-2 align-items-center">
                    <button type="button" class="btn btn-primary btn-sm" id="downloadPngBtn">
                        <i class="fas fa-download"></i> 导出 PNG
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="resultLoading" class="text-muted">正在加载数据，请稍候...</div>
                <canvas id="resultChart" style="width:100%; height:420px; display:none;"></canvas>
                <div id="resultMessage" class="alert alert-warning mt-2" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
    </div>


{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 全局变量定义 ---
    let totalRuntimeInterval = null;
    let tasks = []; // 任务的中心化状态管理
    let taskIdCounter = 0;
    let isWorkerBusy = false;
    let isPositionManuallyOccupied = false;

    // --- DOM 元素获取 ---

    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const createTaskForm = document.getElementById('createTaskForm');
    const tasksTableBody = document.querySelector('#tasksTable tbody');
    const noTasksRow = document.getElementById('no-tasks-row');
    const createTaskModalEl = document.getElementById('createTaskModal');
    const createTaskModal = new bootstrap.Modal(createTaskModalEl);
    const pos1Card = document.getElementById('position-1-card');
    const pos1Alert = document.getElementById('position-1-status-alert');
    const pos1Icon = document.getElementById('position-1-status-icon');
    const pos1Text = document.getElementById('position-1-status-text');

    const logContainer = document.getElementById('logContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionStatusIcon = document.getElementById('connectionStatusIcon');
    const armStatus = document.getElementById('armStatus');
    const gcmsStatus = document.getElementById('gcmsStatus');
    const gcmsRunMode = document.getElementById('gcmsRunMode');
    const gcmsRunStatus = document.getElementById('gcmsRunStatus');
    // 本地缓存序列映射：index->name
    let sequenceMap = {};

    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry text-${type}`;
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    const socket = new WebSocket('ws://' + window.location.host + '/ws/gcms/');

    socket.onopen = function(e) {
        addLog('成功连接到 WebSocket 服务器', 'success');
        connectionStatus.textContent = '在线';
        connectionStatus.className = 'badge bg-success';
        connectionStatusIcon.className = 'fas fa-wifi text-success me-2';
        // 请求初始状态
        sendMessage('get_status');
        sendMessage('get_arm_status');
        // 预取序列清单，避免序列文件名为空
        sendMessage('get_sequence_list');
    };

    socket.onclose = function(e) {
        addLog('WebSocket 连接已断开', 'danger');
        connectionStatus.textContent = '离线';
        connectionStatus.className = 'badge bg-danger';
        connectionStatusIcon.className = 'fas fa-wifi text-danger me-2';
    };

    socket.onerror = function(e) {
        addLog('WebSocket 连接发生错误', 'danger');
    };



    function sendMessage(command) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({'message': command}));
            addLog(`发送指令: ${command}`, 'info');
        } else {
            addLog('WebSocket 未连接，无法发送指令', 'warning');
        }
    }

    document.getElementById('refreshStatusBtn').addEventListener('click', () => sendMessage('get_status'));
    document.getElementById('getInstrumentInfoBtn').addEventListener('click', () => sendMessage('get_instrument_info'));
    const sequenceTableBody = document.getElementById('sequenceTableBody');
    const viewSequenceBtn = document.getElementById('viewSequenceBtn');
    if (viewSequenceBtn) {
        viewSequenceBtn.addEventListener('click', () => {
            if (socket.readyState === WebSocket.OPEN) {
                // 发送获取序列清单指令
                sendMessage('get_sequence_list');
                // 先显示加载中
                if (sequenceTableBody) {
                    sequenceTableBody.innerHTML = '<tr><td colspan="2" class="text-muted">加载中...</td></tr>';
                }
            }
        });
    }
    document.getElementById('clearLogsBtn').addEventListener('click', () => {
        logContainer.innerHTML = '';
        addLog('日志已清空', 'info');
    });

    // --- New Task Management Logic ---

    // On page load, check if any task is in a running state and lock the worker
    function initializeWorkerStatus() {
        const isAnyTaskRunning = tasks.some(t => t.statusText !== '待运行' && t.statusText !== '排队中' && t.statusText !== '已完成' && t.statusText !== '失败');
        if (isAnyTaskRunning) {
            isWorkerBusy = true;
            console.log('Worker status initialized to BUSY due to a running task on load.');
        } else {
            isWorkerBusy = false;
            console.log('Worker status initialized to IDLE.');
        }
    }

    // Position Status Elements

    function updatePositionStatus(status) {
        // idle, running, complete, error, manual_occupied
        if (!pos1Alert) return;

        switch (status) {
            case 'running':
                isWorkerBusy = true;
                isPositionManuallyOccupied = false;
                pos1Alert.className = 'alert alert-info py-2 mb-0';
                pos1Icon.className = 'fas fa-spinner fa-spin text-primary';
                pos1Text.textContent = '运行中';
                break;
            case 'error':
                isWorkerBusy = false;
                pos1Alert.className = 'alert alert-danger py-2 mb-0';
                pos1Icon.className = 'fas fa-exclamation-triangle text-danger';
                pos1Text.textContent = '运行失败';
                break;
            case 'manual_occupied':
                isPositionManuallyOccupied = true;
                pos1Alert.className = 'alert alert-warning py-2 mb-0';
                pos1Icon.className = 'fas fa-hand-paper text-warning';
                pos1Text.textContent = '手动占用';
                break;
            case 'idle':
            case 'complete':
            default:
                isWorkerBusy = false;
                isPositionManuallyOccupied = false;
                pos1Alert.className = 'alert alert-light py-2 mb-0';
                pos1Icon.className = 'fas fa-check-circle text-success';
                pos1Text.textContent = '位置空闲';
                break;
        }
    }

    pos1Card.addEventListener('click', () => {
        if (!isWorkerBusy) {
            if (isPositionManuallyOccupied) {
                updatePositionStatus('idle');
            } else {
                updatePositionStatus('manual_occupied');
            }
        }
    });

    function saveTasks() {
        localStorage.setItem('gcmsTasks', JSON.stringify(tasks));
    }

    function renderTasks() {
        tasksTableBody.innerHTML = ''; // Clear the table

        let pendingCount = 0;
        let completedCount = 0;

        if (tasks.length === 0) {
            tasksTableBody.innerHTML = `<tr id="no-tasks-row">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                暂无任务，请点击右上角创建
                            </td>
                        </tr>`;
        } else {
             tasks.forEach(task => {
                if (task.statusText === '已完成') {
                    completedCount++;
                } else {
                    pendingCount++;
                }

                const newRow = document.createElement('tr');
                newRow.id = task.id;
                newRow.innerHTML = `
                    <td>${task.displayId}</td>
                    <td>${task.name}</td>
                    <td>${task.bottleNum}</td>
                    <td>${task.sequenceIndex}</td>
                    <td>${task.sequenceName || 'N/A'}</td>
                    <td>${task.time}</td>
                    <td><span class="badge ${task.statusClass}">${task.statusText}</span></td>
                    <td>${task.duration || 'N/A'}</td>
                    <td>
                        <button class="btn btn-success btn-sm run-btn" onclick="handleRunTask('${task.id}')" ${task.runButtonDisabled ? 'disabled' : ''}>
                            ${task.runButtonHTML}
                        </button>
                        <button id="viewResultBtn-${task.id}" class="btn btn-info btn-sm ms-1" onclick="handleViewResult('${task.id}')" ${task.statusText === '已完成' ? '' : 'disabled'}>
                            <i class="fas fa-chart-line"></i> 查看结果
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" onclick="handleDeleteTask('${task.id}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tasksTableBody.appendChild(newRow);
            });
        }

        // Update counters
        document.getElementById('pendingAnalysis').textContent = pendingCount;
        document.getElementById('completedAnalysis').textContent = completedCount;
    }

    function loadTasks() {
        const savedTasks = localStorage.getItem('gcmsTasks');
        if (savedTasks) {
            tasks = JSON.parse(savedTasks);
            // Restore counter to avoid duplicate IDs
            taskIdCounter = tasks.length > 0 ? Math.max(...tasks.map(t => t.displayId)) : 0;
            renderTasks();
        }
    }

    // --- Initialization on page load ---
    function initializeApp() {
        loadTasks();
        initializeWorkerStatus();

        // Now that tasks are loaded, check if the runtime timer should be active
        const isAnyTaskRunning = tasks.some(t => !['待运行', '排队中', '已完成', '失败'].includes(t.statusText));
        
        if (isAnyTaskRunning) {
            // If any task is running, the master timer MUST be running.
            if (!localStorage.getItem('gcmsTotalRuntimeStart')) {
                addLog('警告：有任务在运行但未找到计时起点，将从现在开始计时。', 'warning');
                // We set it here so startTotalRuntime can pick it up.
                localStorage.setItem('gcmsTotalRuntimeStart', Date.now());
            }
            startTotalRuntime();
            addLog('恢复总运行计时器。', 'info');
        } else {
            // If no tasks are running, ensure the timer is stopped and reset.
            stopTotalRuntime();
        }
    }

    initializeApp();

    function runNextTaskInQueue() {
        if (isWorkerBusy) {
            console.log('Queue check: Aborted, worker is busy.');
            return;
        }
        if (isPositionManuallyOccupied) {
            console.log('Queue check: Aborted, position is manually occupied.');
            return;
        }

        const nextTask = tasks.find(t => t.statusText === '排队中');

        if (nextTask) {
            console.log(`Queue check: Found next task ${nextTask.id}, preparing to run.`);
            isWorkerBusy = true; // Set busy flag immediately
            sendMessage(`start_analysis_${nextTask.bottleNum}_${nextTask.sequenceIndex}`);
            
            // Visually update the task to show it's being sent
            nextTask.statusText = '请求运行';
            nextTask.statusClass = 'bg-info';
            nextTask.runButtonHTML = '<i class="fas fa-spinner fa-spin"></i> 运行中';
            saveTasks();
            renderTasks();
        } else {
            console.log('Queue check: No tasks in queue.');
        }
    }

    saveTaskBtn.addEventListener('click', () => {
        const experimentName = document.getElementById('experimentName').value.trim();
        const bottleNumInput = document.getElementById('bottleNum');
        const bottleNum = bottleNumInput.value;
        const sequenceIndexInput = document.getElementById('sequenceIndex');
        const sequenceIndex = sequenceIndexInput.value;

        if (!experimentName || bottleNum === '' || sequenceIndex === '') {
            alert('请填写所有字段');
            return;
        }

        if (parseInt(bottleNum) < 0 || parseInt(bottleNum) > 33) {
            alert('样品瓶号必须在 0 到 33 之间');
            return;
        }

        taskIdCounter++;
        const taskId = `task-${taskIdCounter}`;
        const currentTime = new Date().toLocaleTimeString();

        const newTask = {
            id: taskId,
            displayId: taskIdCounter,
            name: experimentName,
            bottleNum: bottleNum,
            sequenceIndex: sequenceIndex,
            sequenceName: sequenceMap[String(sequenceIndex)] || '',
            time: currentTime,
            statusText: '待运行',
            statusClass: 'bg-secondary',
            runButtonHTML: '<i class="fas fa-play"></i> 运行',
            runButtonDisabled: false,
            startTime: null, // Add startTime
            endTime: null, // Add endTime
            duration: '' // Add duration
        };
        
        tasks.push(newTask);
        saveTasks();
        renderTasks();

        // 若本地尚无序列清单或缺少该序列项，则请求一次以便回填
        if (!sequenceMap || !sequenceMap[String(sequenceIndex)]) {
            sendMessage('get_sequence_list');
        }

        createTaskForm.reset();
        createTaskModal.hide();
    });

    // --- Button Action Handlers ---
    window.handleRunTask = function(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        task.statusText = '排队中';
        task.statusClass = 'bg-primary';
        task.runButtonHTML = '<i class="fas fa-clock"></i> 排队中';
        task.runButtonDisabled = true;
        saveTasks();
        renderTasks();
        runNextTaskInQueue();
    }

    // 查看结果按钮
    const resultModalEl = document.getElementById('resultModal');
    const resultModal = new bootstrap.Modal(resultModalEl);
    const resultChartCanvas = document.getElementById('resultChart');
    const resultLoading = document.getElementById('resultLoading');
    const resultMessage = document.getElementById('resultMessage');
    let resultChartInstance = null;
    // 结果缓存：内存 + localStorage
    const resultCache = {};
    let activeResultTaskId = null;
    const downloadPngBtn = document.getElementById('downloadPngBtn');

    function showResultLoading(text) {
        resultLoading.style.display = '';
        resultLoading.textContent = text || '正在加载数据，请稍候...';
        resultChartCanvas.style.display = 'none';
        resultMessage.style.display = 'none';
    }
    function showResultMessage(text, level='warning') {
        resultLoading.style.display = 'none';
        resultChartCanvas.style.display = 'none';
        resultMessage.style.display = '';
        resultMessage.className = `alert alert-${level} mt-2`;
        resultMessage.textContent = text || '无可显示的数据';
    }
    function renderResultChart(xArr, yArr, titleText) {
        resultLoading.style.display = 'none';
        resultMessage.style.display = 'none';
        resultChartCanvas.style.display = '';
        const ctx = resultChartCanvas.getContext('2d');
        if (resultChartInstance) {
            resultChartInstance.destroy();
        }
        resultChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: xArr,
                datasets: [{
                    label: 'GCMS色谱',
                    data: yArr,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    title: { display: !!titleText, text: titleText || '' },
                    tooltip: {
                        callbacks: {
                            title: function(items){ return items && items.length ? `时间: ${items[0].label}` : ''; },
                            label: function(){ return ''; }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: '时间' }, ticks: { autoSkip: true, maxTicksLimit: 12 } },
                    y: { title: { display: true, text: '强度' }, beginAtZero: false, type: 'linear' }
                }
            }
        });
    }

    function setViewResultButtonState(taskId, state, messageText){
        const btn = document.getElementById(`viewResultBtn-${taskId}`);
        if (!btn) return;
        switch(state){
            case 'loading':
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中';
                break;
            case 'noresult':
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> 无结果';
                break;
            case 'error':
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times-circle"></i> 加载失败';
                break;
            default:
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-line"></i> 查看结果';
        }
        if (messageText) btn.setAttribute('title', messageText);
    }

    function saveResultToCache(taskId, series){
        try{
            resultCache[taskId] = series;
            localStorage.setItem(`gcmsResult_${taskId}`, JSON.stringify(series));
        }catch(e){ }
    }
    function loadResultFromCache(taskId){
        if (resultCache[taskId]) return resultCache[taskId];
        try{
            const s = localStorage.getItem(`gcmsResult_${taskId}`);
            if (s){
                const series = JSON.parse(s);
                resultCache[taskId] = series;
                return series;
            }
        }catch(e){ }
        return null;
    }

    window.handleViewResult = function(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        resultModal.show();
        activeResultTaskId = taskId;
        const cached = loadResultFromCache(taskId);
        if (cached && Array.isArray(cached.x) && Array.isArray(cached.y)){
            renderResultChart(cached.x, cached.y, `序列 ${task.sequenceIndex} 结果（缓存）`);
            setViewResultButtonState(taskId, '');
            return;
        }
        showResultLoading('正在请求结果数据...');
        setViewResultButtonState(taskId, 'loading');
        if (task.archiveId){
            sendMessage(`get_result_${task.bottleNum}_${task.sequenceIndex}_${task.archiveId}`);
        } else {
            sendMessage(`get_result_${task.bottleNum}_${task.sequenceIndex}`);
        }
    }

    // 导出PNG
    if (downloadPngBtn){
        downloadPngBtn.addEventListener('click', function(){
            if (!resultChartInstance) return;
            const link = document.createElement('a');
            link.href = resultChartInstance.toBase64Image();
            link.download = `gcms_result_${Date.now()}.png`;
            link.click();
        });
    }

    window.handleDeleteTask = function(taskId) {
        if (confirm('您确定要删除这个任务吗？')) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const isRunning = !['待运行', '排队中', '已完成', '失败'].includes(task.statusText);

            tasks = tasks.filter(t => t.id !== taskId);
            saveTasks();
            renderTasks();
            addLog(`删除了任务: ${task.name} (瓶号: ${task.bottleNum})`, 'info');

            if (isRunning) {
                isWorkerBusy = false;
                updatePositionStatus('idle');
                stopTotalRuntime();
                sendMessage('force_stop');
                addLog('由于删除了正在运行的任务，已重置工位状态。', 'warning');
            }
        }
    }



    // Enhanced onmessage to update state array and handle queue
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.sender;

        addLog(`收到消息: ${JSON.stringify(message)}`, 'primary');

        if (sender !== 'worker') return;

        const task = tasks.find(t => (
            t.bottleNum == message.bottle_num &&
            (message.sequence_index === undefined || t.sequenceIndex == message.sequence_index) &&
            !['待运行', '排队中', '已完成', '失败'].includes(t.statusText)
        ));

        switch (message.type) {
            case 'worker_connected':
                gcmsStatus.textContent = message.status;
                armStatus.textContent = '待获取';
                break;
            case 'status_update':
                gcmsStatus.textContent = message.status;
                gcmsRunMode.textContent = message.run_mode || '未知';
                gcmsRunStatus.textContent = message.run_status || '未知';
                break;
            case 'arm_status':
                armStatus.textContent = message.status;
                break;
            case 'analysis_started':
                if (task) {
                    task.statusText = '任务开始';
                    task.statusClass = 'bg-info';
                    task.startTime = Date.now(); // 记录开始时间
                }
                updatePositionStatus('running');
                startTotalRuntime(); // 启动总计时器
                break;
            case 'analysis_progress':
                if (task) {
                    task.statusText = message.stage;
                    task.statusClass = 'bg-info text-dark';
                }
                updatePositionStatus('running');
                break;
            case 'analysis_complete':
                if (task) {
                    task.statusText = '已完成';
                    task.statusClass = 'bg-success';
                    task.runButtonHTML = '<i class="fas fa-redo"></i> 重新运行';
                    task.runButtonDisabled = false;
                    task.endTime = Date.now();
                    if (message.archive_id){
                        task.archiveId = message.archive_id;
                    }
                    if (task.startTime) {
                        const durationSeconds = Math.round((task.endTime - task.startTime) / 1000);
                        const minutes = Math.floor(durationSeconds / 60);
                        const seconds = durationSeconds % 60;
                        task.duration = `${minutes}分${seconds}秒`;
                    }
                }
                isWorkerBusy = false; // Explicitly unlock the worker
                updatePositionStatus('complete');
                runNextTaskInQueue(); // Check for next task
                stopTotalRuntime(); // Check if we should stop the main timer
                break;
            case 'analysis_error':
                if (task) {
                    task.statusText = '失败';
                    task.statusClass = 'bg-danger';
                    task.runButtonHTML = '<i class="fas fa-redo"></i> 重试';
                    task.runButtonDisabled = false;
                    task.endTime = Date.now();
                    if (task.startTime) {
                        const durationSeconds = Math.round((task.endTime - task.startTime) / 1000);
                        const minutes = Math.floor(durationSeconds / 60);
                        const seconds = durationSeconds % 60;
                        task.duration = `${minutes}分${seconds}秒`;
                    }
                }
                isWorkerBusy = false; // Explicitly unlock the worker
                updatePositionStatus('error');
                runNextTaskInQueue(); // Check for next task
                stopTotalRuntime(); // Check if we should stop the main timer
                break;
            case 'sequence_list':
                // 渲染序列清单
                if (Array.isArray(message.items) && sequenceTableBody) {
                    // 刷新本地缓存
                    sequenceMap = {};
                    message.items.forEach(it => { sequenceMap[String(it.index)] = it.name; });
                    if (message.items.length === 0) {
                        sequenceTableBody.innerHTML = '<tr><td colspan="2" class="text-muted">未发现任何序列</td></tr>';
                    } else {
                        sequenceTableBody.innerHTML = message.items.map(item => `
                            <tr>
                                <td>${item.index}</td>
                                <td>${item.name}</td>
                            </tr>
                        `).join('');
                    }
                    // 尝试为现有任务补全序列文件名
                    tasks.forEach(t => {
                        if (t.sequenceIndex != null && t.sequenceIndex !== '' && sequenceMap[String(t.sequenceIndex)]) {
                            t.sequenceName = sequenceMap[String(t.sequenceIndex)];
                        }
                    });
                    saveTasks();
                    renderTasks();
                }
                break;
            case 'analysis_result':
                if (!message.available) {
                    showResultMessage(message.message || '未找到结果文件');
                    if (activeResultTaskId) setViewResultButtonState(activeResultTaskId, 'noresult', message.message);
                } else if (message.series && Array.isArray(message.series.x) && Array.isArray(message.series.y)) {
                    const x = message.series.x;
                    const y = message.series.y;
                    renderResultChart(x, y, `序列 ${message.sequence_index} 结果`);
                    if (activeResultTaskId) {
                        saveResultToCache(activeResultTaskId, {x, y});
                        setViewResultButtonState(activeResultTaskId, '');
                        // 若返回了归档ID，补充保存到任务，增强刷新后的可追溯
                        const t = tasks.find(tt => tt.id === activeResultTaskId);
                        if (t && message.archive_id) {
                            t.archiveId = message.archive_id;
                            saveTasks();
                        }
                    }
                } else {
                    showResultMessage('结果数据格式不正确');
                    if (activeResultTaskId) setViewResultButtonState(activeResultTaskId, 'error');
                }
                break;
            default:
                // Handle other message types if necessary
                break;
        }

        // After any potential change, save and re-render
        if (task) {
            saveTasks();
            renderTasks();
        }
    };

    // 面包屑高亮“GCMS”
    setTimeout(function() {
        var breadcrumb = document.querySelector('nav[aria-label="breadcrumb"] .breadcrumb');
        if (breadcrumb) {
            var links = breadcrumb.querySelectorAll('.breadcrumb-item a');
            var indicator = breadcrumb.querySelector('.breadcrumb-indicator');
            var target = null;
            for (var i = 0; i < links.length; i++) {
                if (links[i].textContent.trim() === 'GCMS') { target = links[i]; break; }
            }
            if (target) {
                links.forEach(function(a){ a.classList.remove('active'); });
                target.classList.add('active');
                if (indicator) {
                    indicator.style.width = target.offsetWidth + 'px';
                    indicator.style.transform = 'translateX(' + target.offsetLeft + 'px)';
                }
            }
        }
    }, 100); // 延迟100毫秒执行，确保元素渲染完成

    // 卡片折叠图标旋转
    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        element.addEventListener('click', function() {
            var icon = this.querySelector('.collapse-icon');
            var target = document.querySelector(this.getAttribute('data-bs-target'));
            setTimeout(function() {
                if (target && target.classList.contains('show')) {
                    icon.style.transform = 'rotate(0deg)';
                } else if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }, 50);
        });
    });

    // --- 全局运行时间管理 ---

    function updateTotalRuntimeDisplay() {
        const startTime = localStorage.getItem('gcmsTotalRuntimeStart');
        if (!startTime) {
            document.getElementById('runtimeHours').textContent = '0';
            document.getElementById('runtimeMinutes').textContent = '00';
            return;
        }

        const diff = Date.now() - parseInt(startTime, 10);
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        document.getElementById('runtimeHours').textContent = hours;
        document.getElementById('runtimeMinutes').textContent = String(minutes).padStart(2, '0');
    }

    function startTotalRuntime() {
        if (totalRuntimeInterval) return; // 已经在运行

        if (!localStorage.getItem('gcmsTotalRuntimeStart')) {
            localStorage.setItem('gcmsTotalRuntimeStart', Date.now());
        }
        
        updateTotalRuntimeDisplay();
        totalRuntimeInterval = setInterval(updateTotalRuntimeDisplay, 10000); // 每10秒更新一次以减少消耗
    }

    function stopTotalRuntime() {
        // 仅当没有其他任务在运行时才停止
        const isAnyTaskRunning = tasks.some(t => !['待运行', '排队中', '已完成', '失败'].includes(t.statusText));
        if (!isAnyTaskRunning) {
            clearInterval(totalRuntimeInterval);
            totalRuntimeInterval = null;
            localStorage.removeItem('gcmsTotalRuntimeStart');
            updateTotalRuntimeDisplay(); // 重置为0
            addLog('所有任务完成，总运行计时器已停止。', 'success');
        }
    }


});
</script>

<style>
.station-card, .position-card { 
    transition: all .3s ease; 
    border-width: 2px; 
}
.station-card:hover, .position-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(0,0,0,.1); 
}

.card-header:hover ~ .card-body .station-card,
.card-header:hover ~ .card-body .position-card {
    transform: none !important;
    box-shadow: none !important;
}

.card-header[data-bs-toggle="collapse"] { transition: none; }
.card-header[data-bs-toggle="collapse"]:hover { cursor: pointer; }

.card-header.bg-primary:hover { background-color: var(--bs-primary) !important; }
.card-header.bg-warning:hover { background-color: var(--bs-warning) !important; }
.card-header.bg-info:hover { background-color: var(--bs-info) !important; }

.position-card.border-light { border-color: #dee2e6 !important; }
.collapse-icon { transition: transform 0.3s ease; }

#gcmsStatusCard { border-left: 4px solid #0dcaf0; box-shadow: 0 2px 10px rgba(13, 202, 240, 0.1); }
#gcmsStatusCard .card-header { transition: background 0.3s ease; }
</style>
{% endblock %}


