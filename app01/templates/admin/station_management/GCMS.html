{% extends 'admin/station_management.html' %}

{% block title %}GCMS - 工站管理{% endblock %}

{% block main_content %}
{{ block.super }}

<!-- 工站状态卡片 -->
<div class="card mb-4" id="gcmsStatusCard">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsStationStatus"
         aria-expanded="true" aria-controls="gcmsStationStatus" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-chart-line"></i> 工站状态</h4>
        <div class="d-flex align-items-center">
            <span class="badge bg-light text-dark me-2">实时监控</span>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsStationStatus">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="armStatusIcon" class="fas fa-hand-rock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">机械臂</h6>
                            <p id="armStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="gcmsStatusIcon" class="fas fa-vial text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">GCMS</h6>
                            <p id="gcmsStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-cogs text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行模式</h6>
                            <p id="gcmsRunMode" class="mb-0 fw-bold text-secondary">未知</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-info-circle text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行状态</h6>
                            <p id="gcmsRunStatus" class="mb-0 fw-bold text-secondary">未知</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-clock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行时间</h6>
                            <p class="mb-0 fw-bold"><span id="runtimeHours">0</span> 小时 <span id="runtimeMinutes">00</span> 分</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tasks text-info me-2"></i>
                            <span class="text-muted">待分析任务数</span>
                        </div>
                        <span class="badge bg-info" id="pendingAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span class="text-muted">已完成分析</span>
                        </div>
                        <span class="badge bg-success" id="completedAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i id="connectionStatusIcon" class="fas fa-wifi text-danger me-2"></i>
                            <span class="text-muted">连接状态</span>
                        </div>
                        <span class="badge bg-danger" id="connectionStatus">离线</span>
                    </div>
                </div>
            </div>
            
            <!-- 控制按钮区域 -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button id="refreshStatusBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i>刷新状态
                        </button>

                        <button id="getInstrumentInfoBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-info-circle me-1"></i>仪器信息
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志卡片 -->
<div class="card mt-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsLogs"
         aria-expanded="true" aria-controls="gcmsLogs" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-terminal"></i> 实时日志</h4>
        <div class="d-flex align-items-center">
            <button id="clearLogsBtn" class="btn btn-outline-light btn-sm me-2" onclick="event.stopPropagation();">
                <i class="fas fa-trash"></i> 清空
            </button>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsLogs">
        <div class="card-body p-0">
            <div id="logContainer" class="log-container" style="height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">
                <div class="log-entry text-info">
                    <span class="timestamp">[系统]</span> 等待连接到 GCMS Worker...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 当前仓位卡片 -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsPositions"
         aria-expanded="true" aria-controls="gcmsPositions" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-boxes"></i> 当前仓位（1）</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="gcmsPositions">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100 position-card border-light" id="position-1-card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary">仓位 1</h5>
                            <p class="card-text text-muted small">GCMS 工站</p>
                            <div class="position-status">
                                <div id="position-1-status-alert" class="alert alert-light py-2 mb-0">
                                    <i id="position-1-status-icon" class="fas fa-circle text-success"></i>
                                    <span id="position-1-status-text" class="text-muted">位置空闲</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GCMS 分析任务列表卡片 -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsTasks"
         aria-expanded="true" aria-controls="gcmsTasks" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-tasks"></i> GCMS 分析任务列表</h4>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                <i class="fas fa-plus-circle me-1"></i> 创建分析任务
            </button>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="viewSequenceBtn" data-bs-toggle="modal" data-bs-target="#sequenceListModal">
                <i class="fas fa-list-ul me-1"></i> 查看序列清单
            </button>
            <i class="fas fa-chevron-down collapse-icon ms-3"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsTasks">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tasksTable">
                    <thead class="table-light">
                        <tr>
                            <th>任务ID</th>
                            <th>实验名称</th>
                            <th>样品瓶号</th>
                            <th>序列号</th>
                            <th>序列文件</th>
                            <th>创建时间</th>
                            <th>状态</th>
                            <th>任务用时</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="no-tasks-row">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                暂无任务，请点击右上角创建
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 创建任务 Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">创建新的分析任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="experimentName" class="form-label">实验名称</label>
                        <input type="text" class="form-control" id="experimentName" placeholder="例如：样品批次A-01" required>
                    </div>
                    <div class="mb-3">
                        <label for="bottleNum" class="form-label">样品瓶号 (0-33)</label>
                        <input type="number" class="form-control" id="bottleNum" min="0" max="33" required>
                    </div>
                    <div class="mb-3">
                        <label for="sequenceIndex" class="form-label">序列号 (参见序列清单编号)</label>
                        <input type="number" class="form-control" id="sequenceIndex" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">创建任务</button>
            </div>
        </div>
    </div>
</div>

<!-- 序列清单 Modal -->
<div class="modal fade" id="sequenceListModal" tabindex="-1" aria-labelledby="sequenceListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sequenceListModalLabel">序列清单（只读）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th style="width: 120px;">序号</th>
                                <th>序列文件名</th>
                            </tr>
                        </thead>
                        <tbody id="sequenceTableBody">
                            <tr>
                                <td colspan="2" class="text-muted">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看结果 Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">分析结果 - 色谱图与质谱图</h5>
                <div class="d-flex gap-2 align-items-center">
                    <button type="button" class="btn btn-primary btn-sm" id="downloadChromatogramPngBtn">
                        <i class="fas fa-download"></i> 导出色谱图
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="downloadMassSpectrumPngBtn" style="display:none;">
                        <i class="fas fa-download"></i> 导出质谱图
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 results-body">
                <div id="resultLoading" class="text-muted text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>
                    正在加载数据，请稍候...
                </div>
                
                <!-- 主容器：上下布局 -->
                <div id="resultContainer" style="display:none;">
                    <!-- 上半部分：色谱图 -->
                    <div class="section-half section-top">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">色谱图（TIC - 总离子流）</h6>
                            <small class="text-muted">
                                保留时间: <span id="currentRetentionTime" class="badge bg-info">--</span> 分钟
                            </small>
                        </div>
                        <div class="panel">
                            <canvas id="resultChart" class="chart-canvas" style="width:100%; height:100%; display:block;"></canvas>
                        </div>
                        <!-- 滑块容器 -->
                        <div class="slider-wrap mt-2">
                            <input type="range" id="retentionTimeSlider" 
                                   class="form-range" 
                                   min="0" max="100" value="0" 
                                   style="width: 100%; cursor: pointer;">
                            <div class="d-flex justify-content-between mt-1 slider-range-labels">
                                <span id="sliderMinLabel">0.00</span>
                                <span id="sliderMaxLabel">100.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 下半部分：质谱图 -->
                    <div class="section-half">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">质谱图（MS）</h6>
                            <small class="text-muted" id="massSpectrumStatus">
                                <i class="fas fa-info-circle"></i> 在上方色谱图上拖动滑块加载质谱数据
                            </small>
                        </div>
                        <div class="panel">
                            <canvas id="massSpectrumChart" class="chart-canvas" style="width:100%; height:100%; display:block;"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="resultMessage" class="alert alert-warning mt-3" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 全局变量定义 ---
    let totalRuntimeInterval = null;
    let tasks = [];
    let taskIdCounter = 0; // 显示ID（来自后端）
    let isWorkerBusy = false;
    let isPositionManuallyOccupied = false;

    // --- DOM 元素获取 ---
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const createTaskForm = document.getElementById('createTaskForm');
    const tasksTableBody = document.querySelector('#tasksTable tbody');
    const noTasksRow = document.getElementById('no-tasks-row');
    const createTaskModalEl = document.getElementById('createTaskModal');
    const createTaskModal = new bootstrap.Modal(createTaskModalEl);
    const pos1Card = document.getElementById('position-1-card');
    const pos1Alert = document.getElementById('position-1-status-alert');
    const pos1Icon = document.getElementById('position-1-status-icon');
    const pos1Text = document.getElementById('position-1-status-text');

    const logContainer = document.getElementById('logContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionStatusIcon = document.getElementById('connectionStatusIcon');
    const armStatus = document.getElementById('armStatus');
    const gcmsStatus = document.getElementById('gcmsStatus');
    const gcmsRunMode = document.getElementById('gcmsRunMode');
    const gcmsRunStatus = document.getElementById('gcmsRunStatus');
    // 本地缓存序列映射：index->name
    let sequenceMap = {};
    const sequenceTableBody = document.getElementById('sequenceTableBody');
    const viewSequenceBtn = document.getElementById('viewSequenceBtn');

    // --- 工具函数 ---
    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry text-${type}`;
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    function statusClassByCode(code){
        switch(code){
            case 'pending': return 'bg-secondary';
            case 'queued': return 'bg-primary';
            case 'task_started':
            case 'device_preparation':
            case 'arm_operation':
            case 'instrument_analysis':
            case 'waiting_completion':
            case 'device_reset': return 'bg-info text-dark';
            case 'completed': return 'bg-success';
            case 'failed': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // --- WebSocket ---
    const wsProto = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(wsProto + window.location.host + '/ws/gcms/');

    socket.onopen = function(e) {
        addLog('成功连接到 WebSocket 服务器', 'success');
        connectionStatus.textContent = '在线';
        connectionStatus.className = 'badge bg-success';
        connectionStatusIcon.className = 'fas fa-wifi text-success me-2';
        // 请求初始状态
        sendMessage('get_status');
        sendMessage('get_arm_status');
        // 预取序列清单，避免序列文件名为空
        sendMessage('get_sequence_list');
    };
    socket.onclose = function(e) {
        addLog('WebSocket 连接已断开', 'danger');
        connectionStatus.textContent = '离线';
        connectionStatus.className = 'badge bg-danger';
        connectionStatusIcon.className = 'fas fa-wifi text-danger me-2';
    };
    socket.onerror = function(e) { addLog('WebSocket 连接发生错误', 'danger'); };

    function sendMessage(command) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({'message': command}));
            addLog(`发送指令: ${command}`, 'info');
        } else {
            addLog('WebSocket 未连接，无法发送指令', 'warning');
        }
    }

    if (viewSequenceBtn) {
        viewSequenceBtn.addEventListener('click', () => {
            if (socket.readyState === WebSocket.OPEN) {
                sendMessage('get_sequence_list');
                if (sequenceTableBody) {
                    sequenceTableBody.innerHTML = '<tr><td colspan="2" class="text-muted">加载中...</td></tr>';
                }
            }
        });
    }
    document.getElementById('refreshStatusBtn').addEventListener('click', () => sendMessage('get_status'));
    document.getElementById('getInstrumentInfoBtn').addEventListener('click', () => sendMessage('get_instrument_info'));
    document.getElementById('clearLogsBtn').addEventListener('click', () => { logContainer.innerHTML = ''; addLog('日志已清空', 'info'); });

    // --- 与后端交互（API） ---
    async function loadTasksFromServer(){
        try{
            const resp = await fetch('/api/gcms/tasks/');
            if(!resp.ok) throw new Error('加载任务失败');
            const data = await resp.json();
            if(!data.success) throw new Error(data.error || '加载任务失败');
            const list = data.tasks || [];
            tasks = list.map(t => ({
                id: `task-${t.id}`,
                dbId: t.id,
                displayId: t.displayId,
                name: t.name,
                bottleNum: t.bottleNum,
                sequenceIndex: t.sequenceIndex,
                sequenceName: t.sequenceName || '',
                time: t.time,
                statusText: t.statusText,
                statusCode: t.status,
                statusClass: statusClassByCode(t.status),
                runButtonHTML: (t.status === 'pending' || t.status === 'failed' || t.status === 'completed') ? '<i class="fas fa-play"></i> 运行' : '<i class="fas fa-clock"></i> 排队中',
                runButtonDisabled: !(t.status === 'pending' || t.status === 'failed' || t.status === 'completed'),
                startTime: t.startTime,
                endTime: t.endTime,
                duration: t.duration || 'N/A',
                archiveId: t.archiveId || null
            }));
            taskIdCounter = list.length ? Math.max(...list.map(t=>t.displayId||0)) : 0;
            renderTasks();
        }catch(err){
            console.error(err);
            addLog('从服务器加载任务失败: ' + err.message, 'danger');
        }
    }

    async function createTaskOnServer(payload){
        const resp = await fetch('/api/gcms/tasks/create/', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error('创建任务失败');
        const data = await resp.json();
        if(!data.success) throw new Error(data.error || '创建任务失败');
        return data.task;
    }

    async function updateTaskOnServer(dbId, payload){
        try{
            const resp = await fetch(`/api/gcms/tasks/${dbId}/update/`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload || {})
            });
            if(!resp.ok) throw new Error('更新任务失败');
            const data = await resp.json();
            if(!data.success) throw new Error(data.error || '更新任务失败');
            return data.task;
        }catch(err){
            console.error('更新任务失败', err);
            addLog('更新任务失败: ' + err.message, 'danger');
            return null;
        }
    }

    async function deleteTaskOnServer(dbId){
        const resp = await fetch(`/api/gcms/tasks/${dbId}/delete/`, { method: 'DELETE' });
        if(!resp.ok) throw new Error('删除任务失败');
        const data = await resp.json();
        if(!data.success) throw new Error(data.error || '删除任务失败');
        return true;
    }

    // --- 渲染 ---
    function renderTasks() {
        tasksTableBody.innerHTML = '';
        let pendingCount = 0; let completedCount = 0;
        if (tasks.length === 0) {
            tasksTableBody.innerHTML = `<tr id="no-tasks-row">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                暂无任务，请点击右上角创建
                            </td>
                        </tr>`;
        } else {
            tasks.forEach(task => {
                if (task.statusCode === 'completed') { completedCount++; } else { pendingCount++; }
                const newRow = document.createElement('tr');
                newRow.id = task.id;
                newRow.innerHTML = `
                    <td>${task.displayId}</td>
                    <td>${task.name}</td>
                    <td>${task.bottleNum}</td>
                    <td>${task.sequenceIndex}</td>
                    <td>${task.sequenceName || 'N/A'}</td>
                    <td>${task.time}</td>
                    <td><span class="badge ${task.statusClass}">${task.statusText}</span></td>
                    <td>${task.duration || 'N/A'}</td>
                    <td>
                        <button class="btn btn-success btn-sm run-btn" onclick="handleRunTask('${task.id}')" ${task.runButtonDisabled ? 'disabled' : ''}>
                            ${task.runButtonHTML}
                        </button>
                        <button id="viewResultBtn-${task.id}" class="btn btn-info btn-sm ms-1" onclick="handleViewResult('${task.id}')" ${task.statusCode === 'completed' ? '' : 'disabled'}>
                            <i class="fas fa-chart-line"></i> 查看结果
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" onclick="handleDeleteTask('${task.id}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>`;
                tasksTableBody.appendChild(newRow);
            });
        }
        document.getElementById('pendingAnalysis').textContent = pendingCount;
        document.getElementById('completedAnalysis').textContent = completedCount;
    }

    // --- 初始化 ---
    async function initializeApp() {
        await loadTasksFromServer();
        initializeWorkerStatus();
        const isAnyTaskRunning = tasks.some(t => !['pending','queued','completed','failed'].includes(t.statusCode));
        if (isAnyTaskRunning) {
            if (!localStorage.getItem('gcmsTotalRuntimeStart')) {
                localStorage.setItem('gcmsTotalRuntimeStart', Date.now());
            }
            startTotalRuntime();
        } else {
            stopTotalRuntime();
        }
    }

    // On page load, check if any task is in a running state and lock the worker
    function initializeWorkerStatus() {
        const isAnyTaskRunning = tasks.some(t => !['pending','queued','completed','failed'].includes(t.statusCode));
        isWorkerBusy = isAnyTaskRunning;
    }

    initializeApp();

    // --- 队列 ---
    function runNextTaskInQueue() {
        if (isWorkerBusy) return;
        if (isPositionManuallyOccupied) return;
        const nextTask = tasks.find(t => t.statusCode === 'queued');
        if (nextTask) {
            isWorkerBusy = true;
            sendMessage(`start_analysis_${nextTask.bottleNum}_${nextTask.sequenceIndex}`);
            nextTask.statusText = '请求运行';
            nextTask.statusClass = 'bg-info';
            nextTask.runButtonHTML = '<i class="fas fa-spinner fa-spin"></i> 运行中';
            renderTasks();
        }
    }

    // --- 创建任务 ---
    saveTaskBtn.addEventListener('click', async () => {
        const experimentName = document.getElementById('experimentName').value.trim();
        const bottleNum = document.getElementById('bottleNum').value;
        const sequenceIndex = document.getElementById('sequenceIndex').value;
        const sequenceName = sequenceMap[String(sequenceIndex)] || '';

        if (!experimentName || bottleNum === '' || sequenceIndex === '') {
            alert('请填写所有字段');
            return;
        }
        if (parseInt(bottleNum) < 0 || parseInt(bottleNum) > 33) {
            alert('样品瓶号必须在 0 到 33 之间');
            return;
        }
        try{
            const t = await createTaskOnServer({
                experimentName, bottleNum: parseInt(bottleNum), sequenceIndex: parseInt(sequenceIndex), sequenceName
            });
            tasks.unshift({
                id: `task-${t.id}`,
                dbId: t.id,
                displayId: t.displayId,
                name: t.name,
                bottleNum: t.bottleNum,
                sequenceIndex: t.sequenceIndex,
                sequenceName: t.sequenceName || '',
                time: t.time,
                statusText: t.statusText,
                statusCode: t.status,
                statusClass: statusClassByCode(t.status),
                runButtonHTML: '<i class="fas fa-play"></i> 运行',
                runButtonDisabled: false,
                startTime: null,
                endTime: null,
                duration: t.duration || 'N/A',
                archiveId: null
            });
            taskIdCounter = Math.max(taskIdCounter, t.displayId);
            renderTasks();
            createTaskForm.reset();
            createTaskModal.hide();
            addLog('任务创建成功', 'success');
        }catch(err){
            console.error(err);
            alert('创建任务失败: ' + err.message);
        }
    });

    // --- 按钮动作 ---
    window.handleRunTask = async function(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        task.statusCode = 'queued';
        task.statusText = '排队中';
        task.statusClass = 'bg-primary';
        task.runButtonHTML = '<i class="fas fa-clock"></i> 排队中';
        task.runButtonDisabled = true;
        renderTasks();
        await updateTaskOnServer(task.dbId, { status: 'queued' });
        runNextTaskInQueue();
    }

    window.handleDeleteTask = async function(taskId) {
        if (!confirm('您确定要删除这个任务吗？')) return;
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        const isRunning = !['pending','queued','completed','failed'].includes(task.statusCode);
        try{
            await deleteTaskOnServer(task.dbId);
            tasks = tasks.filter(t => t.id !== taskId);
            renderTasks();
            addLog(`删除了任务: ${task.name} (瓶号: ${task.bottleNum})`, 'info');
            if (isRunning) {
                isWorkerBusy = false;
                updatePositionStatus('idle');
                stopTotalRuntime();
                sendMessage('force_stop');
                addLog('由于删除了正在运行的任务，已重置工位状态。', 'warning');
            }
        }catch(err){
            console.error(err);
            alert('删除任务失败: ' + err.message);
        }
    }

    // 查看结果按钮
    const resultModalEl = document.getElementById('resultModal');
    const resultModal = new bootstrap.Modal(resultModalEl);
// 弹窗显示后再对齐一次，避免字体/布局异步导致的微小偏差
resultModalEl.addEventListener('shown.bs.modal', alignSliderWithYAxis);
    const resultChartCanvas = document.getElementById('resultChart');
    const massSpectrumCanvas = document.getElementById('massSpectrumChart');
    const resultLoading = document.getElementById('resultLoading');
    const resultMessage = document.getElementById('resultMessage');
    const resultContainer = document.getElementById('resultContainer');
    const retentionTimeSlider = document.getElementById('retentionTimeSlider');
    const sliderWrapEl = document.querySelector('.slider-wrap');
    const currentRetentionTimeDisplay = document.getElementById('currentRetentionTime');
    const sliderMinLabel = document.getElementById('sliderMinLabel');
    const sliderMaxLabel = document.getElementById('sliderMaxLabel');
    const massSpectrumStatus = document.getElementById('massSpectrumStatus');
    const downloadChromatogramPngBtn = document.getElementById('downloadChromatogramPngBtn');
    const downloadMassSpectrumPngBtn = document.getElementById('downloadMassSpectrumPngBtn');
    
    let resultChartInstance = null;
    let massSpectrumChartInstance = null;
    const resultCache = {};
    let activeResultTaskId = null;
    let activeSequenceIndex = null;
    let activeBottleNum = null;
    let activeArchiveId = null;
    let chromatogramXData = [];  // 保存色谱图的 X 数据用于滑块映射
    let chromatogramYData = [];  // 保存色谱图的 Y 数据
    let sliderTimeout = null;    // 防止频繁请求
    let currentRtValue = null;   // 当前滑块对应的RT值（分钟）
    // 对齐滑块与图表绘图区：直接设置滑块宽度与左边距，保证拇指与红线同列
    function alignSliderWithYAxis(){
        if (!resultChartInstance || !sliderWrapEl || !retentionTimeSlider) return;
        try {
            const ca = resultChartInstance.chartArea;
            if (!ca) return;
            const plotWidth = Math.max(0, ca.right - ca.left);
            const left = Math.max(0, ca.left);
            // 使滑块轨道与绘图区完全重合
            sliderWrapEl.style.paddingLeft = '0px';
            sliderWrapEl.style.paddingRight = '0px';
            retentionTimeSlider.style.width = plotWidth + 'px';
            retentionTimeSlider.style.marginLeft = left + 'px';
            // 同步下方刻度标签对齐
            const labels = sliderWrapEl.querySelector('.slider-range-labels');
            if (labels) {
                labels.style.paddingLeft = left + 'px';
                labels.style.paddingRight = (resultChartInstance.width - ca.right) + 'px';
            }
        } catch(e){}
    }
    window.addEventListener('resize', alignSliderWithYAxis);

    //（已禁用）垂直参考线插件，避免个别环境下 Chart.js 抛出 “class does not have id” 的兼容性错误。
    // 如需开启，可引入 chartjs-plugin-annotation 或改为内置 dataset 方案绘制垂直线。

    function showResultLoading(text) {
        resultLoading.style.display = '';
        resultLoading.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>' + (text || '正在加载数据，请稍候...');
        resultContainer.style.display = 'none';
        resultMessage.style.display = 'none';
    }
    
    function showResultMessage(text, level='warning') {
        resultLoading.style.display = 'none';
        resultContainer.style.display = 'none';
        resultMessage.style.display = '';
        resultMessage.className = `alert alert-${level} mt-3`;
        resultMessage.textContent = text || '无可显示的数据';
    }
    
    function renderChromatogramChart(xArr, yArr, titleText) {
        resultLoading.style.display = 'none';
        resultMessage.style.display = 'none';
        resultContainer.style.display = '';
        
        // 全量绘制：按 x 升序排序，不做阈值裁剪/抽样，保持与 CSV 一致
        const pairs = xArr.map((x,i)=>({x: Number(x), y: Number(yArr[i])})).filter(p=>Number.isFinite(p.x)&&Number.isFinite(p.y));
        pairs.sort((a,b)=>a.x-b.x);
        const xSlice = pairs.map(p=>p.x);
        const ySlice = pairs.map(p=>p.y);
        // 保存数据用于滑块映射
        chromatogramXData = xSlice;
        chromatogramYData = ySlice;
        
        // 更新滑块范围
        const minX = Math.min(...xSlice);
        const maxX = Math.max(...xSlice);
        retentionTimeSlider.min = 0;
        retentionTimeSlider.max = 100;
        retentionTimeSlider.value = 0;
        sliderMinLabel.textContent = minX.toFixed(2);
        sliderMaxLabel.textContent = maxX.toFixed(2);
        currentRetentionTimeDisplay.textContent = minX.toFixed(2);
        currentRtValue = minX;
        
        const ctx = resultChartCanvas.getContext('2d');
        if (resultChartInstance) { resultChartInstance.destroy(); }
        // 计算固定的Y轴范围，避免进入页面时Y轴抖动（基于有效区间）
        const yMin = Math.min(...ySlice);
        const yMax = Math.max(...ySlice);
        const yPadding = (yMax - yMin) * 0.1;
        const fixedYMin = Math.max(0, yMin - yPadding);
        const fixedYMax = yMax + yPadding;
        
        // 构造主数据集（仅使用有效区间，线性x坐标的 {x,y} 点）
        const mainSeries = xSlice.map((x,i) => ({ x: Number(x), y: Number(ySlice[i]) }));
        // 构造初始竖线数据集（无插件方案：叠加一个line数据集，x固定为 currentRtValue，y从min到max）
        const vlineSeries = [
            { x: currentRtValue, y: fixedYMin },
            { x: currentRtValue, y: fixedYMax }
        ];
        
        resultChartInstance = new Chart(ctx, {
            type: 'line',
            data: { 
                datasets: [
                    { 
                        label: 'TIC 色谱', 
                        data: mainSeries, 
                        borderColor: 'rgba(54, 162, 235, 1)', 
                        backgroundColor: 'rgba(54, 162, 235, 0.1)', 
                        borderWidth: 2, 
                        pointRadius: 0,
                        tension: 0.1,
                        parsing: false,
                        xAxisID: 'x',
                        yAxisID: 'y'
                    },
                    {
                        label: '当前位置',
                        data: vlineSeries,
                        borderColor: 'rgba(255,0,0,0.9)',
                        backgroundColor: 'rgba(255,0,0,0.9)',
                        borderWidth: 1,
                        pointRadius: 0,
                        showLine: true,
                        parsing: false,
                        xAxisID: 'x',
                        yAxisID: 'y',
                        _isVLine: true // 自定义标记，便于后续更新
                    }
                ] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                animation: false,
                interaction: { mode: 'nearest', intersect: false }, 
                plugins: { 
                    legend: { display: false }, 
                    title: { display: false },
                    tooltip: { 
                        callbacks: { 
                            title: function(items){ return items && items.length ? `时间: ${Number(items[0].parsed.x).toFixed(2)} 分钟` : ''; }, 
                            label: function(context){ return `强度: ${Number(context.parsed.y).toFixed(0)}`; } 
                        } 
                    } 
                }, 
                scales: { 
                    x: { 
                        type: 'linear',
                        min: minX,
                        max: maxX,
                        title: { display: true, text: '保留时间 (分钟)' }
                    }, 
                    y: { 
                        type: 'linear',
                        title: { display: true, text: '强度' }, 
                        beginAtZero: false, 
                        min: fixedYMin,
                        max: fixedYMax
                    } 
                } 
            }
        });
        // 让滑块左右内边距与图表绘图区对齐，使滑块起点位于色谱图y轴正下方
        setTimeout(alignSliderWithYAxis, 0);
        
        downloadMassSpectrumPngBtn.style.display = 'none';
    }
    
    function renderMassSpectrumChart(mzArr, intensityArr, rtValue) {
        const ctx = massSpectrumCanvas.getContext('2d');
        if (massSpectrumChartInstance) { massSpectrumChartInstance.destroy(); }
        
        // 限制显示的数据点数量
        let displayMz = mzArr;
        let displayIntensity = intensityArr;
        if (mzArr.length > 500) {
            const step = Math.ceil(mzArr.length / 500);
            displayMz = mzArr.filter((_, i) => i % step === 0);
            displayIntensity = intensityArr.filter((_, i) => i % step === 0);
        }
        
        massSpectrumChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: displayMz.map(v => v.toFixed(1)), 
                datasets: [{ 
                    label: '强度', 
                    data: displayIntensity, 
                    backgroundColor: 'rgba(75, 192, 75, 0.7)', 
                    borderColor: 'rgba(75, 192, 75, 1)', 
                    borderWidth: 0.5
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(items){ return items && items.length ? `m/z: ${items[0].label}` : ''; },
                            label: function(context){ return `强度: ${context.parsed.y.toFixed(0)}`; }
                        }
                    }
                }, 
                scales: { 
                    x: { 
                        title: { display: true, text: 'm/z 值' }, 
                        ticks: { autoSkip: true, maxTicksLimit: 20 }
                    }, 
                    y: { 
                        title: { display: true, text: '强度' }, 
                        beginAtZero: true 
                    } 
                } 
            }
        });
        
        downloadMassSpectrumPngBtn.style.display = '';
        massSpectrumStatus.innerHTML = `<i class="fas fa-check-circle text-success"></i> 保留时间: ${rtValue.toFixed(2)} 分钟`;
    }

    function setViewResultButtonState(taskId, state, messageText){
        const btn = document.getElementById(`viewResultBtn-${taskId}`);
        if (!btn) return;
        switch(state){
            case 'loading': btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中'; break;
            case 'noresult': btn.disabled = false; btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> 无结果'; break;
            case 'error': btn.disabled = false; btn.innerHTML = '<i class="fas fa-times-circle"></i> 加载失败'; break;
            default: btn.disabled = false; btn.innerHTML = '<i class="fas fa-chart-line"></i> 查看结果';
        }
        if (messageText) btn.setAttribute('title', messageText);
    }

    function getResultCacheKey(task){ const aid = (task && task.archiveId) ? task.archiveId : 'na'; return `gcmsResult_${task.id}_${aid}`; }
    function saveResultToCache(task, series){ try{ const key = getResultCacheKey(task); resultCache[key] = series; localStorage.setItem(key, JSON.stringify(series)); }catch(e){} }
    function loadResultFromCache(task){ const key = getResultCacheKey(task); if (resultCache[key]) return resultCache[key]; try{ const s = localStorage.getItem(key); if (s){ const series = JSON.parse(s); resultCache[key] = series; return series; } }catch(e){} return null; }

    // 滑块事件监听
    retentionTimeSlider.addEventListener('input', function() {
        if (!chromatogramXData || chromatogramXData.length === 0) return;
        // 按“数据点索引”与滑块百分比对应，确保滚轴从色谱图横坐标起点开始，并精确对齐到某个采样点
        const n = chromatogramXData.length;
        const rawPercent = Math.max(0, Math.min(1, parseFloat(this.value) / 100));
        // 将滑块位置“吸附”到最近的数据点，保证滑块拇指与红线严格同一竖线
        const idx = Math.max(0, Math.min(n - 1, Math.round(rawPercent * (n - 1))));
        const snappedPercent = (idx / (n - 1)) * 100;
        // 回写滑块值（让拇指位置与数据点像素对齐）
        this.value = snappedPercent.toFixed(2);
        const rtValue = chromatogramXData[idx];
        
        // 更新显示（对齐到采样点）
        currentRtValue = rtValue;
        currentRetentionTimeDisplay.textContent = Number(rtValue).toFixed(2);

        // 更新色谱图中的竖直指示线（更新第二个数据集）
        try {
            const ds = resultChartInstance && resultChartInstance.data && resultChartInstance.data.datasets && resultChartInstance.data.datasets.find(d => d && d._isVLine);
            if (ds) {
                const yScale = resultChartInstance.scales && resultChartInstance.scales.y;
                const ymin = yScale ? yScale.min : Math.min(...chromatogramYData);
                const ymax = yScale ? yScale.max : Math.max(...chromatogramYData);
                ds.data = [ { x: rtValue, y: ymin }, { x: rtValue, y: ymax } ];
                resultChartInstance.update('none');
            }
        } catch(e) {}

        // 防抖后请求质谱
        clearTimeout(sliderTimeout);
        sliderTimeout = setTimeout(() => {
            if (activeSequenceIndex !== null) {
                massSpectrumStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载质谱数据中...';
                if (activeArchiveId) {
                    sendMessage(`get_mass_spectrum_${activeSequenceIndex}_${rtValue}_${activeArchiveId}`);
                } else {
                    sendMessage(`get_mass_spectrum_${activeSequenceIndex}_${rtValue}`);
                }
            }
        }, 300);
    });

    window.handleViewResult = function(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        // 仅允许“已完成”的任务查看结果
        if (task.statusCode !== 'completed') {
            addLog(`任务 ${task.displayId || ''} 尚未完成，无法查看结果`, 'warning');
            return;
        }
        resultModal.show();
        activeResultTaskId = taskId;
        activeSequenceIndex = task.sequenceIndex;
        activeBottleNum = task.bottleNum;
        activeArchiveId = task.archiveId || null;
        downloadMassSpectrumPngBtn.style.display = 'none';
        const cached = loadResultFromCache(task);
        if (cached && Array.isArray(cached.x) && Array.isArray(cached.y)){
            renderChromatogramChart(cached.x, cached.y, `序列 ${task.sequenceIndex} 结果（缓存）`);
            setViewResultButtonState(taskId, '');
            return;
        }
        showResultLoading('正在请求结果数据...');
        setViewResultButtonState(taskId, 'loading');
        if (task.archiveId){
            sendMessage(`get_result_${task.bottleNum}_${task.sequenceIndex}_${task.archiveId}`);
        } else {
            sendMessage(`get_result_${task.bottleNum}_${task.sequenceIndex}`);
        }
    }

    if (downloadChromatogramPngBtn){
        downloadChromatogramPngBtn.addEventListener('click', function(){
            if (!resultChartInstance) return;
            const link = document.createElement('a');
            link.href = resultChartInstance.toBase64Image();
            link.download = `gcms_chromatogram_${Date.now()}.png`;
            link.click();
        });
    }
    
    if (downloadMassSpectrumPngBtn){
        downloadMassSpectrumPngBtn.addEventListener('click', function(){
            if (!massSpectrumChartInstance) return;
            const link = document.createElement('a');
            link.href = massSpectrumChartInstance.toBase64Image();
            link.download = `gcms_mass_spectrum_${Date.now()}.png`;
            link.click();
        });
    }

    // Enhanced onmessage to update state array and handle queue（并写回数据库）
    socket.onmessage = async function(e) {
        const data = JSON.parse(e.data);
        const message = (data && data.message && typeof data.message === 'object' && data.message.type) ? data.message : data;
        addLog(`收到消息: ${JSON.stringify(message)}`, 'primary');

        const task = tasks.find(t => (
            t.bottleNum == message.bottle_num &&
            (message.sequence_index === undefined || t.sequenceIndex == message.sequence_index) &&
            t.statusCode !== 'completed' && t.statusCode !== 'failed'
        ));

        switch (message.type) {
            case 'worker_connected':
                gcmsStatus.textContent = message.status;
                armStatus.textContent = '待获取';
                break;
            case 'status_update':
                gcmsStatus.textContent = message.status;
                gcmsRunMode.textContent = message.run_mode || '未知';
                gcmsRunStatus.textContent = message.run_status || '未知';
                break;
            case 'arm_status':
                armStatus.textContent = message.status;
                break;
            case 'analysis_started':
                if (task) {
                    task.statusCode = 'task_started';
                    task.statusText = '任务开始';
                    task.statusClass = statusClassByCode('task_started');
                    task.startTime = Date.now();
                    await updateTaskOnServer(task.dbId, { status: 'task_started', startTime: task.startTime });
                }
                updatePositionStatus('running');
                startTotalRuntime();
                break;
            case 'analysis_progress':
                if (task) {
                    task.statusText = message.stage;
                    task.statusClass = 'bg-info text-dark';
                    const statusMap = { '设备准备':'device_preparation','机械臂操作':'arm_operation','仪器分析':'instrument_analysis','等待分析完成':'waiting_completion','设备复位':'device_reset' };
                    const code = statusMap[message.stage] || 'task_started';
                    task.statusCode = code;
                    await updateTaskOnServer(task.dbId, { status: code });
                }
                updatePositionStatus('running');
                break;
            case 'analysis_complete':
                if (task) {
                    task.statusCode = 'completed';
                    task.statusText = '已完成';
                    task.statusClass = statusClassByCode('completed');
                    task.runButtonHTML = '<i class="fas fa-redo"></i> 重新运行';
                    task.runButtonDisabled = false;
                    task.endTime = Date.now();
                    if (message.archive_id){ task.archiveId = message.archive_id; }
                    if (task.startTime) {
                        const durationSeconds = Math.round((task.endTime - task.startTime) / 1000);
                        const minutes = Math.floor(durationSeconds / 60);
                        const seconds = durationSeconds % 60;
                        task.duration = `${minutes}分${seconds}秒`;
                    }
                    await updateTaskOnServer(task.dbId, { status: 'completed', endTime: task.endTime, archiveId: task.archiveId });
                }
                isWorkerBusy = false;
                updatePositionStatus('complete');
                runNextTaskInQueue();
                stopTotalRuntime();
                break;
            case 'analysis_error':
                if (task) {
                    task.statusCode = 'failed';
                    task.statusText = '失败';
                    task.statusClass = statusClassByCode('failed');
                    task.runButtonHTML = '<i class="fas fa-redo"></i> 重试';
                    task.runButtonDisabled = false;
                    task.endTime = Date.now();
                    await updateTaskOnServer(task.dbId, { status: 'failed', endTime: task.endTime });
                }
                isWorkerBusy = false;
                updatePositionStatus('error');
                runNextTaskInQueue();
                stopTotalRuntime();
                break;
            case 'sequence_list':
                if (Array.isArray(message.items) && sequenceTableBody) {
                    sequenceMap = {};
                    message.items.forEach(it => { sequenceMap[String(it.index)] = it.name; });
                    if (message.items.length === 0) {
                        sequenceTableBody.innerHTML = '<tr><td colspan="2" class="text-muted">未发现任何序列</td></tr>';
                    } else {
                        sequenceTableBody.innerHTML = message.items.map(item => `
                            <tr>
                                <td>${item.index}</td>
                                <td>${item.name}</td>
                            </tr>
                        `).join('');
                    }
                    // 补全已有任务的序列名并回写数据库
                    tasks.forEach(async t => {
                        if (t.sequenceIndex != null && t.sequenceIndex !== '' && sequenceMap[String(t.sequenceIndex)]) {
                            const newName = sequenceMap[String(t.sequenceIndex)];
                            if (t.sequenceName !== newName){
                                t.sequenceName = newName;
                                await updateTaskOnServer(t.dbId, { sequenceName: newName });
                            }
                        }
                    });
                    renderTasks();
                }
                break;
            case 'analysis_result':
                if (!message.available) {
                    showResultMessage(message.message || '未找到结果文件');
                    if (activeResultTaskId) setViewResultButtonState(activeResultTaskId, 'noresult', message.message);
                } else if (message.series && Array.isArray(message.series.x) && Array.isArray(message.series.y)) {
                    const x = message.series.x; const y = message.series.y;
                    renderChromatogramChart(x, y, `序列 ${message.sequence_index} 结果`);
                    if (activeResultTaskId) {
                        const t = tasks.find(tt => tt.id === activeResultTaskId);
                        if (t) {
                            saveResultToCache(t, {x, y});
                        }
                        setViewResultButtonState(activeResultTaskId, '');
                        if (t && message.archive_id) {
                            t.archiveId = message.archive_id;
                            await updateTaskOnServer(t.dbId, { archiveId: t.archiveId });
                        }
                    }
                } else {
                    showResultMessage('结果数据格式不正确');
                    if (activeResultTaskId) setViewResultButtonState(activeResultTaskId, 'error');
                }
                break;
            case 'mass_spectrum_result':
                if (!message.available) {
                    massSpectrumStatus.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> ${message.message || '未找到质谱数据'}`;
                } else if (message.series && Array.isArray(message.series.mz) && Array.isArray(message.series.intensity)) {
                    const mz = message.series.mz;
                    const intensity = message.series.intensity;
                    renderMassSpectrumChart(mz, intensity, message.retention_time);
                } else {
                    massSpectrumStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> 质谱数据格式不正确';
                }
                break;
        }
        if (task) renderTasks();
    };

    // 面包屑高亮“GCMS”
    setTimeout(function() {
        var breadcrumb = document.querySelector('nav[aria-label="breadcrumb"] .breadcrumb');
        if (breadcrumb) {
            var links = breadcrumb.querySelectorAll('.breadcrumb-item a');
            var indicator = breadcrumb.querySelector('.breadcrumb-indicator');
            var target = null;
            for (var i = 0; i < links.length; i++) {
                if (links[i].textContent.trim() === 'GCMS') { target = links[i]; break; }
            }
            if (target) {
                links.forEach(function(a){ a.classList.remove('active'); });
                target.classList.add('active');
                if (indicator) {
                    indicator.style.width = target.offsetWidth + 'px';
                    indicator.style.transform = 'translateX(' + target.offsetLeft + 'px)';
                }
            }
        }
    }, 100);

    // 卡片折叠图标旋转
    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        element.addEventListener('click', function() {
            var icon = this.querySelector('.collapse-icon');
            var target = document.querySelector(this.getAttribute('data-bs-target'));
            setTimeout(function() {
                if (target && target.classList.contains('show')) {
                    icon.style.transform = 'rotate(0deg)';
                } else if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }, 50);
        });
    });

    // --- 位置状态 ---
    function updatePositionStatus(status) {
        if (!pos1Alert) return;
        switch (status) {
            case 'running':
                isWorkerBusy = true;
                isPositionManuallyOccupied = false;
                pos1Alert.className = 'alert alert-info py-2 mb-0';
                pos1Icon.className = 'fas fa-spinner fa-spin text-primary';
                pos1Text.textContent = '运行中';
                break;
            case 'error':
                isWorkerBusy = false;
                pos1Alert.className = 'alert alert-danger py-2 mb-0';
                pos1Icon.className = 'fas fa-exclamation-triangle text-danger';
                pos1Text.textContent = '运行失败';
                break;
            case 'manual_occupied':
                isPositionManuallyOccupied = true;
                pos1Alert.className = 'alert alert-warning py-2 mb-0';
                pos1Icon.className = 'fas fa-hand-paper text-warning';
                pos1Text.textContent = '手动占用';
                break;
            case 'idle':
            case 'complete':
            default:
                isWorkerBusy = false;
                isPositionManuallyOccupied = false;
                pos1Alert.className = 'alert alert-light py-2 mb-0';
                pos1Icon.className = 'fas fa-check-circle text-success';
                pos1Text.textContent = '位置空闲';
                break;
        }
    }
    pos1Card.addEventListener('click', () => {
        if (!isWorkerBusy) {
            if (isPositionManuallyOccupied) { updatePositionStatus('idle'); }
            else { updatePositionStatus('manual_occupied'); }
        }
    });

    // --- 全局运行时间管理 ---
    function updateTotalRuntimeDisplay() {
        const startTime = localStorage.getItem('gcmsTotalRuntimeStart');
        if (!startTime) {
            document.getElementById('runtimeHours').textContent = '0';
            document.getElementById('runtimeMinutes').textContent = '00';
            return;
        }
        const diff = Date.now() - parseInt(startTime, 10);
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById('runtimeHours').textContent = hours;
        document.getElementById('runtimeMinutes').textContent = String(minutes).padStart(2, '0');
    }
    function startTotalRuntime() {
        if (totalRuntimeInterval) return;
        if (!localStorage.getItem('gcmsTotalRuntimeStart')) { localStorage.setItem('gcmsTotalRuntimeStart', Date.now()); }
        updateTotalRuntimeDisplay();
        totalRuntimeInterval = setInterval(updateTotalRuntimeDisplay, 10000);
    }
    function stopTotalRuntime() {
        const isAnyTaskRunning = tasks.some(t => !['pending','queued','completed','failed'].includes(t.statusCode));
        if (!isAnyTaskRunning) {
            clearInterval(totalRuntimeInterval);
            totalRuntimeInterval = null;
            localStorage.removeItem('gcmsTotalRuntimeStart');
            updateTotalRuntimeDisplay();
            addLog('所有任务完成，总运行计时器已停止。', 'success');
        }
    }
});
</script>

<style>
.station-card, .position-card { 
    transition: all .3s ease; 
    border-width: 2px; 
}
.station-card:hover, .position-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(0,0,0,.1); 
}

.card-header:hover ~ .card-body .station-card,
.card-header:hover ~ .card-body .position-card {
    transform: none !important;
    box-shadow: none !important;
}

.card-header[data-bs-toggle="collapse"] { transition: none; }
.card-header[data-bs-toggle="collapse"]:hover { cursor: pointer; }

.card-header.bg-primary:hover { background-color: var(--bs-primary) !important; }
.card-header.bg-warning:hover { background-color: var(--bs-warning) !important; }
.card-header.bg-info:hover { background-color: var(--bs-info) !important; }

.position-card.border-light { border-color: #dee2e6 !important; }
.collapse-icon { transition: transform 0.3s ease; }

#gcmsStatusCard { border-left: 4px solid #0dcaf0; box-shadow: 0 2px 10px rgba(13, 202, 240, 0.1); }
#gcmsStatusCard .card-header { transition: background 0.3s ease; }

/* 结果弹窗布局（上下各占一半）*/
.results-body { max-height: 80vh; }
#resultContainer { display: flex; flex-direction: column; gap: 12px; height: 75vh; }
.section-half { flex: 1 1 0; display: flex; flex-direction: column; min-height: 0; }
.panel { background: #f8f9fa; border-radius: 8px; padding: 12px; flex: 1; display: flex; min-height: 0; }
.chart-canvas { width: 100%; height: 100% !important; }
/* 让上半区（色谱图）稍高一些，提升视觉效果 */
.section-top { flex: 0 0 62%; }
/* 下半区自动占剩余空间 */
.slider-wrap { padding: 0 4px; }
.slider-range-labels { font-size: 12px; color: #666; }
</style>
{% endblock %}
