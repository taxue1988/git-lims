{% extends 'admin/station_management.html' %}

{% block title %}GCMS - 工站管理{% endblock %}

{% block main_content %}
{{ block.super }}

<!-- 工站状态卡片 -->
<div class="card mb-4" id="gcmsStatusCard">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsStationStatus"
         aria-expanded="true" aria-controls="gcmsStationStatus" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-chart-line"></i> 工站状态</h4>
        <div class="d-flex align-items-center">
            <span class="badge bg-light text-dark me-2">实时监控</span>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsStationStatus">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="armStatusIcon" class="fas fa-hand-rock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">机械臂</h6>
                            <p id="armStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i id="gcmsStatusIcon" class="fas fa-vial text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">GCMS</h6>
                            <p id="gcmsStatus" class="mb-0 fw-bold text-secondary">连接中...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-clock text-secondary me-3 fa-lg"></i>
                        <div>
                            <h6 class="mb-1 text-muted">运行时间</h6>
                            <p class="mb-0 fw-bold"><span id="runtimeHours">0</span> 小时 <span id="runtimeMinutes">00</span> 分</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tasks text-info me-2"></i>
                            <span class="text-muted">待分析任务数</span>
                        </div>
                        <span class="badge bg-info" id="pendingAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span class="text-muted">已完成分析</span>
                        </div>
                        <span class="badge bg-success" id="completedAnalysis">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-light py-2 mb-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i id="connectionStatusIcon" class="fas fa-wifi text-danger me-2"></i>
                            <span class="text-muted">连接状态</span>
                        </div>
                        <span class="badge bg-danger" id="connectionStatus">离线</span>
                    </div>
                </div>
            </div>
            
            <!-- 控制按钮区域 -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button id="refreshStatusBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i>刷新状态
                        </button>
                        <button id="getArmStatusBtn" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-hand-rock me-1"></i>机械臂状态
                        </button>
                        <button id="moveTowerBtn" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-arrows-alt me-1"></i>移动塔位置
                        </button>
                        <button id="getInstrumentInfoBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-info-circle me-1"></i>仪器信息
                        </button>
                        <div class="input-group" style="width: 200px;">
                            <input type="number" id="bottleNumInput" class="form-control form-control-sm" 
                                   placeholder="瓶号" min="1" max="100" value="1">
                            <button id="startAnalysisBtn" class="btn btn-success btn-sm">
                                <i class="fas fa-play me-1"></i>开始分析
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志卡片 -->
<div class="card mt-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsLogs"
         aria-expanded="true" aria-controls="gcmsLogs" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-terminal"></i> 实时日志</h4>
        <div class="d-flex align-items-center">
            <button id="clearLogsBtn" class="btn btn-outline-light btn-sm me-2" onclick="event.stopPropagation();">
                <i class="fas fa-trash"></i> 清空
            </button>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="gcmsLogs">
        <div class="card-body p-0">
            <div id="logContainer" class="log-container" style="height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">
                <div class="log-entry text-info">
                    <span class="timestamp">[系统]</span> 等待连接到 GCMS Worker...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 当前仓位卡片 -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsPositions"
         aria-expanded="true" aria-controls="gcmsPositions" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-boxes"></i> 当前仓位（1）</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="gcmsPositions">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100 position-card border-light">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary">仓位 1</h5>
                            <p class="card-text text-muted small">GCMS 工站</p>
                            <div class="position-status">
                                <div class="alert alert-light py-2 mb-0">
                                    <i class="fas fa-circle"></i>
                                    <span class="text-muted">位置空闲</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GCMS 分析任务列表卡片 -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#gcmsTasks"
         aria-expanded="true" aria-controls="gcmsTasks" style="cursor: pointer;">
        <h4 class="mb-0"><i class="fas fa-tasks"></i> GCMS 分析任务列表</h4>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse show" id="gcmsTasks">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>实验任务ID</th>
                            <th>实验名称</th>
                            <th>创建时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                暂无任务
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const logContainer = document.getElementById('logContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionStatusIcon = document.getElementById('connectionStatusIcon');
    const armStatus = document.getElementById('armStatus');
    const gcmsStatus = document.getElementById('gcmsStatus');

    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry text-${type}`;
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    const socket = new WebSocket('ws://' + window.location.host + '/ws/gcms/');

    socket.onopen = function(e) {
        addLog('成功连接到 WebSocket 服务器', 'success');
        connectionStatus.textContent = '在线';
        connectionStatus.className = 'badge bg-success';
        connectionStatusIcon.className = 'fas fa-wifi text-success me-2';
        // 请求初始状态
        sendMessage('get_status');
    };

    socket.onclose = function(e) {
        addLog('WebSocket 连接已断开', 'danger');
        connectionStatus.textContent = '离线';
        connectionStatus.className = 'badge bg-danger';
        connectionStatusIcon.className = 'fas fa-wifi text-danger me-2';
    };

    socket.onerror = function(e) {
        addLog('WebSocket 连接发生错误', 'danger');
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.sender;

        addLog(`收到消息: ${JSON.stringify(message)}`, 'primary');

        if (sender === 'worker') {
            if (message.type === 'worker_connected') {
                gcmsStatus.textContent = message.status;
                armStatus.textContent = '待获取';
            } else if (message.type === 'status_update') {
                gcmsStatus.textContent = message.status;
            } else if (message.type === 'arm_status') {
                armStatus.textContent = message.status;
            }
        }
    };

    function sendMessage(command) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({'message': command}));
            addLog(`发送指令: ${command}`, 'info');
        } else {
            addLog('WebSocket 未连接，无法发送指令', 'warning');
        }
    }

    document.getElementById('refreshStatusBtn').addEventListener('click', () => sendMessage('get_status'));
    document.getElementById('getArmStatusBtn').addEventListener('click', () => sendMessage('get_arm_status'));
    document.getElementById('moveTowerBtn').addEventListener('click', () => sendMessage('move_tower'));
    document.getElementById('getInstrumentInfoBtn').addEventListener('click', () => sendMessage('get_instrument_info'));
    document.getElementById('startAnalysisBtn').addEventListener('click', () => {
        const bottleNum = document.getElementById('bottleNumInput').value;
        if (bottleNum) {
            sendMessage(`start_analysis_${bottleNum}`);
        }
    });
    document.getElementById('clearLogsBtn').addEventListener('click', () => {
        logContainer.innerHTML = '';
        addLog('日志已清空', 'info');
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 面包屑高亮“GCMS”
    var breadcrumb = document.querySelector('nav[aria-label="breadcrumb"] .breadcrumb');
    if (breadcrumb) {
        var links = breadcrumb.querySelectorAll('.breadcrumb-item a');
        var indicator = breadcrumb.querySelector('.breadcrumb-indicator');
        var target = null;
        for (var i = 0; i < links.length; i++) {
            if (links[i].textContent.trim() === 'GCMS') { target = links[i]; break; }
        }
        if (target) {
            links.forEach(function(a){ a.classList.remove('active'); });
            target.classList.add('active');
            if (indicator) {
                indicator.style.width = target.offsetWidth + 'px';
                indicator.style.transform = 'translateX(' + target.offsetLeft + 'px)';
            }
        }
    }

    // 卡片折叠图标旋转
    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        element.addEventListener('click', function() {
            var icon = this.querySelector('.collapse-icon');
            var target = document.querySelector(this.getAttribute('data-bs-target'));
            setTimeout(function() {
                if (target && target.classList.contains('show')) {
                    icon.style.transform = 'rotate(0deg)';
                } else if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
            }, 50);
        });
    });

    // 运行时间示例计时器（每分钟+1 分）
    var minutes = 0;
    var hours = 0;
    function updateRuntime() {
        minutes += 1;
        if (minutes >= 60) { hours += 1; minutes = 0; }
        var m = minutes < 10 ? '0' + minutes : String(minutes);
        var hoursEl = document.getElementById('runtimeHours');
        var minutesEl = document.getElementById('runtimeMinutes');
        if (hoursEl && minutesEl) {
            hoursEl.textContent = String(hours);
            minutesEl.textContent = m;
        }
    }
    setInterval(updateRuntime, 60000);
});
</script>

<style>
.station-card, .position-card { 
    transition: all .3s ease; 
    border-width: 2px; 
}
.station-card:hover, .position-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(0,0,0,.1); 
}

.card-header:hover ~ .card-body .station-card,
.card-header:hover ~ .card-body .position-card {
    transform: none !important;
    box-shadow: none !important;
}

.card-header[data-bs-toggle="collapse"] { transition: none; }
.card-header[data-bs-toggle="collapse"]:hover { cursor: pointer; }

.card-header.bg-primary:hover { background-color: var(--bs-primary) !important; }
.card-header.bg-warning:hover { background-color: var(--bs-warning) !important; }
.card-header.bg-info:hover { background-color: var(--bs-info) !important; }

.position-card.border-light { border-color: #dee2e6 !important; }
.collapse-icon { transition: transform 0.3s ease; }

#gcmsStatusCard { border-left: 4px solid #0dcaf0; box-shadow: 0 2px 10px rgba(13, 202, 240, 0.1); }
#gcmsStatusCard .card-header { transition: background 0.3s ease; }
</style>
{% endblock %}


