{% extends 'admin_base.html' %}

{% block title %}管理员仪表板 - 自动实验管理系统{% endblock %}

{% block sidebar_menu %}
<li class="nav-item mb-3">
    <a href="{% url 'admin_dashboard' %}" class="nav-link active bg-primary rounded shadow">
        <i class="fas fa-tachometer-alt fa-lg me-3"></i>
        <span class="text-white fw-bold">仪表板</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="{% url 'admin_experiment_tasks' %}" class="nav-link rounded hover-bg-light">
        <i class="fas fa-vials fa-lg me-3 text-primary"></i>
        <span class="text-white">实验任务</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="{% url 'admin_material_requirements' %}" class="nav-link rounded hover-bg-light">
        <i class="fas fa-boxes fa-lg me-3 text-warning"></i>
        <span class="text-white">物料需求</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="{% url 'admin_user_management' %}" class="nav-link rounded hover-bg-light">
        <i class="fas fa-users fa-lg me-3 text-success"></i>
        <span class="text-white">用户管理</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="{% url 'admin_equipment_management' %}" class="nav-link rounded hover-bg-light">
        <i class="fas fa-flask fa-lg me-3 text-info"></i>
        <span class="text-white">设备管理</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="#" class="nav-link rounded hover-bg-light">
        <i class="fas fa-chart-bar fa-lg me-3 text-warning"></i>
        <span class="text-white">数据统计</span>
    </a>
</li>
<li class="nav-item mb-3">
    <a href="#" class="nav-link rounded hover-bg-light">
        <i class="fas fa-cog fa-lg me-3 text-secondary"></i>
        <span class="text-white">系统设置</span>
    </a>
</li>
{% endblock %}

{% block main_content %}
<h1 class="h3 mb-4 text-gray-800">管理员仪表板</h1>

<style>
    .admin-stats-row {
        display: grid;
        grid-template-columns: repeat(8, minmax(140px, 1fr));
        gap: 6px;
    }
    .admin-stat-col { min-width: 0; }
    .admin-stat-card .card-body { padding: 0.45rem 0.6rem; }
    .admin-stat-card .text-xs { font-size: 0.7rem; }
    .admin-stat-card .h5 { font-size: 0.95rem; margin: 0; }
    .admin-stat-card i { font-size: 1rem !important; }
    @media (max-width: 1400px) { .admin-stats-row { grid-template-columns: repeat(8, minmax(120px, 1fr)); } }
    @media (max-width: 1200px) { .admin-stats-row { grid-template-columns: repeat(6, minmax(120px, 1fr)); } }
    @media (max-width: 992px)  { .admin-stats-row { grid-template-columns: repeat(4, minmax(120px, 1fr)); } }
    @media (max-width: 768px)  { .admin-stats-row { grid-template-columns: repeat(3, minmax(120px, 1fr)); } }
    @media (max-width: 576px)  { .admin-stats-row { grid-template-columns: 1fr; } }
    .border-left-primary { border-left: 0.25rem solid #4e73df !important; }
    .border-left-info { border-left: 0.25rem solid #36b9cc !important; }
    .border-left-warning { border-left: 0.25rem solid #f6c23e !important; }
    .border-left-success { border-left: 0.25rem solid #1cc88a !important; }
    .border-left-danger { border-left: 0.25rem solid #e74a3b !important; }
    .border-left-dark { border-left: 0.25rem solid #5a5c69 !important; }
    .bg-secondary,.bg-info,.bg-warning,.bg-success,.bg-danger,.bg-primary { color: #fff; }
</style>

<!-- 统计卡片行：单行自适应网格 -->
<div class="admin-stats-row mb-4">
    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            总任务数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            待审核
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            已通过
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ approved_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            已排程
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ scheduled_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            进行中
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ in_progress_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-spinner fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            已完成
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completed_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            已驳回
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ rejected_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-stat-col">
        <div class="card admin-stat-card border-left-dark shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                            已取消
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ cancelled_tasks }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-ban fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主要内容区域：仅显示用户任务统计，简化界面 -->
<div class="row">
    <!-- 用户任务统计 -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">用户任务统计</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>用户</th>
                                <th>总任务</th>
                                <th>待审核</th>
                                <th>已通过</th>
                                <th>已排程</th>
                                <th>进行中</th>
                                <th>已完成</th>
                                <th>已驳回</th>
                                <th>已取消</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_stat in user_stats %}
                            <tr>
                                <td class="fw-bold">{{ user_stat.created_by__username }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="">
                                        {{ user_stat.total }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="待审核">
                                        {{ user_stat.pending }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="已通过">
                                        {{ user_stat.approved }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="已排程">
                                        {{ user_stat.scheduled }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="进行中">
                                        {{ user_stat.in_progress }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="已完成">
                                        {{ user_stat.completed }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="已驳回">
                                        {{ user_stat.rejected }}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-dark user-filter-btn" 
                                            data-username="{{ user_stat.created_by__username }}" 
                                            data-status="已取消">
                                        {{ user_stat.cancelled }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 工站使用统计 -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">工站使用统计</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2 mb-3">
                        <div class="border-end">
                            <h4 class="text-primary">{{ station_stats.solid_liquid|default:0 }}</h4>
                            <small class="text-muted">固液分离</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="border-end">
                            <h4 class="text-success">{{ station_stats.glovebox|default:0 }}</h4>
                            <small class="text-muted">手套箱</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="border-end">
                            <h4 class="text-warning">{{ station_stats.reaction|default:0 }}</h4>
                            <small class="text-muted">反应器</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="border-end">
                            <h4 class="text-info">{{ station_stats.gcms|default:0 }}</h4>
                            <small class="text-muted">GC-MS</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="border-end">
                            <h4 class="text-secondary">{{ station_stats.evaporation|default:0 }}</h4>
                            <small class="text-muted">蒸发器</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <h4 class="text-dark">{{ station_stats.tlc|default:0 }}</h4>
                        <small class="text-muted">TLC</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- 批量操作确认模态框 -->
<div class="modal fade" id="batch-operation-modal" tabindex="-1" aria-labelledby="batch-operation-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batch-operation-title">批量操作确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p>您即将对 <span id="selected-count" class="fw-bold text-primary">0</span> 个任务执行 <span id="operation-type" class="fw-bold text-warning">操作</span></p>
                </div>
                <div class="mb-3">
                    <label for="admin-remark" class="form-label">管理员备注（可选）</label>
                    <textarea class="form-control" id="admin-remark" rows="3" placeholder="请输入备注信息..."></textarea>
                </div>
                <div class="mb-3" id="reject-reason-group" style="display: none;">
                    <label for="reject-reason" class="form-label">驳回原因 <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="reject-reason" rows="3" placeholder="请输入驳回原因..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-batch-operation">确认执行</button>
            </div>
        </div>
    </div>
</div>

<!-- 单个任务操作模态框 -->
<div class="modal fade" id="single-operation-modal" tabindex="-1" aria-labelledby="single-operation-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="single-operation-title">任务操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p>任务ID: <span id="single-task-id" class="fw-bold"></span></p>
                    <p>任务名称: <span id="single-task-name" class="fw-bold"></span></p>
                    <p>当前状态: <span id="single-task-status" class="fw-bold"></span></p>
                </div>
                <div class="mb-3">
                    <label for="single-new-status" class="form-label">新状态</label>
                    <select class="form-select" id="single-new-status">
                        <option value="已通过">已通过</option>
                        <option value="已驳回">已驳回</option>
                        <option value="进行中">进行中</option>
                        <option value="已完成">已完成</option>
                        <option value="已取消">已取消</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="single-admin-remark" class="form-label">管理员备注（可选）</label>
                    <textarea class="form-control" id="single-admin-remark" rows="3" placeholder="请输入备注信息..."></textarea>
                </div>
                <div class="mb-3" id="single-reject-reason-group" style="display: none;">
                    <label for="single-reject-reason" class="form-label">驳回原因 <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="single-reject-reason" rows="3" placeholder="请输入驳回原因..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-single-operation">确认执行</button>
            </div>
        </div>
    </div>
</div>

<!-- 操作结果提示模态框 -->
<div class="modal fade" id="operation-result-modal" tabindex="-1" aria-labelledby="operation-result-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="operation-result-title">操作结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="operation-result-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    let currentUsername = '';
    let currentStatus = '';
    let currentPage = 1;
    let currentBatchOperation = null;
    let currentSingleTask = null;

    // 页面加载完成后初始化
    $(document).ready(function() {
        console.log('页面加载完成，开始初始化...');
        
        // 加载所有任务
        loadTasks();
        
        // 绑定用户筛选按钮事件
        $(document).on('click', '.user-filter-btn', function() {
            console.log('用户筛选按钮被点击');
            const username = $(this).data('username');
            const status = $(this).data('status');
            
            console.log('筛选条件:', { username, status });
            
            // 更新当前筛选条件
            currentUsername = username;
            currentStatus = status;
            currentPage = 1;
            
            // 更新筛选信息显示
            updateFilterInfo();
            
            // 加载筛选后的任务
            loadTasks();
            
            // 更新按钮状态
            $('.user-filter-btn').removeClass('active');
            $(this).addClass('active');
        });
        
        // 绑定状态筛选事件
        $('#status-filter').on('change', function() {
            currentStatus = $(this).val();
            currentPage = 1;
            updateFilterInfo();
            loadTasks();
        });
        
        // 绑定搜索事件
        $('#search-btn').on('click', function() {
            currentPage = 1;
            loadTasks();
        });
        
        // 绑定回车搜索
        $('#search-input').on('keypress', function(e) {
            if (e.which === 13) {
                currentPage = 1;
                loadTasks();
            }
        });
        
        // 全选/取消全选
        $('#select-all').on('change', function() {
            const checkboxes = $('.task-checkbox');
            checkboxes.prop('checked', this.checked);
        });
        
        // 批量审核按钮
        $('#batch-approve-btn').on('click', function() {
            const selectedTasks = $('.task-checkbox:checked').map(function() {
                return $(this).val();
            }).get();
            
            if (selectedTasks.length === 0) {
                showAlert('请选择要审核的任务', 'warning');
                return;
            }
            
            showBatchOperationModal('审核通过', '已通过', selectedTasks);
        });
        
        // 批量驳回按钮
        $('#batch-reject-btn').on('click', function() {
            const selectedTasks = $('.task-checkbox:checked').map(function() {
                return $(this).val();
            }).get();
            
            if (selectedTasks.length === 0) {
                showAlert('请选择要驳回的任务', 'warning');
                return;
            }
            
            showBatchOperationModal('批量驳回', '已驳回', selectedTasks);
        });
        
        // 确认批量操作
        $('#confirm-batch-operation').on('click', function() {
            if (currentBatchOperation) {
                executeBatchOperation();
            }
        });
        
        // 确认单个操作
        $('#confirm-single-operation').on('click', function() {
            if (currentSingleTask) {
                executeSingleOperation();
            }
        });
        
        // 监听状态选择变化
        $('#single-new-status').on('change', function() {
            const newStatus = $(this).val();
            if (newStatus === '已驳回') {
                $('#single-reject-reason-group').show();
            } else {
                $('#single-reject-reason-group').hide();
            }
        });
    });

    // 显示批量操作模态框
    function showBatchOperationModal(operationType, newStatus, taskIds) {
        currentBatchOperation = {
            type: operationType,
            status: newStatus,
            taskIds: taskIds
        };
        
        $('#operation-type').text(operationType);
        $('#selected-count').text(taskIds.length);
        
        // 如果是驳回操作，显示驳回原因输入框
        if (newStatus === '已驳回') {
            $('#reject-reason-group').show();
        } else {
            $('#reject-reason-group').hide();
        }
        
        // 清空输入框
        $('#admin-remark').val('');
        $('#reject-reason').val('');
        
        const modal = new bootstrap.Modal(document.getElementById('batch-operation-modal'));
        modal.show();
    }

    // 执行批量操作
    function executeBatchOperation() {
        if (!currentBatchOperation) return;
        
        const { status, taskIds } = currentBatchOperation;
        const adminRemark = $('#admin-remark').val();
        const rejectReason = $('#reject-reason').val();
        
        // 如果是驳回操作，必须填写驳回原因
        if (status === '已驳回' && !rejectReason.trim()) {
            showAlert('驳回操作必须填写驳回原因', 'danger');
            return;
        }
        
        // 显示加载状态
        $('#confirm-batch-operation').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 执行中...');
        
        // 发送AJAX请求
        $.ajax({
            url: '/api/batch-update-tasks/',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            data: JSON.stringify({
                task_ids: taskIds,
                status: status,
                admin_remark: adminRemark,
                reason: rejectReason
            }),
            success: function(response) {
                console.log('批量操作响应:', response);
                if (response.ok) {
                    showOperationResult('success', `成功${currentBatchOperation.type} ${response.updated_count} 个任务`);
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('batch-operation-modal')).hide();
                    // 重新加载任务列表
                    loadTasks();
                } else {
                    showOperationResult('danger', `操作失败: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error('批量操作错误:', {xhr, status, error});
                let errorMsg = '网络错误';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch (e) {
                    console.error('解析错误响应失败:', e);
                }
                showOperationResult('danger', `操作失败: ${errorMsg}`);
            },
            complete: function() {
                $('#confirm-batch-operation').prop('disabled', false).html('确认执行');
            }
        });
    }

    // 显示单个任务操作模态框
    function showSingleOperationModal(taskId, taskName, currentStatus) {
        currentSingleTask = {
            id: taskId,
            name: taskName,
            currentStatus: currentStatus
        };
        
        $('#single-task-id').text(taskId);
        $('#single-task-name').text(taskName);
        $('#single-task-status').text(currentStatus);
        $('#single-new-status').val('已通过'); // 默认选择已通过
        $('#single-admin-remark').val('');
        $('#single-reject-reason').val('');
        $('#single-reject-reason-group').hide();
        
        const modal = new bootstrap.Modal(document.getElementById('single-operation-modal'));
        modal.show();
    }

    // 执行单个任务操作
    function executeSingleOperation() {
        if (!currentSingleTask) return;
        
        const taskId = currentSingleTask.id;
        const newStatus = $('#single-new-status').val();
        const adminRemark = $('#single-admin-remark').val();
        const rejectReason = $('#single-reject-reason').val();
        
        // 如果是驳回操作，必须填写驳回原因
        if (newStatus === '已驳回' && !rejectReason.trim()) {
            showAlert('驳回操作必须填写驳回原因', 'danger');
            return;
        }
        
        // 显示加载状态
        $('#confirm-single-operation').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 执行中...');
        
        // 发送AJAX请求
        $.ajax({
            url: `/api/task/${taskId}/update/`,
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            data: JSON.stringify({
                status: newStatus,
                admin_remark: adminRemark,
                reason: rejectReason
            }),
            success: function(response) {
                console.log('单个操作响应:', response);
                if (response.ok) {
                    showOperationResult('success', `任务状态已更新为 ${newStatus}`);
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('single-operation-modal')).hide();
                    // 重新加载任务列表
                    loadTasks();
                } else {
                    showOperationResult('danger', `操作失败: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error('单个操作错误:', {xhr, status, error});
                let errorMsg = '网络错误';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch (e) {
                    console.error('解析错误响应失败:', e);
                }
                showOperationResult('danger', `操作失败: ${errorMsg}`);
            },
            complete: function() {
                $('#confirm-single-operation').prop('disabled', false).html('确认执行');
            }
        });
    }

    // 显示操作结果
    function showOperationResult(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        
        $('#operation-result-content').html(`
            <div class="alert ${alertClass} mb-0">
                <i class="${iconClass} me-2"></i>
                ${message}
            </div>
        `);
        
        const modal = new bootstrap.Modal(document.getElementById('operation-result-modal'));
        modal.show();
    }

    // 加载任务数据
    function loadTasks() {
        console.log('开始加载任务数据...');
        const searchTerm = $('#search-input').val();
        
        // 构建查询参数
        const params = new URLSearchParams({
            page: currentPage
        });
        
        if (currentUsername) {
            params.append('username', currentUsername);
        }
        
        if (currentStatus) {
            params.append('status', currentStatus);
        }
        
        if (searchTerm) {
            params.append('search', searchTerm);
        }
        
        console.log('请求参数:', params.toString());
        
        // 显示加载状态
        $('#tasks-table-body').html('<tr><td colspan="7" class="text-center">加载中...</td></tr>');
        
        // 发送AJAX请求
        $.ajax({
            url: '/api/filter-tasks/',
            method: 'GET',
            data: params.toString(),
            dataType: 'json',
            success: function(response) {
                console.log('API响应:', response);
                if (response.ok) {
                    renderTasks(response.tasks);
                    renderPagination(response);
                } else {
                    $('#tasks-table-body').html('<tr><td colspan="7" class="text-center text-danger">加载失败: ' + response.message + '</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX错误:', error);
                $('#tasks-table-body').html('<tr><td colspan="7" class="text-center text-danger">网络错误: ' + error + '</td></tr>');
            }
        });
    }

    // 渲染任务列表
    function renderTasks(tasks) {
        console.log('渲染任务列表:', tasks);
        if (tasks.length === 0) {
            $('#tasks-table-body').html('<tr><td colspan="7" class="text-center">暂无任务</td></tr>');
            return;
        }
        
        let html = '';
        tasks.forEach(function(task) {
            const statusClass = getStatusClass(task.status);
            html += `
                <tr>
                    <td>
                        <input type="checkbox" class="task-checkbox" value="${task.id}">
                    </td>
                    <td>${task.id}</td>
                    <td title="${task.remark}">${task.name}</td>
                    <td>${task.created_by}</td>
                    <td>
                        <span class="badge ${statusClass}">${task.status}</span>
                    </td>
                    <td>${task.created_at}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewTask('${task.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="approveTask('${task.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="rejectTask('${task.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="showSingleOperationModal('${task.id}', '${task.name}', '${task.status}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        $('#tasks-table-body').html(html);
    }

    // 渲染分页
    function renderPagination(data) {
        if (data.total_pages <= 1) {
            $('#pagination-nav').hide();
            return;
        }
        
        let html = '';
        
        // 上一页
        if (data.has_previous) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${data.current_page - 1})">&laquo;</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">&laquo;</span></li>`;
        }
        
        // 页码
        for (let i = 1; i <= data.total_pages; i++) {
            if (i === data.current_page) {
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
            }
        }
        
        // 下一页
        if (data.has_next) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${data.current_page + 1})">&raquo;</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">&raquo;</span></li>`;
        }
        
        $('#pagination-ul').html(html);
        $('#pagination-nav').show();
    }

    // 跳转到指定页面
    function goToPage(page) {
        currentPage = page;
        loadTasks();
    }

    // 更新筛选信息显示
    function updateFilterInfo() {
        let info = '';
        if (currentUsername) {
            info += `用户: ${currentUsername}`;
        }
        if (currentStatus) {
            if (info) info += ' | ';
            info += `状态: ${currentStatus}`;
        }
        if (!info) {
            info = '所有任务';
        }
        $('#current-filter-info').text(info);
    }

    // 获取状态对应的CSS类
    function getStatusClass(status) {
        switch (status) {
            case '待审核': return 'bg-info';
            case '进行中': return 'bg-warning';
            case '已完成': return 'bg-success';
            case '已驳回': return 'bg-danger';
            case '已通过': return 'bg-primary';
            default: return 'bg-secondary';
        }
    }

    // 任务操作函数
    function viewTask(taskId) {
        console.log('查看任务:', taskId);
        showAlert('查看任务详情功能待实现', 'info');
    }

    function approveTask(taskId) {
        if (confirm('确定要审核通过这个任务吗？')) {
            showSingleOperationModal(taskId, '任务', '待审核');
        }
    }

    function rejectTask(taskId) {
        if (confirm('确定要驳回这个任务吗？')) {
            showSingleOperationModal(taskId, '任务', '待审核');
            setTimeout(() => {
                $('#single-new-status').val('已驳回').trigger('change');
            }, 100);
        }
    }
</script>
{% endblock %}
