{% extends 'admin_base.html' %}
{% load static %}

{% block title %}工站管理 - 自动实验管理系统{% endblock %}

{% block main_content %}
  <!-- 工站管理页面样式 -->
  <style>
    /* 覆盖Bootstrap样式，确保Tailwind正常工作 */
    .station-management-container * {
      box-sizing: border-box;
    }
    
    .station-management-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    /* 工站选项卡样式 */
    .station-tabs {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 0.5rem;
    }
    
    .station-tabs nav {
      display: flex;
      gap: 1.5rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    .station-tabs nav::-webkit-scrollbar {
      height: 6px;
    }
    
    .station-tabs nav::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 3px;
    }
    
    .station-tabs nav::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    
    .station-tabs nav::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }
    
    .tab-item {
      color: #6b7280;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 1.125rem;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.3s ease;
      text-decoration: none;
      border: 2px solid transparent;
      background: none;
      cursor: pointer;
      position: relative;
      display: inline-block;
    }
    
    .tab-item:hover {
      color: #2563eb;
      background-color: #f3f4f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab-item.active {
      color: #2563eb;
      background-color: #dbeafe;
      border-color: #3b82f6;
      font-weight: 600;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
    }
    
    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background-color: #2563eb;
      border-radius: 2px;
    }
    
    /* 工站内容区域 */
    .station-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    
    .station-content.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }
    
    .station-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
    }
    
    .station-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    
    /* 表单样式 */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      color: #374151;
      font-size: 0.875rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #374151;
      background-color: white;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #374151;
      background-color: white;
      resize: vertical;
      min-height: 120px;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #374151;
      background-color: white;
    }
    
    .form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* 按钮样式 */
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.5;
      text-align: center;
      text-decoration: none;
      border: 1px solid transparent;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }
    
    .btn-primary {
      color: white;
      background-color: #3b82f6;
      border-color: #3b82f6;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
      border-color: #2563eb;
    }
    
    .btn-success {
      color: white;
      background-color: #10b981;
      border-color: #10b981;
    }
    
    .btn-success:hover {
      background-color: #059669;
      border-color: #059669;
    }
    
    .btn-danger {
      color: #dc2626;
      background-color: transparent;
      border-color: transparent;
    }
    
    .btn-danger:hover {
      color: #b91c1c;
    }
    
    /* 网格布局 */
    .grid {
      display: grid;
      gap: 1rem;
    }
    
    .grid-cols-1 {
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    
    .grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    @media (min-width: 768px) {
      .md\\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    
    /* 间距工具类 */
    .space-y-4 > * + * {
      margin-top: 1rem;
    }
    
    .space-y-6 > * + * {
      margin-top: 1.5rem;
    }
    
    .space-x-4 > * + * {
      margin-left: 1rem;
    }
    
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mr-2 { margin-right: 0.5rem; }
    
    /* 试剂行样式 */
    .reagent-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .reagent-name-input {
      flex: 1;
    }
    
    .w-24 {
      width: 6rem;
    }
    
    /* 隐藏类 */
    .hidden {
      display: none;
    }
    
    /* 提交按钮区域 */
    .submit-area {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      margin-top: 1.5rem;
      border-radius: 0.5rem;
      text-align: center;
    }
  </style>

  <div class="station-management-container">
    <!-- 顶部导航/工站选项卡 -->
    <div class="station-tabs">
      <nav>
        <a class="tab-item" data-tab="batching" href="javascript:void(0);">
          配料
        </a>
        <a class="tab-item" data-tab="reaction" href="javascript:void(0);">
          反应
        </a>
        <a class="tab-item" data-tab="tlc" href="javascript:void(0);">
          点板
        </a>
        <a class="tab-item" data-tab="column" href="javascript:void(0);">
          过柱
        </a>
        <a class="tab-item" data-tab="filtration" href="javascript:void(0);">
          抽滤分液
        </a>
        <a class="tab-item" data-tab="rotaryEvaporation" href="javascript:void(0);">
          旋蒸
        </a>
        <a class="tab-item" data-tab="gcms" href="javascript:void(0);">
          GCMS
        </a>
        <a class="tab-item" data-tab="hplc" href="javascript:void(0);">
          HPLC
        </a>
      </nav>
    </div>
    
    <!-- 主内容区域 -->
    <div class="station-content" id="batching-content">
      <h2>配料工站</h2>
      <div class="space-y-6">
        <!-- 试剂添加栏 -->
        <div>
          <h3>试剂添加</h3>
          <div class="space-y-4" id="batching-reagents-container">
            <!-- 初始试剂输入行 -->
            <div class="reagent-row">
              <input
                class="form-input reagent-name-input"
                list="reagent-suggestions" 
                placeholder="试剂名称" 
                type="text" />
              <datalist id="reagent-suggestions">
              </datalist>
              <input
                class="form-input w-24"
                placeholder="用量" 
                type="number" />
              <select class="form-select w-24">
                <option value="g">克 (g)</option>
                <option value="ml">毫升 (ml)</option>
                <option value="mol">摩尔 (mol)</option>
              </select>
              <button class="btn btn-danger remove-reagent-btn" type="button">
                <i class="fas fa-minus-circle"></i>
              </button>
            </div>
          </div>
          <button
            class="btn btn-primary mt-4"
            id="add-batching-reagent-btn" 
            type="button">
            <i class="fas fa-plus mr-2"></i>
            添加试剂
          </button>
        </div>
      </div>
    </div>
    <div class="station-content hidden" id="reaction-content">
      <h2>反应工站</h2>
      <div class="space-y-6">
        <div>
          <h3>反应条件</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="reaction-temperature">
                温度 (°C):
              </label>
              <input
                class="form-input"
                id="reaction-temperature" 
                placeholder="例如: 25" 
                type="number" />
            </div>
            <div class="form-group">
              <label class="form-label" data-yteditvalue="反应时长 (分钟):" for="reaction-time">
                反应时长 (分钟):
              </label>
              <input
                class="form-input"
                id="reaction-time" 
                placeholder="例如: 4" 
                type="number" />
            </div>
            <div class="form-group">
              <label class="form-label" for="reaction-stirring-speed">
                搅拌速度 (rpm/min):
              </label>
              <input
                class="form-input"
                id="reaction-stirring-speed" 
                placeholder="例如: 300" 
                type="number" />
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="station-content hidden" id="tlc-content">
      <h2>点板工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="tlc-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="tlc-steps" 
            placeholder="请详细描述点板的实验步骤，包括展开剂、显色方法等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>点板结果记录</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="tlc-solvent">
                展开剂:
              </label>
              <input
                class="form-input"
                id="tlc-solvent" 
                placeholder="例如: 乙酸乙酯:石油醚 = 1:3" 
                type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="tlc-rf">
                Rf 值:
              </label>
              <input
                class="form-input"
                id="tlc-rf" 
                placeholder="例如: 0.5, 0.8" 
                type="text" />
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="station-content hidden" id="column-content">
      <h2>过柱工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="column-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="column-steps" 
            placeholder="请详细描述过柱的实验步骤，包括填料、洗脱剂梯度等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>过柱参数</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="column-packing">
                填料:
              </label>
              <input
                class="form-input"
                id="column-packing" 
                placeholder="例如: 硅胶 (200-300目)" 
                type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="column-eluent">
                洗脱剂:
              </label>
              <input
                class="form-input"
                id="column-eluent" 
                placeholder="例如: 乙酸乙酯/石油醚" 
                type="text" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="station-content hidden" id="filtration-content">
      <h2>抽滤分液工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="filtration-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="filtration-steps" 
            placeholder="请详细描述抽滤分液的实验步骤，包括溶剂选择、操作要点等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>分液参数</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="filtration-solvent1">
                有机相溶剂:
              </label>
              <input
                class="form-input"
                id="filtration-solvent1" 
                placeholder="例如: 乙酸乙酯" 
                type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="filtration-solvent2">
                水相溶剂:
              </label>
              <input
                class="form-input"
                id="filtration-solvent2" 
                placeholder="例如: 水" 
                type="text" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="station-content hidden" id="rotaryEvaporation-content">
      <h2>旋蒸工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="rotaryEvaporation-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="rotaryEvaporation-steps" 
            placeholder="请详细描述旋蒸的实验步骤，包括温度、真空度等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>旋蒸参数</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="rotaryEvaporation-temperature">
                水浴温度 (°C):
              </label>
              <input
                class="form-input"
                id="rotaryEvaporation-temperature" 
                placeholder="例如: 40" 
                type="number" />
            </div>
            <div class="form-group">
              <label class="form-label" for="rotaryEvaporation-vacuum">
                真空度 (mbar):
              </label>
              <input
                class="form-input"
                id="rotaryEvaporation-vacuum" 
                placeholder="例如: 50" 
                type="number" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="station-content hidden" id="gcms-content">
      <h2>GCMS工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="gcms-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="gcms-steps" 
            placeholder="请详细描述GCMS的实验步骤，包括样品制备、进样参数、程序升温等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>GCMS参数</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="gcms-column">
                色谱柱:
              </label>
              <input
                class="form-input"
                id="gcms-column" 
                placeholder="例如: HP-5MS" 
                type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="gcms-program">
                升温程序:
              </label>
              <input
                class="form-input"
                id="gcms-program" 
                placeholder="例如: 50°C (2min) -> 10°C/min -> 280°C (5min)" 
                type="text" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="station-content hidden" id="hplc-content">
      <h2>HPLC工站</h2>
      <div class="space-y-6">
        <div class="form-group">
          <label class="form-label" for="hplc-steps">
            实验步骤:
          </label>
          <textarea
            class="form-textarea"
            id="hplc-steps" 
            placeholder="请详细描述HPLC的实验步骤，包括样品制备、流动相、检测器等..." 
            rows="8">
          </textarea>
        </div>
        <div>
          <h3>HPLC参数</h3>
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="form-group">
              <label class="form-label" for="hplc-column">
                色谱柱:
              </label>
              <input
                class="form-input"
                id="hplc-column" 
                placeholder="例如: C18" 
                type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="hplc-mobile-phase">
                流动相:
              </label>
              <input
                class="form-input"
                id="hplc-mobile-phase" 
                placeholder="例如: 甲醇/水" 
                type="text" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 提交按钮区域 -->
    <div class="submit-area">
      <a class="yt-a-defalut-link"
        target="_top" 
        is-page="true" 
        href="javascript:void(0);"
        custom-href="w=768&h=531&appuuid=1942865613596655616&version=21&pageType=web&uuid=1942865613621821440&appName=自动化实验室"
        onclick="
          const parseWithURLSearchParams = (queryString) => {
            const params = queryString.split('&')
            const result = {}
            params.forEach(param => {
              const key = param.split('=')[0]
              const value = param.split('=')[1]
              result[key] = value
            })
            return result
          }
          const topWin = window.top
          const originParams = parseWithURLSearchParams(topWin.document.location.href.split('?')[1])
          const href = this.getAttribute('custom-href')
          if (href) {
            if (topWin.location.hash.startsWith('#/edit?')) {
              const { uuid } = parseWithURLSearchParams(href)
              const event = new CustomEvent('changePage', {
                detail: { uuid },
                bubbles: true,
                cancelable: true
              });
              topWin.dispatchEvent(event)
            } else {
              const newParams = parseWithURLSearchParams(href)
              const params = Object.keys(originParams).reduce((acc, key) => {
                if (acc !== '?') {
                  acc+='&'
                }
                acc+=key+'='+newParams[key]
                return acc
              }, '?')
              topWin.location.href = topWin.document.location.href.split('?')[0] + params
            }
          }
        " 
        custom-a="true" 
        is-add="true">
        <button
          class="btn btn-success"
          id="submit-task-btn" 
          type="button" 
          data-selectorname="#submit-task-btn">
          完成实验设定，提交任务
        </button>
      </a>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // 定义要劫持的属性
    var ytCustomProperties = ['textContent', 'innerText'];
    ytCustomProperties.forEach(function (prop) {
      var descriptor = Object.getOwnPropertyDescriptor(Element.prototype, prop) || Object.getOwnPropertyDescriptor(Node.prototype, prop);
      if (descriptor && descriptor.set) {
        var originalSet = descriptor.set;
        Object.defineProperty(Element.prototype, prop, {
          set: function set(value) {
            // 优先取 data-yteditvalue，否则用传入的 value
            var finalValue = this.dataset.yteditvalue ?? value;
            originalSet.call(this, finalValue);
          },
          configurable: true
        });
      }
    });
    
    // 保存原生方法
    var nativeElementQuerySelector = Element.prototype.querySelector;
    var nativeDocumentQuerySelector = Document.prototype.querySelector;
    function ytCustomQuerySelector(selector) {
      // 执行原生选择器查询
      var foundElement = this === document ? nativeDocumentQuerySelector.call(this, selector) : nativeElementQuerySelector.call(this, selector);
      if (foundElement) {
        // 设置属性
        if (!foundElement.hasAttribute('data-selectorname')) {
          foundElement.setAttribute('data-selectorname', selector);
        }
        return foundElement;
      }

      // 如果通过选择器没找到，尝试通过data-selectorName属性查找
      var allElements = document.querySelectorAll('[data-selectorname]');
      for (var i = 0; i < allElements.length; i++) {
        if (allElements[i].getAttribute('data-selectorname') === selector) {
          return allElements[i];
        }
      }

      return null;
    }

    // 重写原生的querySelector
    Document.prototype.querySelector = ytCustomQuerySelector;
    Element.prototype.querySelector = ytCustomQuerySelector;
    
    var nativeElementInsertBefore = Element.prototype.insertBefore;
    function ytCustomInsertBefore(newNode, referenceNode) {
      var defaultParentNode = this;

      if (!referenceNode) {
        return nativeElementInsertBefore.call(defaultParentNode, newNode, null);
      }

      if (referenceNode.parentNode === defaultParentNode) {
        return nativeElementInsertBefore.call(defaultParentNode, newNode, referenceNode);
      }

      var referenceParentValue = referenceNode.getAttribute('data-ytparentvalue');
      if (referenceParentValue) {
        var actualParentNode = document.querySelector('[data-ytextravalue="' + referenceParentValue + '"]');
        if (actualParentNode) {
          var originalIndex = referenceNode.getAttribute('data-ytoriginindex');
          if (originalIndex !== null && !isNaN(originalIndex)) {
            var children = Array.from(actualParentNode.children);

            for (var i = 0; i < children.length; i++) {
              var child = children[i];
              var childOriginalIndex = child.getAttribute('data-ytoriginindex');

              if (childOriginalIndex !== null && !isNaN(childOriginalIndex)) {
                if (parseInt(childOriginalIndex) > parseInt(originalIndex)) {
                  return nativeElementInsertBefore.call(actualParentNode, newNode, child);
                }
              }
            }

            return nativeElementInsertBefore.call(actualParentNode, newNode, null);
          }

          return nativeElementInsertBefore.call(actualParentNode, newNode, null);
        }
      }

      return nativeElementInsertBefore.call(defaultParentNode, newNode, null);
    }

    // 重写原生 insertBefore 方法
    Element.prototype.insertBefore = ytCustomInsertBefore;

    // 添加自定义样式
    function addUniqueStyle(cssText) {
      var id = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'custom-style';
      var targetDom = document.getElementById(id);
      if (targetDom && targetDom.tagName === 'STYLE') return;

      var style = document.createElement('style');
      style.id = id;
      style.innerHTML = cssText;
      document.head.appendChild(style);
    }
    addUniqueStyle('.yt-a-defalut-link[custom-a="true"] > * { margin:0;flex:1; }');
    
    document.addEventListener('DOMContentLoaded', function () {
      console.log('工站管理页面初始化开始');
      
      var tabItems = document.querySelectorAll('.tab-item');
      var addBatchingReagentBtn = document.getElementById('add-batching-reagent-btn');
      var batchingReagentsContainer = document.getElementById('batching-reagents-container');
      
      console.log('找到选项卡数量:', tabItems.length);
      console.log('找到内容区域数量:', document.querySelectorAll('.station-content').length);
      
      // 验证所有选项卡都有对应的内容区域
      var expectedTabs = ['batching', 'reaction', 'tlc', 'column', 'filtration', 'rotaryEvaporation', 'gcms', 'hplc'];
      expectedTabs.forEach(function(tabName) {
        var content = document.getElementById(tabName + '-content');
        if (content) {
          console.log('✓ 找到内容区域:', tabName + '-content');
        } else {
          console.error('✗ 缺少内容区域:', tabName + '-content');
        }
      });
      
      // 初始化：设置第一个tab为激活状态
      if (tabItems.length > 0) {
        // 先隐藏所有内容区域
        var allContents = document.querySelectorAll('.station-content');
        allContents.forEach(function (content) {
          content.style.display = 'none';
          content.classList.add('hidden');
        });
        
        // 激活第一个选项卡
        tabItems[0].classList.add('active');
        
        // 显示第一个内容区域
        var firstTab = tabItems[0].getAttribute('data-tab');
        var firstContent = document.getElementById(firstTab + '-content');
        if (firstContent) {
          firstContent.style.display = 'block';
          firstContent.classList.remove('hidden');
          console.log('初始化显示第一个内容区域:', firstTab);
        } else {
          console.error('未找到第一个内容区域:', firstTab + '-content');
        }
      } else {
        console.error('未找到任何选项卡');
      }
      
      // 切换工站选项卡
      tabItems.forEach(function (item, index) {
        item.addEventListener('click', function (e) {
          e.preventDefault(); // 防止默认行为
          e.stopPropagation(); // 防止事件冒泡
          
          console.log('点击选项卡:', this.getAttribute('data-tab'));
          
          // 如果已经是激活状态，不需要切换
          if (this.classList.contains('active')) {
            console.log('选项卡已经是激活状态，跳过');
            return;
          }
          
          // 移除所有tab的激活样式
          tabItems.forEach(function (t) {
            t.classList.remove('active');
          });
          
          // 隐藏所有内容区域 - 使用更直接的方式
          var allContents = document.querySelectorAll('.station-content');
          console.log('找到内容区域数量:', allContents.length);
          allContents.forEach(function (content, i) {
            content.style.display = 'none';
            content.classList.add('hidden');
            console.log('隐藏内容区域:', content.id);
          });
          
          // 添加当前tab的激活样式
          this.classList.add('active');
          console.log('激活选项卡:', this.getAttribute('data-tab'));
          
          // 显示对应的内容区域
          var targetTab = this.getAttribute('data-tab');
          var targetContent = document.getElementById(targetTab + '-content');
          console.log('查找目标内容区域:', targetTab + '-content');
          
          if (targetContent) {
            // 直接设置样式，确保显示
            targetContent.style.display = 'block';
            targetContent.classList.remove('hidden');
            console.log('成功显示内容区域:', targetTab);
          } else {
            console.error('未找到内容区域:', targetTab + '-content');
            // 列出所有可用的内容区域ID
            var allContentIds = [];
            allContents.forEach(function(content) {
              allContentIds.push(content.id);
            });
            console.log('可用的内容区域ID:', allContentIds);
          }
        });
      });
      
      // 添加试剂行
      if (addBatchingReagentBtn) {
        addBatchingReagentBtn.addEventListener('click', function () {
          var newReagentRow = document.createElement('div');
          newReagentRow.classList.add('reagent-row');
          newReagentRow.innerHTML = '<input type="text" placeholder="试剂名称" class="form-input reagent-name-input" list="reagent-suggestions">' +
            '<input type="number" placeholder="用量" class="form-input w-24">' +
            '<select class="form-select w-24">' +
            '<option value="g">克 (g)</option>' +
            '<option value="ml">毫升 (ml)</option>' +
            '<option value="mol">摩尔 (mol)</option>' +
            '</select>' +
            '<button type="button" class="btn btn-danger remove-reagent-btn">' +
            '<i class="fas fa-minus-circle"></i>' +
            '</button>';
          batchingReagentsContainer.appendChild(newReagentRow);
          populateReagentSuggestions(); // 新增行后重新填充建议
        });
      }

      // 填充试剂建议列表
      var populateReagentSuggestions = function populateReagentSuggestions() {
        var reagentSuggestions = document.getElementById('reagent-suggestions');
        if (reagentSuggestions) {
          reagentSuggestions.innerHTML = ''; // 清空现有选项
          var materialLibrary = ["硫酸", "盐酸", "氢氧化钠", "乙醇", "甲醇", "丙酮", "乙酸乙酯", "石油醚", "氯仿", "二氯甲烷", "四氢呋喃", "乙醚", "苯", "甲苯", "二甲苯", "水", "碳酸钠", "碳酸氢钠", "氯化钠", "硫酸镁", "无水硫酸钠", "硅胶", "氧化铝"];
          materialLibrary.forEach(function (reagent) {
            var option = document.createElement('option');
            option.value = reagent;
            reagentSuggestions.appendChild(option);
          });
        }
      };

      // 页面加载时和添加新行时填充建议
      populateReagentSuggestions();

      // 移除试剂行 (事件委托)
      if (batchingReagentsContainer) {
        batchingReagentsContainer.addEventListener('click', function (event) {
          if (event.target.closest('.remove-reagent-btn')) {
            var rowToRemove = event.target.closest('.reagent-row');
            if (rowToRemove) {
              rowToRemove.remove();
            }
          }
        });
      }
      
      // 添加全局测试函数
      window.testTabSwitch = function(tabName) {
        console.log('测试切换到选项卡:', tabName);
        var targetContent = document.getElementById(tabName + '-content');
        if (targetContent) {
          // 隐藏所有内容
          var allContents = document.querySelectorAll('.station-content');
          allContents.forEach(function(content) {
            content.style.display = 'none';
            content.classList.add('hidden');
          });
          
          // 显示目标内容
          targetContent.style.display = 'block';
          targetContent.classList.remove('hidden');
          console.log('成功切换到:', tabName);
        } else {
          console.error('未找到内容区域:', tabName + '-content');
        }
      };
      
      console.log('工站管理页面初始化完成');
      console.log('可以使用 testTabSwitch("batching") 等函数测试选项卡切换');
    });
  </script>
{% endblock %}