{% extends 'preparator_base.html' %}
{% load static %}

{% block title %}试剂库{% endblock %}

{% block extra_css %}
<script>
    (function () {
  var originalWarn = console.warn;
        console.warn = function () {
    try {
      if (arguments && arguments[0] && typeof arguments[0] === 'string' && arguments[0].indexOf('cdn.tailwindcss.com should not be used in production') !== -1) {
        return; // 忽略 Tailwind CDN 的生产环境提示
      }
            } catch (e) { }
    return originalWarn.apply(console, arguments);
  };
})();
</script>
<!-- 使用 Bootstrap 5 样式（本地静态资源） -->
<link rel="stylesheet" href="{% static 'plugins/bootstrap-5.3.0-alpha1-dist/css/bootstrap.min.css' %}">
<script>
    // Bootstrap 主题变量（如需自定义可在此注入CSS变量）
</script>
<style>
    /* 不使用 Tailwind：提供必要工具类 */
    .hidden { display: none !important; }
    .content-auto { content-visibility: auto; }
    .card-shadow { box-shadow: 0 2px 14px 0 rgba(0, 0, 0, 0.06); }
    .modal-backdrop { backdrop-filter: blur(4px); }
    .transition-height { transition: max-height 0.3s ease-in-out; }

    /* 适配常用 Tailwind 类到通用CSS（以便不改动大量模板结构） */
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .gap-4 { gap: 1rem; }
    .space-x-1 > * + * { margin-left: .25rem; }
    .space-x-2 > * + * { margin-left: .5rem; }
    .space-x-3 > * + * { margin-left: 1rem; }
    .rounded-lg { border-radius: .5rem; }
    .rounded-full { border-radius: 999px; }
    .p-6 { padding: 1.5rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mr-1 { margin-right: .25rem; }
    .mr-2 { margin-right: .5rem; }
    .mr-3 { margin-right: .75rem; }
    .ml-1 { margin-left: .25rem; }
    .ml-2 { margin-left: .5rem; }
    .w-full { width: 100%; }
    .max-w-4xl { max-width: 56rem; }
    .max-h-\[90vh\] { max-height: 90vh; }
    .overflow-y-auto { overflow-y: auto; }
    .overflow-x-auto { overflow-x: auto; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-4xl { font-size: 2.25rem; }
    .font-bold { font-weight: 700; }
    .font-extrabold { font-weight: 800; }
    .text-gray-500 { color: #6c757d; }
    .text-gray-700 { color: #495057; }
    .text-gray-900 { color: #212529; }
    .text-primary { color: #0d6efd; }
    .text-warning { color: #ffc107; }
    .text-danger { color: #dc3545; }
    .text-yellow-600 { color: #b08900; }
    .text-cyan-600 { color: #0aa2c0; }
    .bg-white { background: #fff; }
    .bg-gray-50 { background: #f8f9fa; }
    .bg-gray-200 { background: #e9ecef; }
    .bg-blue-100 { background: #cfe2ff; }
    .bg-yellow-100 { background: #fff3cd; }
    .bg-red-100 { background: #f8d7da; }
    .bg-green-100 { background: #d1e7dd; }
    .bg-success { background: #198754; }
    .bg-warning { background: #ffc107; }
    .bg-danger { background: #dc3545; }
    .border { border: 1px solid #dee2e6; }
    .border-gray-200 { border-color: #e9ecef; }
    .border-gray-300 { border-color: #dee2e6; }
    .rounded-md { border-radius: .375rem; }
    .hover\:bg-gray-50:hover { background: #f8f9fa; }
    .transition-colors { transition: color .2s ease, background-color .2s ease; }
    .hover\:text-primary\/80:hover { color: #0a58ca; }
    .hover\:text-danger\/80:hover { color: #bb2d3b; }
    .hover\:text-warning\/80:hover { color: #cc9a06; }

    /* Grid 适配 */
    .grid { display: grid; }
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0,1fr)); }
    .gap-4 { gap: 1rem; }
    @media (min-width: 576px){ .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (min-width: 768px){ .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (min-width: 992px){ .lg\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0,1fr)); } }

    /* 布局适配 */
    .container { max-width: 1140px; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .px-0 { padding-left: 0; padding-right: 0; }
    .py-0 { padding-top: 0; padding-bottom: 0; }
    @media (min-width: 768px){ .md\:px-2 { padding-left: .5rem; padding-right: .5rem; } }

    /* 输入/按钮适配（基于 Bootstrap 变量）*/
    .ring-2 { outline: 2px solid rgba(13,110,253,.5); outline-offset: 0; }
    .ring-primary { outline-color: rgba(13,110,253,.5); }
    .focus\:ring-2:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.25); }
    .focus\:border-primary:focus { border-color: #0d6efd; }
    .border-primary { border-color: #0d6efd !important; }
    .bg-primary { background-color: #0d6efd !important; }
    .hover\:bg-primary\/90:hover { background-color: #0b5ed7 !important; }
    .text-white { color: #fff; }
</style>
</style>
{% endblock %}

{% block main_content %}
<div class="flex flex-col">
    <div class="w-100 px-0 py-0">
   <div class="py-2">
    <!-- [MODULE] g7h_试剂信息统计 -->
    <section class="mb-8">
     <h2 class="text-xl font-bold mb-4">
      试剂信息统计
     </h2>
                <!-- Bootstrap 响应式等分：1/2/3/6列，随屏幕缩放均匀分布 -->
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6 g-3 text-2xl font-bold">
      <!-- 总试剂 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="all">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">总试剂</div>
                                    <div class="display-6 fw-bold" id="stat-total">0</div>
       </div>
                                <div class="rounded-circle bg-primary bg-opacity-10 p-3 text-primary">
                                    <i class="fas fa-flask fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
      <!-- 液体 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="liquid">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">液体</div>
                                    <div class="display-6 fw-bold" id="stat-liquid">0</div>
       </div>
                                <div class="rounded-circle p-3" style="background: #cff4fc;color:#055160;">
                                    <i class="fas fa-tint fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
      <!-- 固体 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="solid">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">固体</div>
                                    <div class="display-6 fw-bold" id="stat-solid">0</div>
       </div>
                                <div class="rounded-circle p-3" style="background: #fff3cd;color:#997404;">
                                    <i class="fas fa-cubes fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
      <!-- 危险试剂 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="hazardous">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">危险试剂</div>
                                    <div class="display-6 fw-bold" id="stat-hazardous">0</div>
       </div>
                                <div class="rounded-circle p-3" style="background: #f8d7da;color:#842029;">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
      <!-- 缺料预警 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="lowStock">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">缺料预警</div>
                                    <div class="display-6 fw-bold" id="stat-lowStock">0</div>
       </div>
                                <div class="rounded-circle p-3" style="background: #ffe5d0;color:#b35c00;">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
      <!-- 过期预警 -->
                    <div class="col">
                        <div class="card shadow-sm h-100 cursor-pointer" data-filter="expiring">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-secondary fw-bold">过期预警</div>
                                    <div class="display-6 fw-bold" id="stat-expiring">0</div>
       </div>
                                <div class="rounded-circle p-3" style="background: #e2d9f3;color:#4b0082;">
                                    <i class="fas fa-calendar-times fa-2x"></i>
                                </div>
                            </div>
                        </div>
      </div>
     </div>
    </section>
    <!-- [/MODULE] g7h_试剂信息统计 -->
    <!-- [MODULE] i9j_试剂列表 -->
    <section>
     <!-- 顶部工具栏：左侧标题；右侧 搜索框+按钮 和 新增按钮 -->
     <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
      <h2 class="m-0">试剂列表</h2>
      <div class="d-flex align-items-center gap-2 ms-auto">
        <div class="input-group">
          <input id="reagent-search-input" type="text" class="form-control" placeholder="名称 / CAS / 分子式">
          <button id="reagent-search-btn" class="btn btn-primary"><i class="fas fa-search me-1"></i>搜索</button>
       </div>
        <button class="btn btn-primary d-flex align-items-center px-4" id="add-reagent-btn" style="white-space: nowrap; min-width: 120px;">
          <i class="fas fa-plus me-2"></i>
          <span>新增试剂</span>
       </button>
      </div>
     </div>
                 <div class="bg-white rounded-lg shadow-sm overflow-hidden w-100">
                     <div class="table-responsive">
                         <table class="table table-hover align-middle" id="reagents-table">
        <thead class="bg-gray-50">
         <tr>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           试剂名称
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           CAS号
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           类型
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           剩余量
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           有效期
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           存储环境
          </th>
                                     <th class="px-6 py-3 text-start text-xs text-gray-500 text-uppercase"
                                        scope="col">
           操作
          </th>
         </tr>
        </thead>
                             <tbody id="reagents-tbody">
        </tbody>
       </table>
      </div>
                    <div class="px-6 py-4 bg-white border-t border-gray-200 flex items-center justify-between"
                        id="reagents-pagination">
                        <div class="text-sm text-gray-500" id="reagents-page-info"></div>
                        <div class="flex space-x-1" id="reagents-page-buttons"></div>
      </div>
     </div>
    </section>
    <!-- [/MODULE] i9j_试剂列表 -->
   </div>
  </div>
</div>

<!-- [MODULE] k2l_新增试剂弹窗 -->
<div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden"
    id="add-reagent-modal">
   <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
     <h3 class="text-xl font-bold" id="modal-title">
      新增试剂
     </h3>
     <button class="text-gray-500 hover:text-gray-700" id="close-modal">
      <i class="fas fa-times text-xl">
      </i>
     </button>
    </div>
    <form class="p-6 space-y-6" id="reagent-form">
            <input id="reagent-id" type="hidden" value="" />
     <!-- 必填项区域 -->
     <div>
      <h4 class="text-lg font-semibold mb-4 flex items-center">
       <span class="text-danger mr-1">
        *
       </span>
       必填项
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <!-- 试剂名称 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="reagent-name">
         <span class="text-danger mr-1">
          *
         </span>
         试剂名称
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="reagent-name" name="reagent-name" required="" type="text" />
       </div>
       <!-- CAS号 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="cas-number">
         <span class="text-danger mr-1">
          *
         </span>
         CAS号
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="cas-number" name="cas-number" required="" type="text" />
       </div>
       <!-- 试剂类型 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="reagent-type">
         <span class="text-danger mr-1">
          *
         </span>
         试剂类型
        </label>
                        <select
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="reagent-type" name="reagent-type" required="">
         <option value="">
          请选择
         </option>
         <option value="solid">
          固体
         </option>
         <option value="liquid">
          液体
         </option>
        </select>
       </div>
       <!-- 试剂量和单位 -->
       <div class="flex space-x-4">
        <div class="flex-1">
         <label class="block text-sm font-medium text-gray-700 mb-1" for="reagent-quantity">
          <span class="text-danger mr-1">
           *
          </span>
          试剂量
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="reagent-quantity" min="0" name="reagent-quantity" required="" step="0.01"
                                type="number" />
        </div>
        <div class="flex-1">
         <label class="block text-sm font-medium text-gray-700 mb-1" for="reagent-unit">
          <span class="text-danger mr-1">
           *
          </span>
          单位
         </label>
                            <select
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="reagent-unit" name="reagent-unit" required="">
          <option value="g">
           克(g)
          </option>
          <option value="mL">
           毫升(mL)
          </option>
         </select>
        </div>
       </div>
       <!-- 分子量 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="molecular-weight">
         <span class="text-danger mr-1">
          *
         </span>
         分子量
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="molecular-weight" min="0" name="molecular-weight" required="" step="0.001"
                            type="number" />
       </div>
       <!-- 密度 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="density">
         <span class="text-danger mr-1">
          *
         </span>
         密度 (g/cm³)
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="density" min="0" name="density" required="" step="0.001" type="number" />
       </div>
       <!-- SMILES -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="smiles">
         <span class="text-danger mr-1">
          *
         </span>
         SMILES
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="smiles" name="smiles" required="" type="text" />
       </div>
       <!-- 分子式 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="molecular-formula">
         <span class="text-danger mr-1">
          *
         </span>
         分子式
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="molecular-formula" name="molecular-formula" required="" type="text" />
       </div>
       <!-- 危险类型 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="hazard-type">
         <span class="text-danger mr-1">
          *
         </span>
         危险类型
        </label>
                        <select
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="hazard-type" name="hazard-type" required="">
         <option value="general">
          一般
         </option>
                            <option value="oxidizing">
                                强酸
                            </option>
                            <option value="oxidizing">
                                强碱
         </option>
         <option value="oxidizing">
          强氧化
         </option>
         <option value="reducing">
          强还原
         </option>
         <option value="volatile">
          高挥发
         </option>
         <option value="toxic">
          易制毒
         </option>
         <option value="explosive">
          易制爆
         </option>
        </select>
       </div>
       <!-- 缺料预警阈值 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="warning-threshold">
         <span class="text-danger mr-1">
          *
         </span>
         缺料预警阈值
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="warning-threshold" min="0" name="warning-threshold" required="" step="0.01"
                            type="number" />
       </div>
       <!-- 有效期 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="expiry-date">
         <span class="text-danger mr-1">
          *
         </span>
         有效期
        </label>
                        <input
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="expiry-date" name="expiry-date" required="" type="date" />
       </div>
       <!-- 存储环境和存储位置 -->
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="storage-environment">
          <span class="text-danger mr-1">
           *
          </span>
          存储环境
         </label>
                            <select
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="storage-environment" name="storage-environment" required="">
          <option value="room">
           室温
          </option>
          <option value="refrigerator">
           冰箱
          </option>
         </select>
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="storage-location">
          <span class="text-danger mr-1">
           *
          </span>
          存储位置
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="storage-location" name="storage-location" placeholder="例如：A区-1柜-2层" required=""
                                type="text" />
        </div>
       </div>
      </div>
     </div>
     <!-- 选填项区域 -->
     <div>
      <div class="flex items-center justify-between mb-4">
       <h4 class="text-lg font-semibold flex items-center">
        选填项
       </h4>
       <button class="text-primary text-sm flex items-center" id="toggle-optional" type="button">
        <i class="fas fa-chevron-down mr-1">
        </i>
        <span>
         收起
        </span>
       </button>
      </div>
      <div class="space-y-6" id="optional-fields">
       <!-- 中文别名 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
         中文别名
        </label>
        <div class="space-y-2" id="chinese-aliases-container">
         <div class="flex items-center">
                                <input
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                    name="chinese-aliases[]" type="text" />
          <button class="ml-2 text-danger hover:text-danger/80 remove-alias" type="button">
           <i class="fas fa-times">
           </i>
          </button>
         </div>
        </div>
                        <button class="mt-2 text-sm text-primary flex items-center" id="add-chinese-alias"
                            type="button">
         <i class="fas fa-plus mr-1">
         </i>
         <span>
          添加别名
         </span>
        </button>
       </div>
       <!-- 英文名称 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
         英文名称
        </label>
        <div class="space-y-2" id="english-names-container">
         <div class="flex items-center">
                                <input
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                    name="english-names[]" type="text" />
          <button class="ml-2 text-danger hover:text-danger/80 remove-english-name" type="button">
           <i class="fas fa-times">
           </i>
          </button>
         </div>
        </div>
        <button class="mt-2 text-sm text-primary flex items-center" id="add-english-name" type="button">
         <i class="fas fa-plus mr-1">
         </i>
         <span>
          添加英文名称
         </span>
        </button>
       </div>
       <!-- 物理性质 -->
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="color">
          颜色
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="color" name="color" type="text" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="odor">
          气味
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="odor" name="odor" type="text" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="melting-point">
          熔点 (°C)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="melting-point" name="melting-point" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="boiling-point">
          沸点 (°C)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="boiling-point" name="boiling-point" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="flash-point">
          闪点 (°C)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="flash-point" name="flash-point" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="autoignition-temp">
          自燃温度 (°C)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="autoignition-temp" name="autoignition-temp" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="decomposition-temp">
          分解温度 (°C)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="decomposition-temp" name="decomposition-temp" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="vapor-pressure">
          饱和蒸气压 (kPa)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="vapor-pressure" name="vapor-pressure" step="0.0001" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="explosion-limit">
          爆炸极限 (%)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="explosion-limit" name="explosion-limit" placeholder="例如：1.4-7.5" type="text" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="ph-value">
          PH值
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="ph-value" max="14" min="0" name="ph-value" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="particle-size">
          颗粒度 (μm)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="particle-size" name="particle-size" step="0.1" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="viscosity">
          粘度 (mPa·s)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="viscosity" name="viscosity" step="0.001" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="refractive-index">
          折射率
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="refractive-index" min="1" name="refractive-index" step="0.0001" type="number" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="water-solubility">
          水溶解性
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="water-solubility" name="water-solubility" type="text" />
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-1" for="logp">
          油水分配系数 (logP)
         </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                id="logp" name="logp" step="0.01" type="number" />
        </div>
       </div>
       <!-- 其他信息 -->
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex items-center">
                            <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                id="is-controlled" name="is-controlled" type="checkbox" />
         <label class="ml-2 block text-sm text-gray-700" for="is-controlled">
          是否管制品
         </label>
        </div>
        <div class="flex items-center">
                            <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                id="is-narcotic" name="is-narcotic" type="checkbox" />
         <label class="ml-2 block text-sm text-gray-700" for="is-narcotic">
          是否毒品
         </label>
        </div>
       </div>
       <!-- 废弃注意事项 -->
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="disposal-notes">
         废弃注意事项
        </label>
                        <textarea
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            id="disposal-notes" name="disposal-notes" rows="3">
        </textarea>
       </div>
       <!-- 图谱上传 -->
       <div class="space-y-4">
        <h5 class="font-medium text-gray-700">
         图谱上传
        </h5>
        <!-- 核磁图谱 -->
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">
          核磁图谱
         </label>
         <div class="space-y-3" id="nmr-spectra-container">
                                <div
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-primary transition-colors">
           <div class="flex flex-col items-center justify-center text-center">
            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2">
            </i>
            <p class="text-sm text-gray-500 mb-2">
             点击或拖拽文件至此处上传
            </p>
            <p class="text-xs text-gray-400 mb-3">
             支持 JPG, PNG, PDF, SVG 格式，单个文件不超过 10MB
            </p>
                                        <label
                                            class="px-4 py-2 bg-primary text-white rounded-lg text-sm cursor-pointer hover:bg-primary/90 transition-colors">
             选择文件
                                            <input accept=".jpg,.jpeg,.png,.pdf,.svg" class="hidden" type="file" />
            </label>
           </div>
           <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1"
                                            for="nmr-conditions">
             图谱获取条件
            </label>
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                            id="nmr-conditions" placeholder="例如：400 MHz, CDCl3" type="text" />
           </div>
          </div>
         </div>
         <button class="mt-2 text-sm text-primary flex items-center" type="button">
          <i class="fas fa-plus mr-1">
          </i>
          <span>
           添加图谱
          </span>
         </button>
        </div>
        <!-- GCMS图谱 -->
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">
          GCMS图谱
         </label>
         <div class="space-y-3" id="gcms-spectra-container">
                                <div
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-primary transition-colors">
           <div class="flex flex-col items-center justify-center text-center">
            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2">
            </i>
            <p class="text-sm text-gray-500 mb-2">
             点击或拖拽文件至此处上传
            </p>
            <p class="text-xs text-gray-400 mb-3">
             支持 JPG, PNG, PDF, SVG 格式，单个文件不超过 10MB
            </p>
                                        <label
                                            class="px-4 py-2 bg-primary text-white rounded-lg text-sm cursor-pointer hover:bg-primary/90 transition-colors">
             选择文件
                                            <input accept=".jpg,.jpeg,.png,.pdf,.svg" class="hidden" type="file" />
            </label>
           </div>
           <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1"
                                            for="gcms-conditions">
             图谱获取条件
            </label>
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                            id="gcms-conditions" placeholder="例如：柱子型号，温度程序" type="text" />
           </div>
          </div>
         </div>
         <button class="mt-2 text-sm text-primary flex items-center" type="button">
          <i class="fas fa-plus mr-1">
          </i>
          <span>
           添加图谱
          </span>
         </button>
        </div>
        <!-- 光谱 -->
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">
          光谱
         </label>
         <div class="space-y-3" id="spectra-container">
                                <div
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-primary transition-colors">
           <div class="flex flex-col items-center justify-center text-center">
            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2">
            </i>
            <p class="text-sm text-gray-500 mb-2">
             点击或拖拽文件至此处上传
            </p>
            <p class="text-xs text-gray-400 mb-3">
             支持 JPG, PNG, PDF, SVG 格式，单个文件不超过 10MB
            </p>
                                        <label
                                            class="px-4 py-2 bg-primary text-white rounded-lg text-sm cursor-pointer hover:bg-primary/90 transition-colors">
             选择文件
                                            <input accept=".jpg,.jpeg,.png,.pdf,.svg" class="hidden" type="file" />
            </label>
           </div>
           <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1"
                                            for="spectrum-conditions">
             图谱获取条件
            </label>
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                            id="spectrum-conditions" placeholder="例如：UV-Vis, 扫描范围 200-800 nm"
                                            type="text" />
           </div>
          </div>
         </div>
         <button class="mt-2 text-sm text-primary flex items-center" type="button">
          <i class="fas fa-plus mr-1">
          </i>
          <span>
           添加图谱
          </span>
         </button>
        </div>
        <!-- 能谱 -->
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">
          能谱
         </label>
         <div class="space-y-3" id="energy-spectra-container">
                                <div
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-primary transition-colors">
           <div class="flex flex-col items-center justify-center text-center">
            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2">
            </i>
            <p class="text-sm text-gray-500 mb-2">
             点击或拖拽文件至此处上传
            </p>
            <p class="text-xs text-gray-400 mb-3">
             支持 JPG, PNG, PDF, SVG 格式，单个文件不超过 10MB
            </p>
                                        <label
                                            class="px-4 py-2 bg-primary text-white rounded-lg text-sm cursor-pointer hover:bg-primary/90 transition-colors">
             选择文件
                                            <input accept=".jpg,.jpeg,.png,.pdf,.svg" class="hidden" type="file" />
            </label>
           </div>
           <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1"
                                            for="energy-spectrum-conditions">
             图谱获取条件
            </label>
                                        <input
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                            id="energy-spectrum-conditions" placeholder="例如：XPS, Al Kα 射线"
                                            type="text" />
           </div>
          </div>
         </div>
         <button class="mt-2 text-sm text-primary flex items-center" type="button">
          <i class="fas fa-plus mr-1">
          </i>
          <span>
           添加图谱
          </span>
         </button>
        </div>
       </div>
      </div>
     </div>
    </form>
    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3 sticky bottom-0 bg-white z-10">
            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                id="cancel-btn">
      取消
     </button>
            <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                id="save-reagent-btn">
      保存
     </button>
    </div>
   </div>
  </div>
<!-- [/MODULE] k2l_新增试剂弹窗 -->
<!-- [MODULE] m3n_取用试剂弹窗 -->
<div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden"
    id="take-reagent-modal">
   <div class="bg-white rounded-lg w-full max-w-md">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
     <h3 class="text-xl font-bold">
      取用试剂
     </h3>
     <button class="text-gray-500 hover:text-gray-700" id="close-take-modal">
      <i class="fas fa-times text-xl">
      </i>
     </button>
    </div>
    <div class="p-6">
            <input id="take-reagent-id" type="hidden" value="" />
     <div class="mb-4">
      <p class="text-gray-700">
       试剂名称:
       <span class="font-medium" id="take-reagent-name">
        乙醇
       </span>
      </p>
      <p class="text-gray-700">
       当前剩余量:
       <span class="font-medium" id="take-current-quantity">
        450 mL
       </span>
      </p>
     </div>
     <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1" for="take-quantity">
       <span class="text-danger mr-1">
        *
       </span>
       取用数量
      </label>
                <input
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                    id="take-quantity" min="0" name="take-quantity" required="" step="0.01" type="number" />
     </div>
     <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1" for="take-purpose">
       <span class="text-danger mr-1">
        *
       </span>
       取用目的
      </label>
                <textarea
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                    id="take-purpose" name="take-purpose" required="" rows="2">
        </textarea>
     </div>
     <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1" for="take-person">
       <span class="text-danger mr-1">
        *
       </span>
       取用人员
      </label>
                <input
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                    id="take-person" name="take-person" required="" type="text" />
     </div>
    </div>
    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                id="cancel-take-btn">
      取消
     </button>
            <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                id="confirm-take-btn">
      确认取用
     </button>
    </div>
   </div>
  </div>
<!-- [/MODULE] m3n_取用试剂弹窗 -->
<!-- [MODULE] o4p_删除确认弹窗 -->
<div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden"
    id="delete-confirm-modal">
   <div class="bg-white rounded-lg w-full max-w-md">
    <div class="p-6 border-b border-gray-200">
     <h3 class="text-xl font-bold">
      确认删除
     </h3>
    </div>
    <div class="p-6">
            <input id="delete-reagent-id" type="hidden" value="" />
     <div class="flex items-center mb-4">
      <i class="fas fa-exclamation-triangle text-warning text-2xl mr-3">
      </i>
      <p class="text-gray-700">
       您确定要删除试剂
       <span class="font-medium" id="delete-reagent-name">
        乙醇
       </span>
       吗？此操作不可撤销。
      </p>
     </div>
     <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1" for="delete-reason">
       删除原因
      </label>
                <textarea
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                    id="delete-reason" name="delete-reason" rows="2">
        </textarea>
     </div>
    </div>
    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
            <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                id="cancel-delete-btn">
      取消
     </button>
            <button class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90 transition-colors"
                id="confirm-delete-btn">
      确认删除
     </button>
    </div>
   </div>
  </div>
<!-- [/MODULE] o4p_删除确认弹窗 -->
{% endblock %}

{% block extra_js %}
<!-- [JSMOD] 2a3_统计卡片过滤功能 -->
<script id="stat-card-filter">
   document.addEventListener('DOMContentLoaded', () => {
  // 统计卡片过滤功能
  const filterCards = document.querySelectorAll('[data-filter]');
  filterCards.forEach(card => {
    card.addEventListener('click', () => {
      // 移除所有卡片的选中状态
      filterCards.forEach(c => c.classList.remove('ring-2', 'ring-primary'));
      // 添加当前卡片的选中状态
      card.classList.add('ring-2', 'ring-primary');
      
      const filterType = card.getAttribute('data-filter');
            console.log('[filter] card selected:', filterType);
      // 这里添加实际过滤逻辑
    });
  });
  
        // 分页按钮容器将由数据渲染
});
</script>
<!-- [JSMOD] q5r_模态框控制 -->
<script id="modal-script">
   // 获取DOM元素
var addReagentBtn = document.getElementById('add-reagent-btn');
var addReagentModal = document.getElementById('add-reagent-modal');
var closeModalBtn = document.getElementById('close-modal');
var cancelBtn = document.getElementById('cancel-btn');
var takeReagentModal = document.getElementById('take-reagent-modal');
var closeTakeModalBtn = document.getElementById('close-take-modal');
var cancelTakeBtn = document.getElementById('cancel-take-btn');
var deleteConfirmModal = document.getElementById('delete-confirm-modal');
var closeDeleteModalBtn = document.getElementById('close-delete-modal');
var cancelDeleteBtn = document.getElementById('cancel-delete-btn');
var toggleOptionalBtn = document.getElementById('toggle-optional');
var optionalFields = document.getElementById('optional-fields');
var reagentForm = document.getElementById('reagent-form');
var modalTitle = document.getElementById('modal-title');
var reagentIdInput = document.getElementById('reagent-id');
var reagentTypeSelect = document.getElementById('reagent-type');
var reagentUnitSelect = document.getElementById('reagent-unit');
var addChineseAliasBtn = document.getElementById('add-chinese-alias');
var chineseAliasesContainer = document.getElementById('chinese-aliases-container');

// 打开新增试剂模态框
addReagentBtn.addEventListener('click', function () {
  modalTitle.textContent = '新增试剂';
  reagentIdInput.value = '';
  reagentForm.reset();
  addReagentModal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
});

// 关闭模态框的通用函数
function closeModal(modal) {
        console.log('[modal] close', modal && modal.id);
  modal.classList.add('hidden');
  document.body.style.overflow = '';
        // 防御：确保其它模态也被隐藏
        ['add-reagent-modal','take-reagent-modal','delete-confirm-modal'].forEach(id=>{
            const el = document.getElementById(id);
            if (el && !el.classList.contains('hidden')){
                console.log('[modal] force hide residual', id);
                el.classList.add('hidden');
            }
        });
}

// 关闭新增试剂模态框
closeModalBtn.addEventListener('click', function () {
  return closeModal(addReagentModal);
});
cancelBtn.addEventListener('click', function () {
  return closeModal(addReagentModal);
});

// 关闭取用试剂模态框
closeTakeModalBtn.addEventListener('click', function () {
  return closeModal(takeReagentModal);
});
cancelTakeBtn.addEventListener('click', function () {
  return closeModal(takeReagentModal);
});

// 关闭删除确认模态框
cancelDeleteBtn.addEventListener('click', function () {
  return closeModal(deleteConfirmModal);
});

// 点击模态框背景关闭模态框
addReagentModal.addEventListener('click', function (e) {
  if (e.target === addReagentModal) closeModal(addReagentModal);
});
takeReagentModal.addEventListener('click', function (e) {
  if (e.target === takeReagentModal) closeModal(takeReagentModal);
});
deleteConfirmModal.addEventListener('click', function (e) {
  if (e.target === deleteConfirmModal) closeModal(deleteConfirmModal);
});

// 切换选填项显示/隐藏
toggleOptionalBtn.addEventListener('click', function () {
  var icon = toggleOptionalBtn.querySelector('i');
  var text = toggleOptionalBtn.querySelector('span');
  if (optionalFields.classList.contains('hidden')) {
    optionalFields.classList.remove('hidden');
    icon.classList.remove('fa-chevron-right');
    icon.classList.add('fa-chevron-down');
    text.textContent = '收起';
  } else {
    optionalFields.classList.add('hidden');
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-right');
    text.textContent = '展开';
  }
});

// 根据试剂类型切换单位
reagentTypeSelect.addEventListener('change', function () {
  if (reagentTypeSelect.value === 'solid') {
    reagentUnitSelect.value = 'g';
  } else if (reagentTypeSelect.value === 'liquid') {
    reagentUnitSelect.value = 'mL';
  }
});

// 添加中文别名
addChineseAliasBtn.addEventListener('click', function () {
  var aliasDiv = document.createElement('div');
  aliasDiv.className = 'flex items-center';
  aliasDiv.innerHTML = "<input type=\"text\" name=\"chinese-aliases[]\" class=\"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary\">\n                <button type=\"button\" class=\"ml-2 text-danger hover:text-danger/80 remove-alias\">\n                    <i class=\"fas fa-times\"></i>\n                </button>";
  chineseAliasesContainer.appendChild(aliasDiv);

  // 添加删除别名事件
  aliasDiv.querySelector('.remove-alias').addEventListener('click', function () {
    chineseAliasesContainer.removeChild(aliasDiv);
  });
});

// 为已存在的别名添加删除事件
document.querySelectorAll('.remove-alias').forEach(function (btn) {
  btn.addEventListener('click', function () {
    btn.parentElement.remove();
  });
});
</script>
<!-- [JSMOD] s6t_试剂操作处理 -->
<script id="reagent-operations-script">
   // 获取DOM元素
        const takeBtns = document.querySelectorAll('.take-btn');
        const deleteBtns = document.querySelectorAll('.delete-btn');
        const editBtns = document.querySelectorAll('.edit-btn');
        // 已在上方脚本中声明，避免重复声明
        // 使用已存在的变量引用
        const takeReagentIdInput = document.getElementById('take-reagent-id');
        const takeReagentNameSpan = document.getElementById('take-reagent-name');
        const takeCurrentQuantitySpan = document.getElementById('take-current-quantity');
        const takeQuantityInput = document.getElementById('take-quantity');
        const takePurposeInput = document.getElementById('take-purpose');
        const takePersonInput = document.getElementById('take-person');
        const confirmTakeBtn = document.getElementById('confirm-take-btn');
        const deleteReagentIdInput = document.getElementById('delete-reagent-id');
        const deleteReagentNameSpan = document.getElementById('delete-reagent-name');
        const deleteReasonInput = document.getElementById('delete-reason');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const saveReagentBtn = document.getElementById('save-reagent-btn');
        
    // 实际数据通过接口获取
    const reagents = [];
        
        // 打开取用试剂模态框
        takeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const reagentId = parseInt(btn.getAttribute('data-id'));
                const reagent = reagents.find(r => r.id === reagentId);
                
                if (reagent) {
                    takeReagentIdInput.value = reagent.id;
                    takeReagentNameSpan.textContent = reagent.name;
                    takeCurrentQuantitySpan.textContent = `${reagent.quantity} ${reagent.unit}`;
                    takeQuantityInput.value = '';
                    takePurposeInput.value = '';
                    takePersonInput.value = '';
                    
                    takeReagentModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            });
        });
        
        // 确认取用试剂
        document.getElementById('confirm-take-btn').addEventListener('click', () => {
            const reagentId = parseInt(takeReagentIdInput.value);
            const takeQuantity = parseFloat(takeQuantityInput.value);
            const takePurpose = takePurposeInput.value.trim();
            const takePerson = takePersonInput.value.trim();
            
            if (!takeQuantity || takeQuantity <= 0) {
                alert('请输入有效的取用数量');
                return;
            }
            
            if (!takePurpose) {
                alert('请输入取用目的');
                return;
            }
            
            if (!takePerson) {
                alert('请输入取用人员');
                return;
            }
            
            // 在实际应用中，这里会发送请求到服务器
            // 这里仅做前端演示
            const reagent = reagents.find(r => r.id === reagentId);
            if (reagent) {
                if (takeQuantity > reagent.quantity) {
                    alert('取用数量不能大于当前剩余量');
                    return;
                }
                
                reagent.quantity -= takeQuantity;
                reagent.quantity = Math.round(reagent.quantity * 100) / 100; // 保留两位小数
                
                // 更新界面显示
// 更新界面显示
                const row = document.querySelector(`.take-btn[data-id="${reagentId}"]`).closest('tr');
                if (row) {
                    const quantityCell = row.querySelector('td:nth-child(4)');
                    const quantityValue = quantityCell.querySelector('span:first-child');
                    const progressBar = quantityCell.querySelector('.bg-gray-200 .bg-success, .bg-gray-200 .bg-warning, .bg-gray-200 .bg-danger');
                    
                    if (quantityValue && progressBar) {
                        quantityValue.textContent = reagent.quantity;
                        
                        // 更新进度条
                        const percentage = Math.min(100, Math.max(0, (reagent.quantity / (reagent.quantity + takeQuantity)) * 100));
                        progressBar.style.width = `${percentage}%`;
                        
                        // 根据剩余量改变进度条颜色
                        progressBar.className = 'h-2 rounded-full';
                        if (percentage < 30) {
                            progressBar.classList.add('bg-danger');
                        } else if (percentage < 60) {
                            progressBar.classList.add('bg-warning');
                        } else {
                            progressBar.classList.add('bg-success');
                        }
                    }
                }
                
                // 关闭模态框并显示成功消息
                closeModal(takeReagentModal);
                alert('试剂取用成功！');
            }
        });
        
        // 打开删除确认模态框
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const reagentId = parseInt(btn.getAttribute('data-id'));
                const reagent = reagents.find(r => r.id === reagentId);
                
                if (reagent) {
                    deleteReagentIdInput.value = reagent.id;
                    deleteReagentNameSpan.textContent = reagent.name;
                    deleteReasonInput.value = '';
                    
                    deleteConfirmModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            });
        });
        
        // 确认删除试剂
        confirmDeleteBtn.addEventListener('click', () => {
            const reagentId = parseInt(deleteReagentIdInput.value);
            
            // 在实际应用中，这里会发送请求到服务器
            // 这里仅做前端演示
            const reagentIndex = reagents.findIndex(r => r.id === reagentId);
            if (reagentIndex !== -1) {
                reagents.splice(reagentIndex, 1);
                
                // 从界面移除该行
                const row = document.querySelector(`.delete-btn[data-id="${reagentId}"]`).closest('tr');
                if (row) {
                    row.remove();
                }
                
                // 关闭模态框并显示成功消息
                closeModal(deleteConfirmModal);
                alert('试剂删除成功！');
            }
        });
        
        // 编辑试剂
        editBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const reagentId = parseInt(btn.getAttribute('data-id'));
                const reagent = reagents.find(r => r.id === reagentId);
                
                if (reagent) {
                    modalTitle.textContent = '编辑试剂';
                    reagentIdInput.value = reagent.id;
                    
                    // 填充表单数据（这里仅填充部分关键数据，实际应用中需要填充所有字段）
                    document.getElementById('reagent-name').value = reagent.name;
                    document.getElementById('cas-number').value = reagent.cas;
                    document.getElementById('reagent-type').value = reagent.type;
                    document.getElementById('reagent-quantity').value = reagent.quantity;
                    document.getElementById('reagent-unit').value = reagent.unit;
                    
                    // 打开模态框
                    addReagentModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            });
        });

    // CSRF 读取
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
        
        // 保存试剂（新增或编辑）
    saveReagentBtn.addEventListener('click', async () => {
            const reagentId = reagentIdInput.value ? parseInt(reagentIdInput.value) : null;
            const name = document.getElementById('reagent-name').value.trim();
            const cas = document.getElementById('cas-number').value.trim();
            const type = document.getElementById('reagent-type').value;
            const quantity = parseFloat(document.getElementById('reagent-quantity').value);
            const unit = document.getElementById('reagent-unit').value;
            const molecularWeight = parseFloat(document.getElementById('molecular-weight').value);
        const density = parseFloat(document.getElementById('density').value);
        const payload = {
            name,
            cas,
            reagent_type: type,
            quantity,
            unit,
            molecular_weight: molecularWeight,
            density,
            smiles: document.getElementById('smiles').value.trim(),
            formula: document.getElementById('molecular-formula').value.trim(),
            hazard_type: document.getElementById('hazard-type').value,
            warning_threshold: parseFloat(document.getElementById('warning-threshold').value),
            expiry_date: document.getElementById('expiry-date').value,
            storage_env: document.getElementById('storage-environment').value,
            storage_location: document.getElementById('storage-location').value
        };

        // 基础校验
        if (!name) return alert('请输入试剂名称');
        if (!cas) return alert('请输入CAS号');
        if (!type) return alert('请选择试剂类型');
        if (isNaN(quantity) || quantity < 0) return alert('请输入有效的试剂量');
        if (isNaN(molecularWeight) || molecularWeight <= 0) return alert('请输入有效的分子量');
        if (isNaN(density) || density <= 0) return alert('请输入有效的密度');

        const url = reagentId ? `/api/reagent/${reagentId}/update/` : `/api/reagent/create/`;
        const method = reagentId ? 'PUT' : 'POST';
        const csrf = getCookie('csrftoken');
        console.log('[reagents] submit', { url, method, payload });
        try {
            const resp = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf || ''
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            });
            const raw = await resp.text();
            let data = null;
            try { data = JSON.parse(raw); } catch (e) { }
            console.log('[reagents] resp', { status: resp.status, data: data || raw });
            if (!resp.ok || (data && data.ok === false)) {
                const msg = (data && data.message) || `HTTP ${resp.status}`;
                alert(`保存失败: ${msg}`);
                return;
            }
            await window.reloadReagents(1);
            alert('保存成功');
        } catch (err) {
            console.error('[reagents] submit error', err);
            alert('保存失败，请查看控制台日志');
        } finally {
            closeModal(addReagentModal);
        }
    });

    // 关闭模态框的通用函数
    function closeModal(modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
</script>
<!-- [JSMOD] 试剂库数据加载与分页 -->
<script id="reagents-fetch-render">
    (function () {
        const tbody = document.getElementById('reagents-tbody');
        const pageInfo = document.getElementById('reagents-page-info');
        const pageButtons = document.getElementById('reagents-page-buttons');

        async function fetchJSON(url) {
            const resp = await fetch(url, { credentials: 'same-origin' });
            if (!resp.ok) throw new Error('网络错误');
            const data = await resp.json();
            if (data.ok === false) throw new Error(data.message || '请求失败');
            return data;
        }

        function renderRows(items) {
            tbody.innerHTML = '';
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="h-8 w-8 rounded-full ${item.type === 'liquid' ? 'bg-blue-100 text-primary' : 'bg-yellow-100 text-yellow-600'} flex items-center justify-center mr-3">
                <i class="fas ${item.type === 'liquid' ? 'fa-flask' : 'fa-cube'}"></i>
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">${item.name}</div>
                <div class="text-xs text-gray-500">${item.formula || ''}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.cas || ''}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.type === 'solid' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${item.type === 'solid' ? '固体' : '液体'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <div class="flex items-center">
              <span>${item.quantity}</span>
              <span class="ml-1 text-gray-400">${item.unit}</span>
              <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full ${item.quantity <= 0 ? 'bg-danger' : (item.quantity < 50 ? 'bg-warning' : 'bg-success')}" style="width: 50%"></div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.expiry || ''}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.storage_env === 'refrigerator' ? '冰箱' : '室温'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button class="text-primary hover:text-primary/80 transition-colors edit-btn border-0 focus:outline-none focus:ring-0 p-0 cursor-pointer" data-id="${item.id}"><i class="fas fa-edit"></i></button>
              <button class="text-danger hover:text-danger/80 transition-colors delete-btn border-0 focus:outline-none focus:ring-0 p-0 cursor-pointer" data-id="${item.id}"><i class="fas fa-trash"></i></button>
              <button class="text-warning hover:text-warning/80 transition-colors take-btn border-0 focus:outline-none focus:ring-0 p-0 cursor-pointer" data-id="${item.id}"><i class="fas fa-minus-circle"></i></button>
            </div>
          </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // 事件代理：操作按钮（取用/删除/编辑）
    document.addEventListener('click', (e) => {
            const take = e.target.closest('.take-btn');
            const del = e.target.closest('.delete-btn');
            const edit = e.target.closest('.edit-btn');
            if (take) {
        console.log('[action] take-click', take.getAttribute('data-id'));
                const id = parseInt(take.getAttribute('data-id'));
                const r = reagents.find(x => x.id === id);
                if (r) {
                    document.getElementById('take-reagent-id').value = r.id;
                    document.getElementById('take-reagent-name').textContent = r.name;
                    document.getElementById('take-current-quantity').textContent = `${r.quantity} ${r.unit}`;
                    document.getElementById('take-quantity').value = '';
                    document.getElementById('take-purpose').value = '';
                    document.getElementById('take-person').value = '';
                    document.getElementById('take-reagent-modal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
                return;
            }
      if (del) {
        console.log('[action] delete-click', del.getAttribute('data-id'));
                const id = parseInt(del.getAttribute('data-id'));
                const r = reagents.find(x => x.id === id);
                if (r) {
                    document.getElementById('delete-reagent-id').value = r.id;
                    document.getElementById('delete-reagent-name').textContent = r.name;
                    document.getElementById('delete-reason').value = '';
                    document.getElementById('delete-confirm-modal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
                return;
            }
      if (edit) {
        console.log('[action] edit-click', edit.getAttribute('data-id'));
        const id = parseInt(edit.getAttribute('data-id'));
        // 通过详情接口加载完整字段
        (async () => {
          try {
            const resp = await fetch(`/api/reagent/${id}/`, {credentials: 'same-origin'});
            const data = await resp.json();
            if (!resp.ok || data.ok === false) {
              alert(data.message || `加载失败: HTTP ${resp.status}`);
              return;
            }
            const r = data.reagent || {};
            console.log('[action] edit-fill', r);
            document.getElementById('modal-title').textContent = '编辑试剂';
            document.getElementById('reagent-id').value = r.id || '';
            document.getElementById('reagent-name').value = r.name || '';
            document.getElementById('cas-number').value = r.cas || '';
            document.getElementById('reagent-type').value = r.type || '';
            document.getElementById('reagent-quantity').value = (r.quantity != null ? r.quantity : '');
            document.getElementById('reagent-unit').value = r.unit || '';
            // 关键字段：分子量、密度、SMILES、分子式、危险类型、阈值、有效期、存储
            if (document.getElementById('molecular-weight')) document.getElementById('molecular-weight').value = (r.molecular_weight != null ? r.molecular_weight : '');
            if (document.getElementById('density')) document.getElementById('density').value = (r.density != null ? r.density : '');
            if (document.getElementById('smiles')) document.getElementById('smiles').value = r.smiles || '';
            if (document.getElementById('molecular-formula')) document.getElementById('molecular-formula').value = r.formula || '';
            if (document.getElementById('hazard-type')) document.getElementById('hazard-type').value = r.hazard_type || 'general';
            if (document.getElementById('warning-threshold')) document.getElementById('warning-threshold').value = (r.warning_threshold != null ? r.warning_threshold : '');
            if (document.getElementById('expiry-date')) document.getElementById('expiry-date').value = r.expiry || '';
            if (document.getElementById('storage-environment')) document.getElementById('storage-environment').value = r.storage_env || 'room';
            if (document.getElementById('storage-location')) document.getElementById('storage-location').value = r.storage_location || '';
            // 打开模态框
            document.getElementById('add-reagent-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          } catch (e) {
            console.error('[reagents] load detail error', e);
            alert('加载试剂详情失败');
          }
        })();
        return;
      }
        });

        function renderPagination(current, total) {
            pageButtons.innerHTML = '';
            pageInfo.textContent = `第 ${current} / ${total} 页`;
            const prevBtn = document.createElement('button');
            prevBtn.className = 'px-3 py-1 border border-gray-300 rounded-md text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = current <= 1;
            prevBtn.addEventListener('click', () => reloadReagents(current - 1));
            pageButtons.appendChild(prevBtn);
            // 简化分页按钮：当前页与相邻页
            for (let p = Math.max(1, current - 1); p <= Math.min(total, current + 1); p++) {
                const b = document.createElement('button');
                b.className = `px-3 py-1 border rounded-md ${p === current ? 'border-primary bg-primary text-white' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}`;
                b.textContent = String(p);
                if (p !== current) b.addEventListener('click', () => reloadReagents(p));
                pageButtons.appendChild(b);
            }
            const nextBtn = document.createElement('button');
            nextBtn.className = 'px-3 py-1 border border-gray-300 rounded-md text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = current >= total;
            nextBtn.addEventListener('click', () => reloadReagents(current + 1));
            pageButtons.appendChild(nextBtn);
        }

        function buildFilters(){
            const params = new URLSearchParams();
            // 搜索
            const searchInput = document.querySelector('#reagents-table')?.closest('.bg-white').previousElementSibling?.querySelector('input[placeholder="搜索试剂..."]');
            const q = searchInput ? (searchInput.value || '') : '';
            if (q) params.set('q', q);
            // 卡片筛选
            const active = document.querySelector('[data-filter].ring-2');
            if (active){
                const card = active.getAttribute('data-filter');
                if (card) params.set('card', card);
            }
            return params;
        }

        async function reloadStats() {
            try {
                const params = buildFilters();
                // 可按需附加筛选条件（搜索框等）
                const data = await fetchJSON(`/api/reagents/stats/?${params.toString()}`);
                const s = (data && data.stats) || {};
                const map = {
                    total: 'stat-total',
                    liquid: 'stat-liquid',
                    solid: 'stat-solid',
                    hazardous: 'stat-hazardous',
                    lowStock: 'stat-lowStock',
                    expiring: 'stat-expiring'
                };
                Object.keys(map).forEach(k => {
                    const el = document.getElementById(map[k]);
                    if (el) el.textContent = (s[k] != null ? s[k] : 0);
                });
            } catch (e) {
                console.warn('统计加载失败', e);
            }
        }

        async function reloadReagents(page = 1) {
            const params = buildFilters();
            params.set('page', String(page));
            params.set('page_size', '10');
            try {
                const data = await fetchJSON(`/api/reagents/?${params.toString()}`);
                // 更新内存数组供按钮使用
                reagents.length = 0;
                (data.items || []).forEach(it => reagents.push(it));
                renderRows(data.items || []);
                renderPagination(data.current_page || 1, data.total_pages || 1);
                // 列表更新后，同步刷新统计
                reloadStats();
            } catch (e) {
                alert(e.message || '加载失败');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            reloadReagents(1);
            reloadStats();
            // 搜索回车/按钮
            const searchInput = document.getElementById('reagent-search-input');
            const searchBtn = document.getElementById('reagent-search-btn');
            if (searchInput){
                searchInput.addEventListener('keydown', (e)=>{
                    if (e.key === 'Enter'){
                        reloadReagents(1); reloadStats();
                    }
                });
            }
            if (searchBtn){
                searchBtn.addEventListener('click', ()=>{ reloadReagents(1); reloadStats(); });
            }
            // 卡片点击后刷新
            document.querySelectorAll('[data-filter]').forEach(card=>{
                card.addEventListener('click', ()=>{
                    reloadReagents(1);
                    reloadStats();
                });
            });
        });

        // 暴露到全局（供其他脚本调用）
        window.reloadReagents = reloadReagents;
    })();
</script>
{% endblock %}