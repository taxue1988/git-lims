# GCMS 滑块交互功能说明

## 🎯 功能概述

新版本实现了**交互式滑块界面**，用户可以通过拖动滑块来实时查看不同保留时间对应的质谱图，无需手动输入保留时间。

## 📐 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 分析结果 - 色谱图与质谱图                 [导出色谱图] [导出质谱图] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 色谱图（TIC - 总离子流）        保留时间: [10.25] 分钟      │
│ ┌───────────────────────────────────────────────────────┐  │
│ │                                                       │  │
│ │              [折线图显示]                             │  │
│ │                                                       │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ [========●════════════════════════]  滑块             │  │
│ │  0.00                          100.00  时间范围       │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ 质谱图（MS）                  ✓ 保留时间: 10.25 分钟      │
│ ┌───────────────────────────────────────────────────────┐  │
│ │                                                       │  │
│ │              [柱状图显示]                             │  │
│ │                                                       │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ [关闭]                                                      │
└─────────────────────────────────────────────────────────────┘
```

## 🎮 使用方式

### 基本操作

1. **打开结果页面**
   - 点击任务列表中的"查看结果"按钮
   - 色谱图自动加载显示

2. **拖动滑块加载质谱图**
   - 在色谱图下方找到滑块
   - 拖动滑块到想要查看的位置
   - 质谱图会自动加载并显示对应的数据

3. **查看保留时间**
   - 在色谱图右上角显示当前保留时间
   - 滑块下方显示时间范围（最小值和最大值）

4. **导出图表**
   - 点击"导出色谱图"导出色谱图 PNG
   - 点击"导出质谱图"导出质谱图 PNG

## 🔄 交互流程

```
用户打开结果
    ↓
色谱图加载显示
    ↓
滑块初始化（范围：色谱图的时间范围）
    ↓
用户拖动滑块
    ↓
实时更新保留时间显示
    ↓
300ms 后自动加载质谱数据（防抖）
    ↓
质谱图显示
    ↓
用户继续拖动滑块
    ↓
重复上述过程
```

## 💡 特色功能

### 1. 实时保留时间显示
- 滑块移动时，上方实时显示当前保留时间
- 精确到小数点后两位

### 2. 防抖处理
- 拖动滑块时，不会频繁发送请求
- 300ms 后才发送一次请求
- 减少服务器压力，提高用户体验

### 3. 智能数据降采样
- 质谱数据超过 500 个点时自动降采样
- 保持数据特征，提高渲染性能

### 4. 缓存机制
- 首次加载的色谱图数据被缓存
- 刷新页面后仍可快速加载

## 📊 界面元素说明

| 元素 | 功能 | 说明 |
|------|------|------|
| **色谱图** | 显示 TIC 数据 | 折线图，显示整个分析过程的总离子流 |
| **滑块** | 选择保留时间 | 拖动滑块选择要查看的保留时间 |
| **保留时间显示** | 显示当前时间 | 实时显示滑块对应的保留时间值 |
| **时间范围** | 显示数据范围 | 显示色谱图数据的最小和最大保留时间 |
| **质谱图** | 显示 MS 数据 | 柱状图，显示选定保留时间的质谱数据 |
| **状态指示** | 显示加载状态 | 显示质谱图加载状态或错误信息 |
| **导出按钮** | 导出图表 | 导出色谱图或质谱图为 PNG 格式 |

## ⚙️ 技术细节

### 滑块映射算法

```javascript
// 用户拖动滑块时
const sliderPercent = sliderValue / 100;  // 0-1 之间的百分比
const rtValue = minX + (maxX - minX) * sliderPercent;  // 映射到实际保留时间
```

### 防抖实现

```javascript
// 防止频繁请求
clearTimeout(sliderTimeout);
sliderTimeout = setTimeout(() => {
    // 300ms 后发送请求
    sendMessage(`get_mass_spectrum_${sequenceIndex}_${rtValue}`);
}, 300);
```

### 数据降采样

```javascript
// 超过 500 个点时进行降采样
if (mzArr.length > 500) {
    const step = Math.ceil(mzArr.length / 500);
    displayMz = mzArr.filter((_, i) => i % step === 0);
    displayIntensity = intensityArr.filter((_, i) => i % step === 0);
}
```

## 🎨 样式特点

- **现代化设计**：使用 Bootstrap 5 框架
- **响应式布局**：适应各种屏幕尺寸
- **清晰的视觉层次**：上下两个图表区域分明
- **友好的交互反馈**：加载状态实时显示
- **专业的色彩搭配**：蓝色色谱图，绿色质谱图

## 🚀 性能优化

| 优化方式 | 效果 |
|---------|------|
| **防抖处理** | 减少 API 请求，降低服务器压力 |
| **数据缓存** | 避免重复加载相同数据 |
| **数据降采样** | 提高大数据量的渲染性能 |
| **异步加载** | 不阻塞用户界面 |
| **图表复用** | 销毁旧图表，创建新图表，避免内存泄漏 |

## 🔧 常见问题

### Q1: 拖动滑块时质谱图没有更新

**A**: 这是正常的，系统使用了 300ms 的防抖延迟。停止拖动后，质谱图会自动加载。

### Q2: 质谱图显示"未找到质谱数据"

**A**: 可能的原因：
- 输入的保留时间超出数据范围
- mzML 转换失败
- 数据文件夹路径不正确

### Q3: 滑块范围不对

**A**: 滑块范围由色谱图数据的最小和最大保留时间决定。如果范围不对，检查 CSV 文件数据是否正确。

### Q4: 质谱图加载很慢

**A**: 首次加载需要进行 mzML 转换（5-30 分钟），后续加载会更快。

## 📱 响应式设计

- **桌面端**：两个图表并排显示（如果屏幕足够宽）
- **平板端**：上下排列，各占 50% 宽度
- **手机端**：全屏显示，上下滚动查看

## 🎓 使用技巧

### 技巧 1: 快速定位峰值
1. 观察色谱图找到主要峰值
2. 拖动滑块到峰值位置
3. 查看对应的质谱图

### 技巧 2: 对比不同时间的质谱
1. 拖动滑块到第一个时间点
2. 记录质谱图特征
3. 拖动滑块到另一个时间点
4. 对比两个质谱图的差异

### 技巧 3: 导出高质量图表
1. 调整滑块到想要的位置
2. 点击导出按钮
3. 导出的 PNG 文件包含完整的图表信息

## 🔐 数据安全

- 所有数据在浏览器本地缓存
- 不会上传到云端
- 关闭浏览器后缓存自动清除

## 📈 性能指标

| 指标 | 值 |
|------|-----|
| 防抖延迟 | 300ms |
| 数据降采样阈值 | 500 个点 |
| 图表渲染时间 | < 500ms |
| 内存占用 | 100-500MB |

## 🎯 下一步改进

- [ ] 支持在色谱图上直接点击加载质谱图
- [ ] 支持多个保留时间的质谱图对比
- [ ] 自动识别和标注主要峰值
- [ ] 支持更多的导出格式（PDF、SVG 等）
- [ ] 实时数据分析和统计

---

**版本**: 2.0.0（滑块交互版本）  
**最后更新**: 2025-11-21  
**兼容浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

