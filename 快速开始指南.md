# GCMS 色谱图和质谱图功能 - 快速开始指南

## 📋 前置要求

### 系统要求
- Windows 10/11 或 Windows Server 2016+
- Python 3.8+
- 至少 2GB 可用磁盘空间（用于 mzML 转换）

### 软件依赖
- ProteoWizard 3.0+（用于 .D 文件转换）
- Django 3.2+
- Python 依赖包（见下文）

## 🚀 安装步骤

### 1. 安装 ProteoWizard

**Windows 用户**：
```bash
# 方法一：下载安装程序
# 访问 http://proteowizard.sourceforge.net/
# 下载并运行安装程序

# 方法二：使用 Chocolatey（如已安装）
choco install proteowizard
```

**验证安装**：
```bash
# 检查 msconvert.exe 是否存在
dir "C:\Program Files\ProteoWizard\*msconvert.exe"
```

### 2. 安装 Python 依赖

```bash
# 进入项目目录
cd /path/to/git-lims

# 安装必要的 Python 包
pip install pymzml websocket-client

# 或使用 requirements.txt（如果已更新）
pip install -r requirements.txt
```

### 3. 验证安装

```bash
# 测试 pymzml 导入
python -c "import pymzml; print('pymzml 安装成功')"

# 测试 ms_converter 模块
python -c "from station_workers.GCMS液相.ms_converter import GCMSDataProcessor; print('ms_converter 导入成功')"
```

## 🎯 使用流程

### 第一步：启动 Django 服务器

```bash
# 在项目根目录
python manage.py runserver 0.0.0.0:8000
```

打开浏览器访问：`http://localhost:8000`

### 第二步：启动 GCMS Worker

```bash
# 在新的终端窗口
cd station_workers/GCMS液相
python gcms_worker.py
```

你应该看到类似的输出：
```
正在连接到 ws://192.168.58.8:8000/ws/gcms/
GCMS Worker 已连接到服务器
质谱数据处理器初始化完成
```

### 第三步：创建分析任务

1. 登录网页界面
2. 进入 GCMS 工站管理页面
3. 点击"创建分析任务"按钮
4. 填写以下信息：
   - **实验名称**：例如 "样品批次A-01"
   - **样品瓶号**：0-33 之间的数字
   - **序列号**：从"查看序列清单"中选择

### 第四步：运行任务

1. 在任务列表中找到新创建的任务
2. 点击"运行"按钮
3. 等待任务完成（状态会从"排队中"变为"已完成"）

### 第五步：查看色谱图

1. 任务完成后，点击"查看结果"按钮
2. 色谱图会自动加载显示
3. 可以看到 TIC（总离子流）色谱图

### 第六步：加载质谱图

1. 在"质谱图"区域，输入保留时间（单位：分钟）
   - 例如：10.5（表示 10.5 分钟）
   - 参考色谱图上的时间范围
2. 点击"加载质谱图"按钮
3. 等待质谱图加载（首次可能需要几分钟进行 mzML 转换）
4. 质谱图会显示为柱状图，显示 m/z 值和强度

### 第七步：导出图表

- 点击"导出色谱图 PNG"导出色谱图
- 点击"导出质谱图 PNG"导出质谱图

## 📊 数据配置

### 配置序列参数表

编辑 `模块开发运行代码/GCMS模块/GCMS序列及参数表.csv`：

```csv
序号,序列文件名,数据名称,数据存储路径
0,2024 Dec 04 1403_default.sequence.xml,Test,D:\MassHunter\GCMS\1\data\20241204
1,2024 Dec 05 1000_default.sequence.xml,Sample1,D:\MassHunter\GCMS\1\data\20241205
```

**字段说明**：
- **序号**：任务创建时选择的序列号
- **序列文件名**：GCMS 序列文件名
- **数据名称**：数据文件夹的基础名称（不含 .D）
- **数据存储路径**：数据文件夹的父目录

### 验证配置

```bash
# 检查 CSV 文件是否能正确读取
python -c "
from station_workers.GCMS液相.sequence_manager import load_sequence_params_map
params = load_sequence_params_map()
for idx, (seq_file, data_name, data_path) in params.items():
    print(f'序列 {idx}: {seq_file} -> {data_path}/{data_name}.D')
"
```

## 🔧 常见问题

### Q1: "msconvert.exe 未找到"

**症状**：Worker 日志显示 "msconvert.exe 未找到"

**解决方案**：
1. 确认 ProteoWizard 已安装
2. 检查安装路径：
   ```bash
   dir "C:\Program Files\ProteoWizard\"
   ```
3. 如果路径不同，编辑 `ms_converter.py` 中的 `MSCONVERT_PATHS` 列表

### Q2: "未找到结果文件 tic_front.csv"

**症状**：查看结果时显示此错误

**解决方案**：
1. 检查 CSV 配置中的数据路径是否正确
2. 验证数据文件夹是否存在：
   ```bash
   dir "D:\MassHunter\GCMS\1\data\20241204\Test.D\"
   ```
3. 确认 `tic_front.csv` 文件存在于该文件夹

### Q3: "未找到质谱数据"

**症状**：加载质谱图时显示此错误

**解决方案**：
1. 检查输入的保留时间是否在色谱图的时间范围内
2. 查看 Worker 日志确认 mzML 转换是否成功
3. 尝试使用色谱图上的主要峰值的保留时间

### Q4: 质谱图加载很慢

**症状**：点击"加载质谱图"后等待很长时间

**解决方案**：
1. 这是正常的，首次加载需要进行 mzML 转换（5-30 分钟）
2. 后续加载会更快（使用缓存的 mzML 文件）
3. 检查磁盘空间是否充足

### Q5: Worker 连接失败

**症状**：Worker 日志显示 "连接失败" 或 "无法连接到服务器"

**解决方案**：
1. 确认 Django 服务器正在运行
2. 检查 WebSocket 地址是否正确
3. 查看防火墙设置，确保允许 WebSocket 连接
4. 尝试手动指定服务器地址：
   ```bash
   python gcms_worker.py -s ws://localhost:8000/ws/gcms/
   ```

## 📈 性能优化

### 1. 缓存管理

mzML 文件被缓存在系统临时目录中，可以手动清理以释放空间：

```bash
# Windows
del %TEMP%\*.mzML

# Linux/Mac
rm /tmp/*.mzML
```

### 2. 数据降采样

质谱数据超过 1000 个点时会自动进行降采样，可在 `ms_converter.py` 中调整：

```python
# 修改 prepare_mass_spectrum_data 方法中的 max_points 参数
max_points = 2000  # 增加此值以获得更高的分辨率
```

### 3. 并发处理

如果需要处理多个任务，可以启动多个 Worker 实例：

```bash
# 终端 1
python gcms_worker.py -s ws://localhost:8000/ws/gcms/

# 终端 2
python gcms_worker.py -s ws://localhost:8000/ws/gcms/
```

## 📝 日志查看

### Django 服务器日志

Django 服务器的日志会直接输出到控制台，查看关键信息：

```
[时间] "GET /admin/station-management/gcms/ HTTP/1.1" 200
[时间] WebSocket CONNECT /ws/gcms/
[时间] WebSocket RECEIVE /ws/gcms/
```

### Worker 日志

Worker 的日志也会输出到控制台，查看关键信息：

```
正在连接到 ws://192.168.58.8:8000/ws/gcms/
GCMS Worker 已连接到服务器
收到指令: get_result_0_0
开始转换: D:\MassHunter\GCMS\1\data\20241204\Test.D -> C:\Users\...\Temp\Test.mzML
转换成功: C:\Users\...\Temp\Test.mzML
```

## 🧪 测试

### 快速测试

```bash
# 测试 ms_converter 模块
python -c "
from station_workers.GCMS液相.ms_converter import GCMSDataProcessor
processor = GCMSDataProcessor()
print('✓ GCMSDataProcessor 初始化成功')
print(f'✓ msconvert 路径: {processor.converter.msconvert_path}')
"
```

### 完整测试流程

1. 创建一个测试任务
2. 运行任务
3. 查看色谱图（验证基础功能）
4. 加载质谱图（验证新功能）
5. 导出两个图表（验证导出功能）

## 📚 相关文档

- [详细功能说明](GCMS_质谱功能说明.md)
- [实现总结](实现总结.md)
- [ProteoWizard 文档](http://proteowizard.sourceforge.net/)
- [pymzml 文档](https://pymzml.readthedocs.io/)

## 🆘 获取帮助

如遇到问题，请按以下步骤排查：

1. **查看日志**：检查 Django 和 Worker 的日志输出
2. **验证配置**：确认 CSV 文件和数据路径配置正确
3. **检查依赖**：运行 `pip list` 确认所有依赖已安装
4. **测试连接**：确认 Django 和 Worker 能正常通信
5. **查阅文档**：参考详细的功能说明文档

## ✅ 检查清单

在开始使用前，请确认以下项目：

- [ ] ProteoWizard 已安装
- [ ] Python 依赖已安装（pymzml, websocket-client）
- [ ] CSV 配置文件已更新
- [ ] 数据文件夹路径正确
- [ ] Django 服务器可以启动
- [ ] Worker 可以连接到服务器
- [ ] 浏览器可以访问 http://localhost:8000

完成以上检查后，你就可以开始使用 GCMS 色谱图和质谱图功能了！

---

**提示**：如果是第一次使用，建议先阅读 [详细功能说明](GCMS_质谱功能说明.md) 了解系统架构和工作原理。

**最后更新**：2025-11-21

